RClient={create:function(a){function b(){if(!i.ocap_mode)return RCloud.UI.session_pane.post_error(ui_utils.disconnection_error("Expected an object-capability Rserve. Shutting Down!")),void c();var b=a.mode?a.mode:"client";i.ocap([g,h],b,function(b,c){b?d(b[0],b[1]):(c=Promise.promisifyAll(c),null===c?d("Login failed. Shutting down!"):RCloud.is_exception(c)?d(c):(f.running=!0,a.on_connect&&a.on_connect.call(f,c)))})}function c(){j||$("#input-div").hide(),i.closed||i.close()}function d(b,d){a.debug,a.on_error&&a.on_error(b,d)||(RCloud.UI.session_pane.post_error(ui_utils.disconnection_error(b)),c())}function e(b){if(a.debug,!j){var d=!rcloud.username();RCloud.UI.fatal_dialog("Your session has been logged out.",d?"Reload":"Reconnect",d?window.location.href:ui_utils.relogin_uri()),c()}}a=_.defaults(a,{debug:!1});var f,g=$.cookies.get().token,h=$.cookies.get().execToken,i=Rserve.create({host:a.host,on_connect:b,on_error:d,on_close:e,on_data:a.on_data,on_oob_message:a.on_oob_message}),j=!1;return f={_rserve:i,host:a.host,running:!1,post_response:function(a){var b=$("<pre class='response'></pre>").html(a);$("#output").append(b)},post_rejection:function(a){throw RCloud.UI.session_pane.post_error(a.message),a},close:function(){j=!0,c()}}}},RCloud={},RCloud.is_exception=function(a){return _.isObject(a)&&a.r_attributes&&"OCAP-eval-error"===a.r_attributes["class"]},RCloud.exception_message=function(a){if(!RCloud.is_exception(a))throw new Error("Not an R exception value");var b=a.traceback?a.traceback:"";return b.join&&(b=b.join("\n")),a.error+"R trace:\n"+b},RCloud.promisify_paths=function(){function a(a,b){function c(b){if(b&&RCloud.is_exception(b))throw new Error(a+": "+RCloud.exception_message(b));return b}return function(){return b.apply(this,arguments).then(c)}}function b(b,c,d){function e(a){for(var c=b,d=0;d<a.length;++d)c=c[a[d]];return c}function f(a,c){for(var d=b,e=0;e<a.length-1;++e)d=d[a[e]];d[a[a.length-1]+g]=c}var g=d?"":"Async";return _.each(c,function(b){var c=e(b);f(b,c?a(b.join("."),Promise.promisify(c)):null)}),b}return b}(),RCloud.create=function(rcloud_ocaps){function rcloud_github_handler(a,b){function c(b){if(b.ok)return b.content;var c;throw c=b.content&&b.content.message?b.content.message+" ("+b.code+")":"error code "+b.code,new Error(a+": "+c)}return b.then(c)}function setup_unauthenticated_ocaps(){var paths=[["version_info"],["anonymous_session_init"],["anonymous_compute_init"],["has_compute_separation"],["signal_to_compute"],["prefix_uuid"],["get_conf_value"],["get_conf_values"],["get_gist_sources"],["get_notebook"],["load_notebook"],["load_notebook_compute"],["call_notebook"],["install_notebook_stylesheets"],["get_version_by_tag"],["get_tag_by_version"],["get_users"],["log","record_cell_execution"],["setup_js_installer"],["replace_token"],["comments","get_all"],["help"],["debug","raise"],["stars","star_notebook"],["stars","unstar_notebook"],["stars","is_notebook_starred"],["stars","get_notebook_star_count"],["stars","get_notebook_starrer_list"],["stars","get_multiple_notebook_star_counts"],["stars","get_my_starred_notebooks"],["discovery","get_notebooks"],["discovery","get_thumb"],["session_cell_eval"],["reset_session"],["set_device_pixel_ratio"],["api","enable_echo"],["api","disable_echo"],["api","enable_warnings"],["api","disable_warnings"],["api","set_url"],["api","get_url"],["notebook_by_name"],["get_notebook_info"],["get_multiple_notebook_infos"],["languages","get_list"],["plots","render"],["plots","get_formats"],["get_fork_count"],["get_multiple_fork_counts"]];RCloud.promisify_paths(rcloud_ocaps,paths),rcloud.get_fork_count=rcloud_ocaps.get_fork_countAsync,rcloud.get_multiple_fork_counts=rcloud_ocaps.get_multiple_fork_countsAsync,rcloud.username=function(){return $.cookies.get("user")},rcloud.github_token=function(){return $.cookies.get("token")},rcloud.version_info=function(){return rcloud_ocaps.version_infoAsync.apply(null,arguments)},rcloud.anonymous_session_init=function(){return rcloud_ocaps.anonymous_session_initAsync()},rcloud.anonymous_compute_init=function(){return rcloud_ocaps.anonymous_compute_initAsync()},rcloud.init_client_side_data=function(){var a=this;return Promise.all([rcloud_ocaps.prefix_uuidAsync(),rcloud_ocaps.has_compute_separationAsync()]).spread(function(b,c){a.deferred_knitr_uuid=b,a.has_compute_separation=c})},rcloud.signal_to_compute=function(a){return rcloud_ocaps.signal_to_computeAsync(a)},rcloud.get_conf_value=function(a,b){return rcloud_ocaps.get_conf_valueAsync(a,b)},rcloud.get_conf_values=function(a){return rcloud_ocaps.get_conf_valuesAsync(a)},rcloud.get_gist_sources=function(){return rcloud_ocaps.get_gist_sourcesAsync()},rcloud.get_notebook=function(a,b,c,d){return void 0===c&&(c=null),void 0===d&&(d=!1),rcloud_github_handler("rcloud.get.notebook "+a,rcloud_ocaps.get_notebookAsync(a,b,c,d))},rcloud.load_notebook=function(a,b){return Promise.all([rcloud_github_handler("rcloud.load.notebook.compute "+a,rcloud_ocaps.load_notebook_computeAsync(a,b)),rcloud_github_handler("rcloud.load.notebook "+a,rcloud_ocaps.load_notebookAsync(a,b))]).spread(function(a,b){return b})},rcloud.refresh_compute_notebook=function(a){return rcloud_github_handler("rcloud.load.notebook.compute (refresh) "+a,rcloud_ocaps.load_notebook_computeAsync(a,null,null,!1))},rcloud.get_version_by_tag=function(a,b){return rcloud_ocaps.get_version_by_tagAsync(a,b)},rcloud.get_tag_by_version=function(a,b){return rcloud_ocaps.get_tag_by_versionAsync(a,b)},rcloud.call_notebook=function(a,b){return rcloud_github_handler("rcloud.call.notebook "+a,rcloud_ocaps.call_notebookAsync(a,b))},rcloud.install_notebook_stylesheets=function(){return rcloud_ocaps.install_notebook_stylesheetsAsync()},rcloud.help=function(a){return rcloud_ocaps.helpAsync(a).then(function(b){b||RCloud.UI.help_frame.display_content("<h2>No help found for <em>"+a+"</em></h2>")})},rcloud.get_users=function(){return rcloud_ocaps.get_usersAsync()},rcloud.record_cell_execution=function(a){return rcloud_ocaps.log.record_cell_executionAsync(rcloud.username(),a)},rcloud.setup_js_installer=function(a){return rcloud_ocaps.setup_js_installerAsync(a)},rcloud.modules={},rcloud.setup_js_installer({install_js:function(name,content,k){try{var result=eval(content);rcloud.modules[name]=result,k(null,result)}catch(e){Promise.reject(e);var v={type:e.name,message:e.message};k(v,null)}},clear_css:function(a,b){$(".rcloud-user-defined-css").remove(),b(null,null)},install_css:function(a,b){_.isString(a)?a=[a]:_.isArray(a)||(a=[]),_.each(a,function(a){$("head").append($('<link type="text/css" rel="stylesheet" class="rcloud-user-defined-css" href="'+a+'"/>'))}),b(null,null)}}),rcloud.replace_token=function(a,b){return rcloud_ocaps.replace_tokenAsync(a,b)},rcloud.get_all_comments=function(a){return rcloud_ocaps.comments.get_allAsync(a)},rcloud.debug={},rcloud.debug.raise=function(a){return rcloud_ocaps.debug.raiseAsync(a)},rcloud.stars={},rcloud.stars.is_notebook_starred=function(a){return rcloud_ocaps.stars.is_notebook_starredAsync(a)},rcloud.stars.get_notebook_star_count=function(a){return rcloud_ocaps.stars.get_notebook_star_countAsync(a)},rcloud.stars.get_notebook_starrer_list=function(a){return rcloud_ocaps.stars.get_notebook_starrer_listAsync(a)},rcloud.stars.get_multiple_notebook_star_counts=function(a){return rcloud_ocaps.stars.get_multiple_notebook_star_countsAsync(a)},rcloud.discovery={get_notebooks:rcloud_ocaps.discovery.get_notebooksAsync,get_thumb:rcloud_ocaps.discovery.get_thumbAsync},rcloud.session_cell_eval=function(a,b,c,d,e){return rcloud_ocaps.session_cell_evalAsync(a,b,c,d,e)},rcloud.reset_session=function(){return rcloud_ocaps.reset_sessionAsync()},rcloud.display={};var cached_device_pixel_ratio;rcloud.display.set_device_pixel_ratio=function(){return cached_device_pixel_ratio=window.devicePixelRatio,rcloud_ocaps.set_device_pixel_ratioAsync(window.devicePixelRatio)},rcloud.display.get_device_pixel_ratio=function(){return cached_device_pixel_ratio},rcloud.get_notebook_by_name=function(a,b){return rcloud_ocaps.notebook_by_nameAsync(a,b)},rcloud.get_notebook_info=rcloud_ocaps.get_notebook_infoAsync,rcloud.get_multiple_notebook_infos=rcloud_ocaps.get_multiple_notebook_infosAsync,rcloud.api={},rcloud.api.disable_warnings=function(){return rcloud_ocaps.api.disable_warningsAsync()},rcloud.api.enable_warnings=function(){return rcloud_ocaps.api.enable_warningsAsync()},rcloud.api.disable_echo=function(){return rcloud_ocaps.api.disable_echoAsync()},rcloud.api.enable_echo=function(){return rcloud_ocaps.api.enable_echoAsync()},rcloud.api.set_url=function(a){return rcloud_ocaps.api.set_urlAsync(a)},rcloud.api.get_url=function(){return rcloud_ocaps.api.get_urlAsync()},rcloud.languages={},rcloud.languages.get_list=function(){return rcloud_ocaps.languages.get_listAsync()},rcloud.plots={},rcloud.plots.render=function(a,b,c){return rcloud_ocaps.plots.renderAsync(a,b,c)},rcloud.plots.get_formats=function(){return rcloud_ocaps.plots.get_formatsAsync()}}function setup_authenticated_ocaps(){var a=[["session_init"],["compute_init"],["search"],["update_notebook"],["create_notebook"],["fork_notebook"],["port_notebooks"],["purl_source"],["get_completions"],["rename_notebook"],["authenticated_cell_eval"],["session_markdown_eval"],["notebook_upload"],["tag_notebook_version"],["file_upload","upload_path"],["file_upload","create"],["file_upload","write"],["file_upload","close"],["comments","post"],["comments","modify"],["comments","delete"],["is_notebook_published"],["publish_notebook"],["unpublish_notebook"],["set_notebook_visibility"],["protection","get_notebook_cryptgroup"],["protection","set_notebook_cryptgroup"],["protection","get_cryptgroup_users"],["protection","get_user_cryptgroups"],["protection","create_cryptgroup"],["protection","set_cryptgroup_name"],["protection","add_cryptgroup_user"],["protection","remove_cryptgroup_user"],["protection","delete_cryptgroup"],["protection","has_notebook_protection"],["api","disable_warnings"],["api","enable_echo"],["api","disable_warnings"],["api","enable_echo"],["config","all_notebooks"],["config","all_user_notebooks"],["config","all_notebooks_multiple_users"],["config","get_all_notebook_info"],["config","add_notebook"],["config","remove_notebook"],["config","get_current_notebook"],["config","set_current_notebook"],["config","new_notebook_number"],["config","get_recent_notebooks"],["config","set_recent_notebook"],["config","clear_recent_notebook"],["config","get_user_option"],["config","set_user_option"],["config","get_alluser_option"],["set_notebook_info"],["get_notebook_property"],["set_notebook_property"],["remove_notebook_property"]];RCloud.promisify_paths(rcloud_ocaps,a),rcloud.session_init=function(a,b){return rcloud_ocaps.session_initAsync(a,b)},rcloud.compute_init=function(a,b){return rcloud_ocaps.compute_initAsync(a,b)},rcloud.update_notebook=function(a,b,c){return void 0===c&&(c=!0),rcloud_github_handler("rcloud.update.notebook",rcloud_ocaps.update_notebookAsync(a,b,c))},rcloud.search=rcloud_ocaps.searchAsync,rcloud.create_notebook=function(a,b){return void 0===b&&(b=!0),rcloud_github_handler("rcloud.create.notebook",rcloud_ocaps.create_notebookAsync(a,b)).then(function(a){return b&&rcloud_ocaps.load_notebook_computeAsync(a.id),a})},rcloud.fork_notebook=function(a){return rcloud_github_handler("rcloud.fork.notebook",rcloud_ocaps.fork_notebookAsync(a))},rcloud.port_notebooks=function(a,b,c){return rcloud_ocaps.port_notebooksAsync(a,b,c)},rcloud.purl_source=function(a){return rcloud_ocaps.purl_sourceAsync(a)},rcloud.get_completions=function(a,b,c){return rcloud_ocaps.get_completionsAsync(a,b,c).then(function(a){return _.isString(a)&&(a=[a]),_.map(a,function(a){return{meta:"local",name:"library",score:3,value:a}})})},rcloud.rename_notebook=function(a,b){return rcloud_github_handler("rcloud.rename.notebook",rcloud_ocaps.rename_notebookAsync(a,b))},rcloud.authenticated_cell_eval=function(a,b,c,d,e){return rcloud_ocaps.authenticated_cell_evalAsync(a,b,c,d,e)},rcloud.notebook_upload=function(a,b){return rcloud_github_handler("rcloud.upload.to.notebook",rcloud_ocaps.notebook_uploadAsync(a,b))},rcloud.tag_notebook_version=function(a,b,c){return rcloud_ocaps.tag_notebook_versionAsync(a,b,c)},rcloud.post_comment=function(a,b){return rcloud_github_handler("rcloud.post.comment",rcloud_ocaps.comments.postAsync(a,b))},rcloud.modify_comment=function(a,b,c){return rcloud_ocaps.comments.modifyAsync(a,b,c)},rcloud.delete_comment=function(a,b){return rcloud_ocaps.comments.deleteAsync(a,b)},rcloud.is_notebook_published=function(a){return rcloud_ocaps.is_notebook_publishedAsync(a)},rcloud.publish_notebook=function(a){return rcloud_ocaps.publish_notebookAsync(a)},rcloud.unpublish_notebook=function(a){return rcloud_ocaps.unpublish_notebookAsync(a)},rcloud.set_notebook_visibility=function(a,b){return rcloud_ocaps.set_notebook_visibilityAsync(a,b)},rcloud.protection={},rcloud.protection.get_notebook_cryptgroup=function(a){return rcloud_ocaps.protection.get_notebook_cryptgroupAsync(a)},rcloud.protection.set_notebook_cryptgroup=function(a,b,c){return void 0===c&&(c=!0),rcloud_ocaps.protection.set_notebook_cryptgroupAsync(a,b,c)},rcloud.protection.get_cryptgroup_users=function(a){return rcloud_ocaps.protection.get_cryptgroup_usersAsync(a)},rcloud.protection.get_user_cryptgroups=function(a){return rcloud_ocaps.protection.get_user_cryptgroupsAsync(a)},rcloud.protection.create_cryptgroup=function(a){return rcloud_ocaps.protection.create_cryptgroupAsync(a)},rcloud.protection.set_cryptgroup_name=function(a,b){return rcloud_ocaps.protection.set_cryptgroup_nameAsync(a,b)},rcloud.protection.add_cryptgroup_user=function(a,b,c){return rcloud_ocaps.protection.add_cryptgroup_userAsync(a,b,c)},rcloud.protection.remove_cryptgroup_user=function(a,b){return rcloud_ocaps.protection.remove_cryptgroup_userAsync(a,b)},rcloud.protection.delete_cryptgroup=function(a){return rcloud_ocaps.protection.delete_cryptgroupAsync(a)},rcloud.protection.has_notebook_protection=function(){return rcloud_ocaps.protection.has_notebook_protectionAsync()},rcloud.stars.star_notebook=function(a){return rcloud_ocaps.stars.star_notebookAsync(a)},rcloud.stars.unstar_notebook=function(a){return rcloud_ocaps.stars.unstar_notebookAsync(a)},rcloud.stars.get_my_starred_notebooks=function(){return rcloud_ocaps.stars.get_my_starred_notebooksAsync()},rcloud.config={all_notebooks:rcloud_ocaps.config.all_notebooksAsync,all_user_notebooks:rcloud_ocaps.config.all_user_notebooksAsync,all_notebooks_multiple_users:rcloud_ocaps.config.all_notebooks_multiple_usersAsync,get_all_notebook_info:rcloud_ocaps.config.get_all_notebook_infoAsync,add_notebook:rcloud_ocaps.config.add_notebookAsync,remove_notebook:rcloud_ocaps.config.remove_notebookAsync,get_current_notebook:rcloud_ocaps.config.get_current_notebookAsync,set_current_notebook:rcloud_ocaps.config.set_current_notebookAsync,new_notebook_number:rcloud_ocaps.config.new_notebook_numberAsync,get_recent_notebooks:rcloud_ocaps.config.get_recent_notebooksAsync,set_recent_notebook:rcloud_ocaps.config.set_recent_notebookAsync,clear_recent_notebook:rcloud_ocaps.config.clear_recent_notebookAsync,get_user_option:rcloud_ocaps.config.get_user_optionAsync,set_user_option:rcloud_ocaps.config.set_user_optionAsync,get_alluser_option:rcloud_ocaps.config.get_alluser_optionAsync},rcloud.set_notebook_info=function(a,b){return b.username?b.description?b.last_commit?rcloud_ocaps.set_notebook_infoAsync(a,b):Promise.reject(new Error("attempt to set info no last_commit")):Promise.reject(new Error("attempt to set info no description")):Promise.reject(new Error("attempt to set info no username"))},rcloud.get_notebook_property=rcloud_ocaps.get_notebook_propertyAsync,rcloud.set_notebook_property=rcloud_ocaps.set_notebook_propertyAsync,rcloud.remove_notebook_property=rcloud_ocaps.remove_notebook_propertyAsync}var rcloud={};return rcloud._ocaps=rcloud_ocaps,rcloud.authenticated=rcloud_ocaps.authenticated,setup_unauthenticated_ocaps(),rcloud.authenticated&&setup_authenticated_ocaps(),rcloud};var ui_utils={};ui_utils.make_url=function(a,b){b=b||{};var c=window.location.protocol+"//"+window.location.host+"/"+a;return b.do_path?b.notebook&&(c+="/"+b.notebook,b.version&&(c+="/"+b.version)):b.notebook?(c+="?notebook="+b.notebook,b.source&&(c+="&source="+b.source),b.tag?c+="&tag="+b.tag:b.version&&(c+="&version="+b.version)):b.new_notebook&&(c+="?new_notebook=true"),c},ui_utils.relogin_uri=function(){return window.location.protocol+"//"+window.location.host+"/login.R?redirect="+encodeURIComponent(window.location.pathname+window.location.search)},ui_utils.disconnection_error=function(a,b){var c=$("<div class='alert alert-danger'></div>");c.append($("<span></span>").text(a)),b=b||"Reconnect";var d=$("<button type='button' class='close'>"+b+"</button>");return c.append(d),d.click(function(){window.location=ui_utils.relogin_uri()}),c},ui_utils.string_error=function(a){var b=$("<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>"),c=$("<div class='alert alert-danger alert-dismissable'></div>");c.append(b);var d=_.map(a.split("\n"),function(a){var b,c=$("<div></div>").text(a);if(b=a.match(/^( {4})+/)){var d=b[0].length/4;c.css("left",d+"em"),c.css("position","relative")}return c});return c.append(d),c},ui_utils.fa_button=function(a,b,c,d,e){var f=$.el.i({"class":a}),g=$.el.span({"class":"fontawesome-button "+(c||"")},f);if(d)for(var h in d)f.style[h]=d[h];var i={title:b,delay:{show:250,hide:0}};return e||(i.container="body"),$(g).tooltip(i)},ui_utils.enable_fa_button=function(a){a.removeClass("button-disabled")},ui_utils.disable_fa_button=function(a){a.addClass("button-disabled")},ui_utils.enable_bs_button=function(a){a.removeClass("disabled")},ui_utils.disable_bs_button=function(a){a.addClass("disabled")},ui_utils.ace_editor_height=function(a,b,c){b=_.isUndefined(b)?0:b,c=_.isUndefined(c)?30:c;var d=a.renderer.lineHeight,e=Math.max(b,a.getSession().getScreenLength()),f=d*e+a.renderer.scrollBar.getWidth();return f},ui_utils.ace_get_last=function(a){var b=a.getSession(),c=b.getLength()-1,d=b.getLine(c).length;return{row:c,column:d}},ui_utils.ace_set_pos=function(a,b,c){var d=a.getSelection(),e=d.getRange();e.setStart(b,c),e.setEnd(b,c),d.setSelectionRange(e)},ui_utils.install_common_ace_key_bindings=function(a,b){var c=ace.require("ace/autocomplete").Autocomplete,d=a.getSession(),e=a.commands.commandKeyBinding[0].tab;a.commands.removeCommand("gotoline"),a.commands.addCommands([{name:"another autocomplete key",bindKey:"Ctrl-.",exec:c.startCommand.exec},{name:"the autocomplete key people want",bindKey:"Tab",exec:function(a,b,d){var f=a.getSelection().getRange(),g=a.getSession().getLine(f.start.row),h=g.substring(0,f.start.column);h.match(/\S/)?c.startCommand.exec(a,b,d):e.exec(a,b,d)}},{name:"execute-selection-or-line",bindKey:{win:"Ctrl-Return",mac:"Command-Return",sender:"editor"},exec:function(a,c,e){if(!a.getOption("readOnly")){var f=d.getTextRange(a.getSelectionRange());if(0===f.length){var g=a.getCursorPosition(),h=ace.require("ace/range").Range,i=new h(g.row,0,g.row+1,0);f=d.getTextRange(i),a.navigateDown(1),a.navigateLineEnd()}RCloud.UI.command_prompt.history().add_entry(f),shell.new_cell(f,b()).spread(function(a,b){b.enqueue_execution_snapshot(),shell.scroll_to_end()})}}},{name:"cursor at beginning of line",ctrlACount:0,lastRow:-1,bindKey:{mac:"Ctrl-A",sender:"editor"},exec:function(a,b,c){if(!a.getOption("readOnly")){var d=a.getCursorPosition().row;this.lastRow!==d?(this.ctrlACount=1,a.navigateLineStart(),this.lastRow=d):(0===this.ctrlACount?(a.navigateLineStart(),this.ctrlACount++):1===this.ctrlACount&&(a.navigateTo(d,0),this.ctrlACount=0),this.lastRow=d)}}},{name:"cursor at end of line",bindKey:{mac:"Ctrl-E",sender:"editor"},exec:function(a,b,c){var d=a.getCursorPosition().row,e=ui_utils.last_col(a,d);a.navigateTo(d,e)}}])},ui_utils.last_col=function(a,b){var c=a.getSession().getDocument();return c.getLine(b).length},ui_utils.character_offset_of_pos=function(a,b){var c=a.getSession(),d=c.getDocument(),e=d.getNewLineCharacter().length,f=d.getAllLines();if(b.row>f.length)throw new Error("getting position off end of editor");var g,h=0;for(g=0;g<b.row;g++)h+=f[g].length+e;return h+=b.column},ui_utils.position_of_character_offset=function(a,b){var c,d=a.getSession(),e=d.getDocument(),f=e.getNewLineCharacter().length,g=e.getAllLines();for(c=0;c<g.length&&!(b<=g[c].length);c++)b-=g[c].length+f;if(c===g.length)throw new Error("character offset off end of editor");return{row:c,column:b}},ui_utils.ace_range_of_character_range=function(a,b,c){var d=ace.require("ace/range").Range,e=ui_utils.position_of_character_offset(a,b),f=ui_utils.position_of_character_offset(a,c);return new d(e.row,e.column,f.row,f.column)},ui_utils.ignore_programmatic_changes=function(a,b){var c=!0;return a.on("change",function(){c&&b(a.getValue())}),function(b){c=!1;var d=a.getValue(),e=b!==d?a.setValue(b):null;return c=!0,e}},ui_utils.set_ace_readonly=function(a,b){a.setOptions({readOnly:b,highlightActiveLine:!b,highlightGutterLine:!b}),a.renderer.$cursorLayer.element.style.opacity=b?0:1,a.textInput.getElement().disabled=b},ui_utils.twostate_icon=function(a,b,c,d,e){function f(b){a[0].checked=b;var c=a.find("i");b?(c.removeClass(e),c.addClass(d)):(c.removeClass(d),c.addClass(e))}function g(){var a=!this.checked;f(a),a?b():c()}function h(b){a.off("click"),b&&a.click(g)}return h(!0),{set_state:f,enable:h}},ui_utils.checkbox_menu_item=function(a,b,c){var d=ui_utils.twostate_icon(a,b,c,"icon-check","icon-check-empty"),e=d.enable;return d.enable=function(b){a.parent().toggleClass("disabled",!b),e(b)},d},ui_utils.customize_ace_gutter=function(a,b){var c=ace.require("ace/lib/dom");a.renderer.$gutterLayer.update=function(a){for(var d=[],e=a.firstRow,f=a.lastRow,g=this.session.getNextFoldLine(e),h=(g?g.start.row:1/0,this.$showFoldWidgets&&this.session.foldWidgets,this.session.$breakpoints,this.session.$decorations,this.session.$firstLineNumber,0);f>=e;++e){var i=b(e);d.push("<div class='ace_gutter-cell ","' style='height:",this.session.getRowLength(0)*a.lineHeight,"px;'>",i,"</div>"),h=Math.max(h,i.length)}this.element=c.setInnerHtml(this.element,d.join("")),this.element.style.height=a.minHeight+"px";var j=h*a.characterWidth,k=this.$padding||this.$computePadding();j+=k.left+k.right,j===this.gutterWidth||isNaN(j)||(this.gutterWidth=j,this.element.style.width=Math.ceil(this.gutterWidth)+"px",this._emit("changeGutterWidth",j))}},ui_utils.editable=function(a,b){function c(a){var b=window.getSelection();b.removeAllRanges(),b.addRange(a)}function d(b){var d=document.createRange(),e=a.get(0).firstChild;d.setStart(e,b),d.setEnd(e,b),c(d)}function e(){return window.getSelection().getRangeAt(0)}function f(){return a.data("__editable")}function g(a){return b.allow_multiline&&(a=a.replace(/\n/g,"<br/>")),a.replace(/  /g," Â ")}function h(a){return b.allow_multiline&&(a=a.replace(/<br>/g,"\n")),a.replace(/\xa0/g," ")}function i(b,c){b?a.html(c):a.text(c)}var j=f(),k=j;if(_.isObject(b)){var l;l=j?$.extend({},j):{on_change:function(){return!0},allow_edit:!0,inactive_text:a.text(),active_text:a.text(),allow_multiline:!1,select:function(a){var b=document.createRange();return b.selectNodeContents(a),b}},k=$.extend(l,b),a.data("__editable",k)}else{if("destroy"!==b&&!j)throw new Error("expected already editable for command "+b);var m=function(a,b){j=$.extend({},j),k[a]=b};switch(b){case"destroy":a.data("__editable",null),k=null;break;case"option":if(!arguments[2])return j;if(!arguments[3])return j[arguments[2]];m(arguments[2],arguments[3]);break;case"disable":m("allow_edit",!1);break;case"enable":m("allow_edit",!0)}}var n=null;switch(j&&j.allow_edit||!k||!k.allow_edit?!j||!j.allow_edit||k&&k.allow_edit||(n="freeze"):n="melt",k&&i(b.allow_multiline,g(f().__active?k.active_text:k.inactive_text)),n){case"freeze":a.removeAttr("contenteditable"),a.off("keydown.editable"),a.off("focus.editable"),a.off("click.editable"),a.off("blur.editable");break;case"melt":a.attr("contenteditable","true"),a.on({"focus.editable":function(){f().__active||(f().__active=!0,i(b.allow_multiline,g(f().active_text)),window.setTimeout(function(){c(f().select(a[0])),a.off("blur.editable"),a.on("blur.editable",function(){i(b.allow_multiline,g(f().inactive_text)),f().__active=!1})},10))},"click.editable":function(a){a.stopPropagation()},"keydown.editable":function(c){function g(b){return f().validate(i)?(f().__active=!1,a.off("blur.editable"),a.blur(),b(i,i!=f().active_text),!0):!1}if(c.keyCode===$.ui.keyCode.ENTER){var i=h(a.text());if(f().ctrl_cmd&&(c.ctrlKey||c.metaKey))return c.preventDefault(),g(f().ctrl_cmd);if(!b.allow_multiline||c.ctrlKey||c.metaKey)return c.preventDefault(),g(f().change)}else if(c.keyCode===$.ui.keyCode.ESCAPE)a.blur(),window.getSelection().removeAllRanges();else if(c.keyCode===$.ui.keyCode.HOME)d(0);else if(c.keyCode===$.ui.keyCode.END)d(h(a.text()).length);else if(c.keyCode===$.ui.keyCode.RIGHT)if(c.ctrlKey||c.altKey){var j=a.text().substring(e().startOffset);(0==(j.match(/ /g)||[]).length||1==(j.match(/ /g)||[]).length&&" "==j[0]||0===e().startOffset&&e().endOffset===a.text().length)&&(c.preventDefault(),d(h(a.text()).length))}else(e().startOffset===h(a.text()).length-1||0===e().startOffset&&e().endOffset===a.text().length)&&d(h(a.text()).length);return!0},"input.editable":function(b){0===a.text().length?a.css("padding-right","1px"):a.css("padding-right","")}})}return a},ui_utils.fake_hover=function(a){var b=a.parent,c="none"!==$(".notebook-commands.appear",a.element).css("display")?b.children.indexOf(a):void 0;ui_utils.on_next_tick(function(){if(c>=0&&c<b.children.length){var a=b.children[c];$(a.element).mouseover()}})},ui_utils.on_next_tick=function(a){window.setTimeout(a,0)},ui_utils.scroll_to_after=function(a,b){if(0!==a.length){var c;void 0!==b&&(c={animation:{duration:b}});var d=a.parent(),e=d.scrollTop()+a.position().top+a.outerHeight();d.scrollTo(null,e,c)}},ui_utils.scroll_into_view=function(a,b,c,d){if(arguments.length<5)return void console.warn("scroll_into_view needs offset elements");for(var e=+a.css("height").replace("px",""),f=a.scrollTop(),g=0,h=d?{animation:{complete:d}}:{},i=4;i<arguments.length;++i)g+=arguments[i].position().top;g>e?a.scrollTo(null,f+g-e+b,h):0>g?a.scrollTo(null,f+g-c,h):d&&d()},ui_utils.prevent_backspace=function(a){a.unbind("keydown").bind("keydown",function(a){var b=!1;if(a.keyCode===$.ui.keyCode.BACKSPACE){var c=a.srcElement||a.target;b="INPUT"===c.tagName.toUpperCase()&&("TEXT"===c.type.toUpperCase()||"PASSWORD"===c.type.toUpperCase()||"FILE"===c.type.toUpperCase()||"EMAIL"===c.type.toUpperCase())||"TEXTAREA"===c.tagName.toUpperCase()||c.isContentEditable?c.readOnly||c.disabled:!0}b&&a.preventDefault()})},ui_utils.is_a_mac=function(){var a=navigator.platform.toUpperCase();return function(){var b=-1!==a.indexOf("MAC");return b}}(),ui_utils.is_ie=function(){var a=window.navigator.userAgent;return a.indexOf("MSIE ")>0||a.indexOf("Trident/")>0||a.indexOf("Edge/")>0},ui_utils.kill_popovers=function(){window.allPopovers&&($(window.allPopovers).each(function(a,b){$(this).popover("destroy")}),window.allPopovers.length=0)},ui_utils.hide_selectize_dropdown=function(){$(".selectize-dropdown").hide(),$(".selectize-input").removeClass("focus input-active dropdown-active")},ui_utils.select_allowed_elements=function(a){var b=window.getSelection(),c=$('<pre class="offscreen"></pre>');$("body").append(c);for(var d=0;d<b.rangeCount;++d){var e=b.getRangeAt(d);c.append(e.cloneContents())}c.find(".nonselectable").remove(),c.is(":empty")?b.removeAllRanges():b.selectAllChildren(c[0]),window.setTimeout(function(){c.remove()},1e3)},RCloud.utils={},RCloud.utils.promise_for=function(a,b,c){return a(c)?b(c).then(RCloud.utils.promise_for.bind(null,a,b)):c},RCloud.utils.promise_sequence=function(a,b){return RCloud.utils.promise_for(function(b){return b<a.length},function(c){return b(a[c])["return"](++c)},0)},RCloud.utils.get_url_parameter=function(a){return decodeURIComponent((new RegExp("[?|&]"+a+"=([^&;]+?)(&|#|;|$)").exec(location.search)||[,""])[1].replace(/\+/g,"%20"))||null},RCloud.utils.get_notebook_from_url=function(a){var b=a.match(new RegExp("[?&]notebook=([^&#]*)"));return b&&b[1]},RCloud.extension=function(){return{filter_field:function(a,b){return function(c){return c[a]===b}},create:function(a){function b(){for(f in d)d[f].entries=_.filter(c,function(a){return a.disable?!1:d[f].filter?d[f].filter(a):!0}),d[f].entries.sort(function(a,b){return a.sort-b.sort})}a=a||{};var c={},d={},e=a.defaults?a.defaults:{};if(a.sections)for(var f in a.sections)d[f]={filter:a.sections[f].filter};else d.all={};return{add:function(a){for(var d in a)c[d]=_.extend(_.extend({key:d},e),a[d]);return b(),this},remove:function(a){return delete c[a],b(),this},disable:function(a,d){return c[a]&&(c[a].disable=d,b()),this},get:function(a){return c[a]},entries:function(a){return d[a].entries},create:function(a,b){var c={},d=[],e=Array.prototype.slice.call(arguments,1),f=this.entries(a);return f&&f.forEach(function(a){d.push(c[a.key]=a.create.apply(a,e))}),{map:c,array:d}},sections:d}}}}();var bootstrap_utils={};bootstrap_utils.alert=function(a){a=_.defaults(a||{},{close_button:!0,on_close:function(){}});var b=$('<div class="alert"></div>');return a.html&&b.html(a.html),a.text&&b.text(a.text),a["class"]&&b.addClass(a["class"]),a.close_button&&b.prepend($('<button type="button" class="close" data-dismiss="alert">&times;</button>').click(a.on_close)),b},bootstrap_utils.button=function(a){a=a||{};var b=$('<a class="btn" href="#"></a>');return b.text(a.text),a["class"]&&b.addClass(a["class"]),b},Notebook={},Notebook.Buffer={},Notebook.Cell={},Notebook.Asset={},Notebook.Buffer.create_model=function(a,b){function c(a){return Notebook.empty_for_github(a)}var d="",e={views:[],parent_model:null,renew_content:function(){d=""},content:function(b){return _.isUndefined(b)?a:a!==b?(a=b,this.notify_views(function(a){a.content_updated()}),a):null},language:function(a){if(!_.isUndefined(a))return b!==a?(b=a,this.notify_views(function(a){a.language_updated()}),b):null;if(void 0===b)throw new Error("tried to read no language");return null===b?"Text":b},change_object:function(b){if(b.content)throw new Error("content must come from the object");if(!b.filename)throw new Error("change object must have filename");var e={filename:b.filename};return b.erase?e.erase=!c(d):b.rename?c(a)?c(d)||(e.erase=!0):(c(d)?e.filename=b.rename:e.rename=b.rename,e.content=a):c(a)?c(d)||(e.erase=!0):(a!=d&&(e.content=a),c(d)&&(e.create=!0)),d=a,e},asset_url:function(a){var b=this.parent_model.controller.current_gist(),c=[window.location.protocol+"//"+window.location.host,"notebook.R",b.id];return a&&c.push(b.history[0].version),c.push(this.filename()),c.join("/")},notify_views:function(a){_.each(this.views,function(b){a(b)})}};return e},Notebook.Asset.create_html_view=function(a){function b(a){if(1!==a.childNodes.length||a.firstChild.nodeType!=a.TEXT_NODE)throw new Error("expecting simple element with child text");var b=a.firstChild.textContent,c=document.createRange();return c.setStart(a.firstChild,0),c.setEnd(a.firstChild,b.lastIndexOf(".")>0?b.lastIndexOf("."):b.length),c}function c(a){return"thumb.png"===a}var d=$("<li></li>"),e=$("<div></div>"),f=$("<span style='cursor:pointer'>"+a.filename()+"</span>"),g=ui_utils.fa_button("icon-remove","remove","",{position:"relative",left:"2px",opacity:"0.75"},!0),h=$('<i class="icon-camera" style="padding-left: 4px; cursor: help;" title="Shown as your notebook\'s thumbnail on the Discover page"></i>');e.append(f),d.append(e),c(a.filename())&&e.append(h),e.append(g);var i=f.text(),j=function(b){shell.notebook.controller.save().then(function(){var b=f.text().trim();b=b.replace(/\s/g," ");var d=a.content();return Notebook.is_part_name(b)?(alert("Asset names cannot start with 'part[0-9]', sorry!"),void f.text(i)):void(i===b?f.text(i):shell.notebook.model.get_asset(b)?(alert('An asset with the name "'+b+'" already exists. Please choose a different name.'),
f.text(i)):shell.notebook.controller.append_asset(d,b).spread(function(d,e){e.select(),a.controller.remove(!0),!c(i)&&c(b)?h.insertBefore(g):c(i)&&!c(b)&&h.remove()}))})},k={change:j,select:b,validate:function(a){return editor.validate_name(a)}};e.click(function(){a.active()||a.controller.select()}),g.click(function(){a.controller.remove()});var l={filename_updated:function(){e.text(a.filename())},content_updated:function(){a.active()&&RCloud.UI.scratchpad.content_updated()},language_updated:function(){a.active()&&RCloud.UI.scratchpad.language_updated()},active_updated:function(){a.active()?(shell.notebook.model.read_only()||ui_utils.editable(f,$.extend({allow_edit:!0,inactive_text:f.text(),active_text:f.text()},k)),d.addClass("active")):(ui_utils.editable(f,"destroy"),d.removeClass("active"))},self_removed:function(){d.remove()},set_readonly:function(a){a?g.hide():g.show()},div:function(){return d}};return l},Notebook.Asset.create_model=function(a,b){var c,d=!1,e=Notebook.Buffer.create_model(a),f=e.change_object;return _.extend(e,{active:function(a){return _.isUndefined(a)?d:d!==a?(d=a,this.notify_views(function(a){a.active_updated()}),d):null},cursor_position:function(a){return _.isUndefined(a)||(c=a),c},filename:function(a){return _.isUndefined(a)?b:b!=a?(b=a,this.notify_views(function(a){a.filename_updated()}),b):null},json:function(){return{content:a,filename:this.filename(),language:this.language()}},change_object:function(a){return a=a||{},a.filename=a.filename||this.filename(),f.call(this,a)}}),e},Notebook.Asset.create_controller=function(a){var b={select:function(){RCloud.UI.scratchpad.current_model&&RCloud.UI.scratchpad.current_model.controller.deselect(),a.active(!0),RCloud.UI.scratchpad.set_model(a)},deselect:function(){a.active(!1)},remove:function(b){var c=a.filename(),d="Do you want to remove the asset '"+c+"' from the notebook?";if((b||confirm(d))&&(a.parent_model.controller.remove_asset(a),a===RCloud.UI.scratchpad.current_model)){var e=a.parent_model.assets;e.length?e[0].controller.select():RCloud.UI.scratchpad.set_model(null)}}};return b},function(){function a(a,e){function f(){return y?e.content(y.getValue()):null}function g(){X.attr("id",Notebook.part_name(e.id(),e.language())),K&&K.controls.cell_number.set(e.id())}function h(a){da.css("height",a?a:ui_utils.ace_editor_height(x,b)+c+"px")}function i(b){var c=RCloud.language.is_a_markdown(a);b.toggleClass(c?"edit-markdown":"edit-code",!0),b.toggleClass(c?"edit-code":"edit-markdown",!1)}function j(){if(a=e.language(),RCloud.language.is_a_markdown(a)||W.hide_source&&W.hide_source(!1),J&&J.controls.language_cell.set(a),i(B.find("pre")),x){ea.toggleClass("active",!0),i(ea);var b=ace.require(RCloud.language.ace_mode(a)).Mode;y.setMode(new b(!1,z,y))}}function k(){e.is_selected()?X.addClass("selected"):X.removeClass("selected"),X.find('.cell-control input[type="checkbox"]').prop("checked",e.is_selected())}function l(a,b){b?(i(B.find("pre")),U===!1&&a.toggleClass("inactive",!0),a.on({"mousedown.rcloud-cell":function(a){$(this).data("p0",{x:a.pageX,y:a.pageY})},"mouseup.rcloud-cell":function(b){var c=$(this).data("p0");if(c){var d={x:b.pageX,y:b.pageY},e=Math.sqrt(Math.pow(d.x-c.x,2)+Math.pow(d.y-c.y,2));4>e&&(U?W.hide_source(!1):W.edit_source(!0,b),a.mouseleave())}}})):a.off("mousedown.rcloud-cell mouseup.rcloud-cell")}function m(){C.empty(),D=!1,J&&v(!1)}function n(a,b){ace.require("ace/ext/language_tools");var c=ace.edit(a[0]),d=c.getSession();c.setValue(b),ui_utils.ace_set_pos(c,0,0),ui_utils.on_next_tick(function(){d.getUndoManager().reset()});var e=d.getDocument();return c.gotoPageUp=function(){c.renderer.layerConfig.height=$("#rcloud-cellarea").height(),c.$moveByPage(-1,!1)},c.gotoPageDown=function(){c.renderer.layerConfig.height=$("#rcloud-cellarea").height(),c.$moveByPage(1,!1)},c.setAutoScrollEditorIntoView=function(a){if(a){var b,d=c,e=!1;c.$scrollAnchor||(c.$scrollAnchor=window.document.createElement("div"));var f=c.$scrollAnchor;f.style.cssText="position:absolute;",$("#rcloud-cellarea").prepend(f);var g=c.on("changeSelection",function(){e=!0}),h=c.renderer.on("beforeRender",function(){e&&(b=d.renderer.container.getBoundingClientRect())}),i=c.renderer.on("afterRender",function(){if(e&&b&&d.isFocused()){var a=d.renderer,c=a.$cursorLayer.$pixelPos,f=a.layerConfig,g=c.top-f.offset;if(e=c.top>=0&&g+b.top<$("#rcloud-cellarea").offset().top?!0:c.top<f.height&&c.top+b.top+f.lineHeight>window.innerHeight?!1:null,null!=e){var h=$(a.$cursorLayer.element).closest(".outer-ace-div"),i=h.offset().top+$("#rcloud-cellarea").scrollTop()-$("#rcloud-cellarea").offset().top;i+=c.top,e?$("#rcloud-cellarea").scrollTop(i):$("#rcloud-cellarea").scrollTop(i-$("#rcloud-cellarea").height()+f.lineHeight)}e=b=null}});c.setAutoScrollEditorIntoView=function(a){a||(delete c.setAutoScrollEditorIntoView,c.removeEventListener("changeSelection",g),c.renderer.removeEventListener("afterRender",i),c.renderer.removeEventListener("beforeRender",h))}}},c.setOptions({enableBasicAutocompletion:!0,autoScrollEditorIntoView:!0}),c.setTheme("ace/theme/chrome"),d.setUseWrapMode(!0),{widget:c,session:d,document:e}}function o(){var a;switch(N){case"waiting":case"unknown":a="unknown";break;case"running":case"unknown-running":a="unknown-running";break;default:a="ready"}W.state_changed(a)}function p(){if(!x){var b=n(ea,e.content());x=b.widget,y=b.session,z=b.document,y.on("change",function(){h(),x.resize()}),x.resize(),x.commands.removeCommand("findnext"),x.commands.removeCommand("findprevious"),ui_utils.install_common_ace_key_bindings(x,function(){return a});var c=x.commands.commandKeyBinding[0].left,d=x.commands.commandKeyBinding[0].right,f=x.commands.commandKeyBinding[0].up,g=x.commands.commandKeyBinding[0].down;x.commands.addCommands([{name:"executeCell",bindKey:{win:"Alt-Return",mac:"Alt-Return",sender:"editor"},exec:function(){W.execute_cell()}},{name:"executeCellsFromHere",bindKey:{win:"Shift-Alt-Return",mac:"Shift-Alt-Return",sender:"editor"},exec:function(){shell.run_notebook_from(e.id())}},{name:"left",bindKey:{win:"left",mac:"left"},exec:function(a,b,d){var f=x.getCursorPosition(),g=!0;if(0===f.row&&0===f.column){var h=e.parent_model.prior_cell(e);if(h){h.set_focus();var i=h.views[0].ace_widget(),j=ui_utils.ace_get_last(i);i.gotoLine(j.row+1,j.column),g=!1}}g&&c.exec(a,b,d)}},{name:"right",bindKey:{win:"right",mac:"right"},exec:function(a,b,c){var f=x.getCursorPosition(),g=!0,h=ui_utils.ace_get_last(x);if(f.column===h.column&&f.row==h.row){g=!1;var i=e.parent_model.subsequent_cell(e);i&&(i.set_focus(),i.views[0].ace_widget().gotoLine(0,0))}g&&d.exec(a,b,c)}},{name:"up",bindKey:{win:"up",mac:"up"},exec:function(a,b,c){var d=x.getCursorPosition(),g=!0;if(0===d.row){var h=e.parent_model.prior_cell(e);if(h){h.set_focus();var i=h.views[0].ace_widget(),j=ui_utils.ace_get_last(i);i.gotoLine(j.row+1,d.column),g=!1}}g&&f.exec(a,b,c)}},{name:"down",bindKey:{win:"down",mac:"down"},exec:function(a,b,c){var d=!0,f=x.getCursorPosition(),d=!0,h=ui_utils.ace_get_last(x);if(f.row==h.row){d=!1;var i=e.parent_model.subsequent_cell(e);i&&(i.set_focus(),i.views[0].ace_widget().gotoLine(1,f.column))}d&&g.exec(a,b,c)}},{name:"navigateToPreviousCell",bindKey:{win:"Ctrl-Shift-,",mac:"Ctrl-Shift-,",sender:"editor"},exec:function(){var a=e.parent_model.prior_cell(e);a&&a.set_focus()}},{name:"navigateToNextCell",bindKey:{win:"Ctrl-Shift-.",mac:"Ctrl-Shift-.",sender:"editor"},exec:function(){var a=e.parent_model.subsequent_cell(e);a&&a.set_focus()}},{name:"insertCellBefore",bindKey:{win:"Ctrl-[",mac:"Cmd-[",sender:"editor"},exec:function(){shell.insert_cell_before("",e.language(),e.id()).spread(function(a,b){b.edit_source(!0)})}},{name:"insertCellAfter",bindKey:{win:"Ctrl-]",mac:"Cmd-]",sender:"editor"},exec:function(){shell.insert_cell_after("",e.language(),e.id()).spread(function(a,b){b.edit_source(!0)})}},{name:"blurCell",bindKey:{win:"Escape",mac:"Escape",sender:"editor"},exec:function(){x.blur()}},{name:"executeAll",bindKey:{win:"Ctrl-Shift-Enter",mac:"Ctrl-Shift-Enter",sender:"editor"},exec:function(){RCloud.UI.run_button.run()}}]),x.commands.removeCommands(["find","replace"]),G=ui_utils.ignore_programmatic_changes(x,function(){o(),e.parent_model.on_dirty()}),j()}}function q(){if(!R){var a=n(Q,"");R=a.widget,ui_utils.customize_ace_gutter(R,function(a){return 0===a?O:""}),R.commands.addCommands([{name:"enter",bindKey:"Return",exec:function(a,b,c){var d=a.getValue();W.add_result("code",_.unescape(O)+d+"\n"),S&&S(null,d),P.hide(),window.clearInterval(T),T=null}}]),RCloud.UI.prevent_progress_modal()}}function r(a){return a.find("pre code").filter(function(a,b){return b.classList.length>0})}function s(){r(B).each(function(a,b){hljs.highlightBlock(b)})}function t(a){return"find-highlight "+a}function u(a){J&&J.controls.edit.control.find("i").toggleClass("icon-border",a)}function v(a){J&&J.controls.results.control.find("i").toggleClass("icon-border",a)}function w(a){a=a||e.content(),a=V.reduce(function(a,b){return b(a)},a),B.empty();var b=$("<code></code>").append(a),c=$('<div class="rcloud-gutter"></div>'),d=RCloud.language.hljs_class(e.language());d&&b.addClass(d),B.append(c,$("<pre></pre>").append(b)),s(),B.find(".rcloud-line-number .hljs-number").css("color","black"),"unknown"!==U&&l(B.find("pre"),!0),i(B.find("pre"))}var x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U="unknown",V=[],W={},X=$("<div class='notebook-cell'></div>");X.data("rcloud.model",e),H=$("<div class='cell-status nonselectable'></div>");var Y=$("<div class='cell-status-left'></div>");if(H.append(Y),K=RCloud.UI.cell_commands.decorate("left",Y,e,W),!shell.is_view_mode()){var Z=$("<div class='cell-control-bar'></div>");H.append(Z),Z.mousedown(function(a){a.stopPropagation()}),J=RCloud.UI.cell_commands.decorate("cell",Z,e,W);var aa=$("<div class='cell-controls-above nonselectable'></div>");I=RCloud.UI.cell_commands.decorate("above",aa,e,W),X.append(aa),H.click(function(a){var b=$(this).closest(".notebook-cell").data("rcloud.model");(a.ctrlKey||a.metaKey||a.shiftKey)&&a.preventDefault(),b.parent_model.controller.select_cell(b,{is_toggle:ui_utils.is_a_mac()&&a.metaKey||!ui_utils.is_a_mac()&&a.ctrlKey,is_range:a.shiftKey,is_exclusive:!a.ctrlKey&&!a.shiftKey}),$(":focus").blur()}).children().click(function(a){var b=$(a.target);b.hasClass("cell-number")||a.stopPropagation()})}X.append(H);var ba=$("<div></div>"),ca=$("<div style='clear:both;'></div>");X.append(ba),X.append(ca),A=$('<div class="source-div"></div>'),B=$('<div class="code-div"></div>'),A.append(B);var da=$('<div class="outer-ace-div"></div>'),ea=$('<div style="width:100%; height:100%;"></div>');i(ea),g(),da.append(ea),A.append(da),ba.append(A);var fa=_.debounce(function(){Notebook.Cell.postprocessors.entries("all").forEach(function(a){a.process(C,W)})},100);return V.push(function(a){var b=_.escape,c=0,d=[];return M&&M.forEach(function(e){d.push(b(a.substring(c,e.begin))),d.push('<span class="',t(e.kind),'">',b(a.substring(e.begin,e.end)),"</span>"),c=e.end}),d.push(b(a.substring(c))),d.join("")},function(a){var b=1;return a=a.split("\n").map(function(a){return['<span class="rcloud-line-number-position nonselectable">',"&#x200b;",'<span class="rcloud-line-number">',b++,"</span></span>",a].join("")}).join("\n"),a+="&nbsp;"},function(a){"\n"===a[a.length-1]&&(a+="\n");var c=(a.match(/\n/g)||[]).length;return b>c&&(a+=new Array(b+1-c).join("\n")),a}),w(),C=$('<div class="r-result-div"></div>'),m(),ba.append(C),P=$('<div class="input-div"></div>'),Q=$('<div style="height: 100%"></div>'),P.hide().append(Q),ba.append(P),j(),_.extend(W,{content_updated:function(){if(w(),x){var a=y.getScrollTop(),b=x.getSelection().getRange(),c=G(e.content());x.getSelection().setSelectionRange(b),y.setScrollTop(a)}return c},self_removed:function(){X.remove()},ace_widget:function(){return x},id_updated:g,language_updated:function(){j(),o()},selected_updated:function(){k()},state_changed:function(a){var b=K.controls.run_state;switch("unknown"===N&&"running"===a&&(a="unknown-running"),a){case"ready":b.icon("icon-circle-blank").color("#777").title("content has not been run");break;case"waiting":b.icon("icon-arrow-right").color("blue").title("cell is enqueued and waiting to run");break;case"cancelled":b.icon("icon-asterisk").color("#e06a06").title("execution was cancelled before this cell could run");break;case"unknown-running":b.icon("icon-question icon-spin").color("blue").title("cell is currently running"),D=!1;break;case"running":b.icon("icon-spinner icon-spin").color("blue").title("cell is currently running"),D=!1;break;case"complete":b.icon("icon-circle").color("#72B668").title("cell successfully ran");break;case"error":b.icon("icon-exclamation").color("crimson").title("cell ran but had an error");break;case"unknown":b.icon("icon-question").color("purple").title("output may or may not reflect current content")}return N=a,this},add_result:function(b,c){switch(D||(C.empty(),RCloud.language.is_a_markdown(a)&&W.hide_source(!0),D=!0),this.toggle_results(!0),b){case"selection":case"deferred_result":break;default:Notebook.Cell.preprocessors.entries("all").forEach(function(a){c=a.process(c)})}"code"!=b&&(E=null),"error"!=b&&(F=null);var d;switch(b){case"code":E||(d=$("<pre></pre>"),E=$("<code></code>"),d.append(E),C.append(d)),E.append(_.escape(c));break;case"error":F||(d=$("<pre></pre>"),F=$('<code style="color: crimson"></code>'),d.append(F),C.append(d)),F.append(_.escape(c));break;case"selection":case"html":C.append(c);break;case"deferred_result":C.append('<span class="deferred-result">'+c+"</span>");break;default:throw new Error("unknown result type "+b)}fa()},end_output:function(a){D||(C.empty(),D=!0),this.state_changed(a?"error":"unknown-running"===N?"ready":"complete"),E=F=null},clear_result:m,set_readonly:function(a){U=a,x&&ui_utils.set_ace_readonly(x,a),[J,I,K].forEach(function(b){b&&b.set_flag("modify",!a)}),l(B.find("pre"),!a),H.toggleClass("readonly",a),a&&u($(A).is(":visible"))},set_show_cell_numbers:function(a){K.set_flag("cell-numbers",a)},click_to_edit:l,execute_cell:function(){return e.parent_model.controller.save().then(function(){e.controller.enqueue_execution_snapshot()})},toggle_edit:function(){return this.edit_source(!L)},edit_source:function(b,c){if(b===L)return void(b&&x.focus());if(b){var g=d.scrollTop();J&&u(!0),RCloud.language.is_a_markdown(a)&&this.hide_source(!1);var i=B.height();if(B.hide(),p(),da.show(),x.resize(!0),h(i),x.resize(!0),J&&J.set_flag("edit",!0),da.show(),x.resize(),x.focus(),c){d.scrollTop(g);var j=x.getSession().getScrollTop(),k=x.renderer.pixelToScreenCoordinates(c.pageX,c.pageY-j),l=y.screenToDocumentPosition(Math.abs(k.row),Math.abs(k.column)),m=ace.require("ace/range").Range,n=Math.abs(l.row),o=Math.abs(l.column),q=new m(n,o,n,o);x.getSelection().setSelectionRange(q)}}else{J&&u(!1);var r=f();null!==r&&e.parent_model.controller.update_cell(e),A.css({height:""}),J&&J.set_flag("edit",!1),B.show(),da.hide()}L=b,this.change_highlights(M)},scroll_into_view:function(){var a=x.renderer,b=a.container.getBoundingClientRect(),c=a.$cursorLayer.$pixelPos,d=a.layerConfig,e=c.top-d.offset;if(c.top>=0&&e+b.top<$("#rcloud-cellarea").offset().top?shouldScroll=!0:c.top<d.height&&c.top+b.top+d.lineHeight>window.innerHeight?shouldScroll=!1:shouldScroll=null,null!=shouldScroll){var f=$(a.$cursorLayer.element).closest(".outer-ace-div"),g=f.offset().top+$("#rcloud-cellarea").scrollTop()-$("#rcloud-cellarea").offset().top;g+=c.top,shouldScroll?$("#rcloud-cellarea").scrollTop(g):$("#rcloud-cellarea").scrollTop(g-$("#rcloud-cellarea").height()+d.lineHeight)}},toggle_source:function(){this.hide_source($(A).is(":visible"))},hide_source:function(a){a?(A.hide(),u(!1)):(A.show(),u(!0))},toggle_results:function(a){void 0===a&&(a=C.is(":hidden")),J&&v(a),a?C.show():C.hide()},get_input:function(a,b,c){D||(C.empty(),D=!0),O=_.escape(b).replace(/\n/g,""),q(),R.setValue(""),P.show(),P.css("height","36px"),R.renderer.$gutterLayer.gutterWidth=0,R.renderer.$changes|=R.renderer.__proto__.CHANGE_FULL,R.resize(!0),R.focus(),P.css("border-color","#eeeeee");var d=!1,e=function(){P.animate({borderColor:d?"#ffac88":"#E34234"},{duration:1e3,easing:"easeInOutCubic",queue:!1}),d=!d};e(),T=window.setInterval(e,1e3),ui_utils.scroll_into_view($("#rcloud-cellarea"),100,100,null,X,P),S=c},div:function(){return X},update_model:function(){return f()},focus:function(){return x.focus(),this},get_content:function(){return e.content()},get_selection:function(){return this.ace_widget().getSession().doc.getTextRange(this.ace_widget().selection.getRange())},reformat:function(){return L&&(x.resize(),h(),x.resize()),this},check_buttons:function(){return I&&I.set_flag("first",!e.parent_model.prior_cell(e)),this},change_highlights:function(a){if(M=a,L){var b=y.getMarkers();for(var c in b)"rcloud-select"===b[c].type&&y.removeMarker(c);a&&a.forEach(function(a){var b=ui_utils.ace_range_of_character_range(x,a.begin,a.end);y.addMarker(b,t(a.kind),"rcloud-select"),/active/.test(a.kind)&&(x.scrollToLine(b.start.row),window.setTimeout(function(){var b=ea.find(".find-highlight."+a.kind);b.size()&&ui_utils.scroll_into_view($("#rcloud-cellarea"),100,100,null,X,ea,b)},0))})}else{w();var d=B.find(".find-highlight.active, .find-highlight.activereplaced");d.size()&&ui_utils.scroll_into_view($("#rcloud-cellarea"),100,100,null,X,B,d)}return this},select_highlight_range:function(a,b){this.edit_source(!0);var c=ui_utils.ace_range_of_character_range(x,a,b);x.getSelection().setSelectionRange(c)}}),W.edit_source(!1),W}var b=2,c=2,d=$("#rcloud-cellarea");Notebook.Cell.create_html_view=function(b){return a(b.language(),b)}}(),Notebook.Cell.create_model=function(a,b){var c=-1,d=!1,e=Notebook.Buffer.create_model(a,b),f=e.change_object;return _.extend(e,{id:function(a){return _.isUndefined(a)||a==c||(c=a,this.notify_views(function(a){a.id_updated()})),c},filename:function(){if(arguments.length)throw new Error("can't set filename of cell");return Notebook.part_name(this.id(),this.language())},get_execution_snapshot:function(){var a=this.language()||"Text",b=this.parent_model.controller.current_version();return b||RCloud.UI.session_pane.append_text("Warning: executing unknown version, may be stale\n"),{controller:this.controller,json_rep:this.json(),partname:Notebook.part_name(this.id(),a),language:a,version:b}},set_focus:function(){this.notify_views(function(a){a.edit_source(!0),a.scroll_into_view(!0)})},deselect_cell:function(){return d=!1,this.notify_views(function(a){a.selected_updated()}),d},select_cell:function(){return d=!0,this.notify_views(function(a){a.selected_updated()}),d},toggle_cell:function(){return d=!d,this.notify_views(function(a){a.selected_updated()}),d},is_selected:function(){return d},json:function(){return{content:a,language:this.language()}},change_object:function(a){if(a=a||{},a.id&&a.filename)throw new Error("must specify only id or filename");if(!a.filename){var b=a.id||this.id();if(b>0!=!0)throw new Error("bad id for cell change object: "+b);a.filename=Notebook.part_name(b,this.language())}return a.rename&&_.isNumber(a.rename)&&(a.rename=Notebook.part_name(a.rename,this.language())),f.call(this,a)}}),e},Notebook.Cell.create_controller=function(a){var b=null,c={enqueue_execution_snapshot:function(){function c(a){return d.append_result.bind(this,a)}var d=this;if(!b){var e=c("code");b={end:this.end_output.bind(this),out:e,err:c("error"),msg:e,html_out:c("html"),deferred_result:c("deferred_result"),selection_out:c("selection"),"in":this.get_input.bind(this,"in")}}var f=RCloud.register_output_context(b);d.set_run_state("waiting"),d.edit_source(!1);var g=a.get_execution_snapshot();RCloud.UI.run_button.enqueue(function(){return d.set_run_state("running"),a.parent_model.controller.execute_cell_version(f,g)},function(){d.set_run_state("cancelled")})},set_run_state:function(b){a.notify_views(function(a){a.state_changed(b)})},clear_result:function(){a.notify_views(function(a){a.clear_result()})},append_result:function(b,c){a.notify_views(function(a){a.add_result(b,c)})},end_output:function(b){a.notify_views(function(a){b&&b!==!0&&a.add_result("error",b),a.end_output(b)})},get_input:function(b,c,d){var e=_.find(a.views,function(a){return a.get_input});e?e.get_input(b,c,d):d("cell view does not support input",null)},edit_source:function(b){a.notify_views(function(a){a.edit_source(b)})},change_language:function(b){a.language(b)}};return c},Notebook.Cell.preprocessors=RCloud.extension.create(),Notebook.Cell.postprocessors=RCloud.extension.create(),Notebook.Cell.postprocessors.add({device_pixel_ratio:{sort:1e3,disable:!0,process:function(a){var b=rcloud.display.get_device_pixel_ratio();a.find("img").each(function(a,c){function d(){c.style.width=c.width/b}0===c.width?$(c).on("load",d):d()})}},deferred_results:{sort:2e3,process:function(a){rcloud.deferred_knitr_uuid;a.find("span.deferred-result").each(function(){var a=this,b=this.textContent.split("|"),c=[b[1]];c.r_attributes={"class":"OCref"};var d=rclient._rserve.wrap_ocap(c);d(function(b,c){var d;b?$(a).replaceWith(function(){return ui_utils.string_error(b[0])}):(d=c(),$(a).replaceWith(function(){return d}))})})}},mathjax:{sort:3e3,process:function(a){_.isUndefined(MathJax)||MathJax.Hub.Queue(["Typeset",MathJax.Hub])}},shade_pre_r:{sort:4e3,process:function(a){a.find("pre code").filter(function(a,b){return b.classList.length>0}).parent().toggleClass("r",!0)}},hide_source:{sort:5e3,process:function(a){shell.notebook.controller._r_source_visible||Notebook.hide_r_source(a)}},click_markdown_code:{sort:6e3,process:function(a,b){b.click_to_edit(a.find("pre.r"),!0)}}}),Notebook.Cell.preprocessors.add({quote_deferred_results:{sort:1e3,process:function(){function a(){b=rcloud.deferred_knitr_uuid,c=new RegExp(b+"\\|[\\+a-zA-Z_0-9.]*","g"),d='<span class="deferred-result">$&</span>'}var b,c,d;return function(e){!b!=rcloud.deferred_knitr_uuid&&a();var f=c.exec(e);if(f){for(var g=[],h=0;f;)g.push(e.substring(h,f.index)),g.push(d.replace("$&",e.substr(f.index,f[0].length).replace("+","@"))),h=f.index+f[0].length,f=c.exec(e);g.push(e.substring(h)),e=g.join("")}return e}}()}}),Notebook.create_html_view=function(a,b){function c(){_.each(f.sub_views,function(a){a.check_buttons()})}function d(b){b.set_readonly(a.read_only()||shell.is_view_mode()),b.set_show_cell_numbers(e)}var e,f={model:a,sub_views:[],asset_sub_views:[],cell_appended:function(a){var e=Notebook.Cell.create_html_view(a);return a.views.push(e),b.append(e.div()),this.sub_views.push(e),d(e),c(),e},asset_appended:function(a){var b=Notebook.Asset.create_html_view(a);return a.views.push(b),$("#asset-list").append(b.div()),this.asset_sub_views.push(b),c(),b},cell_inserted:function(a,e){var f=Notebook.Cell.create_html_view(a);return a.views.push(f),b.append(f.div()),$(f.div()).insertBefore(b.children(".notebook-cell")[e]),this.sub_views.splice(e,0,f),d(f),c(),f},cell_removed:function(a,b){_.each(a.views,function(a){a.self_removed()}),this.sub_views.splice(b,1),c()},asset_removed:function(a,b){_.each(a.views,function(a){a.self_removed()}),this.asset_sub_views.splice(b,1)},cell_moved:function(a,b,d){this.sub_views.splice(b,1),this.sub_views.splice(d,0,a.views[0]),c()},set_readonly:function(a){_.each(this.sub_views,function(b){b.set_readonly(a)}),_.each(this.asset_sub_views,function(b){b.set_readonly(a)})},set_show_cell_numbers:function(a){e=a,_.each(this.sub_views,function(b){b.set_show_cell_numbers(a)})},update_urls:function(){RCloud.UI.scratchpad.update_asset_url()},update_model:function(){return _.map(this.sub_views,function(a){return a.update_model()})},reformat:function(){_.each(this.sub_views,function(a){a.reformat()})}};return a.views.push(f),f},Notebook.create_model=function(){function a(a){return a.length?a[a.length-1].id():0}var b=!1,c="",d=void 0;return{cells:[],assets:[],views:[],dishers:[],execution_watchers:[],clear:function(){var b=this.remove_cell(null,a(this.cells)),c=this.remove_asset(null,this.assets.length);return RCloud.UI.selection_bar.update(this.cells),b.concat(c)},get_asset:function(a){return _.find(this.assets,function(b){return b.filename()==a})},append_asset:function(a,b,c){a.parent_model=this;var d=[];return d.push(a.change_object()),this.assets.push(a),c||_.each(this.views,function(b){b.asset_appended(a)}),d},cell_count:function(){return this.cells.length},selected_count:function(){return _.filter(this.cells,function(a){return a.is_selected()}).length},append_cell:function(b,c,d){b.parent_model=this,b.renew_content();var e=[],f=1;for(c=c||1,c=Math.max(c,a(this.cells)+1);f;)b.id(c),e.push(b.change_object()),this.cells.push(b),d||_.each(this.views,function(a){a.cell_appended(b)}),++c,--f;return RCloud.UI.selection_bar.update(this.cells),e},insert_cell:function(a,b,c){var d=this;a.parent_model=this,a.renew_content();for(var e=[],f=1,g=0;g<this.cells.length&&this.cells[g].id()<b;)++g;if(g<this.cells.length&&b+f>this.cells[g].id()){var h=g>0?this.cells[g-1].id():0;b=Math.max(this.cells[g].id()-f,h+1)}for(var i=0;f>i;++i)e.push(a.change_object({id:b+i})),a.id(b+i),this.cells.splice(g,0,a),c||_.each(this.views,function(a){a.cell_inserted(d.cells[g],g)}),++g;for(;g<this.cells.length&&f;){if(this.cells[g].id()>b){var j=this.cells[g].id()-b;f-=j,b+=j}if(0>=f)break;e.push(this.cells[g].change_object({rename:this.cells[g].id()+f})),this.cells[g].id(this.cells[g].id()+f),++g,++b}return RCloud.UI.selection_bar.update(this.cells),e.reverse()},remove_asset:function(a,b,c){if(0===this.assets.length)return[];var d,e,f=this;if(null!==a){if(d=this.assets.indexOf(a),e=a.filename(),-1===d)throw new Error("asset_model not in notebook model?!")}else d=0,e=this.assets[d].filename();b=b||1;for(var g=d,h=[];g<this.assets.length&&b;)this.assets[g].filename()==e&&(c||_.each(this.views,function(a){a.asset_removed(f.assets[g],g)}),h.push(f.assets[g].change_object({erase:1})),this.assets.splice(g,1)),g<this.assets.length&&(e=this.assets[g].filename()),--b;return h},remove_cell:function(a,b,c){var d,e;if(null!==a){if(d=this.cells.indexOf(a),e=a.id(),-1===d)throw new Error("cell_model not in notebook model?!")}else d=0,e=1;b=b||1;for(var f=d,g=[];f<this.cells.length&&b;){if(this.cells[f].id()==e){var h=this.cells[f];this.cells.splice(f,1),c||_.each(this.views,function(a){a.cell_removed(h,f)}),g.push(h.change_object({erase:1}))}++e,--b}return RCloud.UI.selection_bar.update(this.cells),g},remove_selected_cells:function(){var a=this,b=[];return _.chain(this.cells).filter(function(a){return a.is_selected()}).each(function(c){b=b.concat(a.remove_cell(c))}),RCloud.UI.selection_bar.update(this.cells),b},invert_selected_cells:function(){_.each(this.cells,function(a){a.toggle_cell()}),RCloud.UI.selection_bar.update(this.cells)},clear_all_selected_cells:function(){_.each(this.cells,function(a){a.deselect_cell()}),RCloud.UI.selection_bar.update(this.cells)},get_selected_cells:function(){return this.cells.filter(function(a){return a.is_selected()})},crop_cells:function(){var a=this,b=[];return _.chain(this.cells).filter(function(a){return!a.is_selected()}).each(function(c){b=b.concat(a.remove_cell(c))}),RCloud.UI.selection_bar.update(this.cells),b},can_crop_cells:function(){return this.selected_count()&&this.selected_count()!==this.cell_count()},select_all_cells:function(){_.each(this.cells,function(a){a.select_cell()}),RCloud.UI.selection_bar.update(this.cells)},move_cell:function(a,b){var c=this.cells.indexOf(a),e=this.remove_cell(a,1,!0).concat(b>=0?this.insert_cell(a,b,!0):this.append_cell(a,null,!0)),f=this.cells.indexOf(a);return d=f,_.each(this.views,function(b){b.cell_moved(a,c,f)}),e},prior_cell:function(a){var b=this.cells.indexOf(a);return b>0?this.cells[b-1]:null},subsequent_cell:function(a){var b=this.cells.indexOf(a);return b<this.cells.length-1?this.cells[b+1]:null},change_cell_language:function(a,b){var c=a.filename();return a.language(b),[a.change_object({filename:c,rename:a.filename()})]},select_cell:function(a,b){var c=this,e=function(){_.chain(c.cells).filter(function(a){return a.is_selected()}).each(function(a){a.deselect_cell()})},f=function(a,b){e();for(var d=a;b>=d;d++)c.cells[d].select_cell()};if(b.is_toggle)a.toggle_cell(),d=this.cells.indexOf(a);else if(b.is_exclusive)e(),a.toggle_cell(),d=this.cells.indexOf(a);else{var g=this.cells.indexOf(a),h=d;f(Math.min(g,h),Math.max(g,h))}RCloud.UI.selection_bar.update(this.cells)},update_cell:function(a){return[a.change_object()]},update_asset:function(a){return[a.change_object()]},reread_buffers:function(){var a=_.map(this.views,function(a){return a.update_model()});if(1!=a.length)throw new Error("not expecting more than one notebook view");for(var b=a[0],c=[],d=0;d<b.length;++d)null!==b[d]&&c.push(this.cells[d].change_object());var e=RCloud.UI.scratchpad.update_model();if(null!==e){var f=RCloud.UI.scratchpad.current_model;c.push(f.change_object())}return c},read_only:function(a){return _.isUndefined(a)||(b=a,_.each(this.views,function(a){a.set_readonly(b)})),b},user:function(a){return _.isUndefined(a)||(c=a),c},update_files:function(a){for(var b=0;b<this.assets.length;++b){var c=a[this.assets[b].filename()];c&&this.assets[b].language(c.language)}_.each(this.views,function(a){a.update_urls()})},on_dirty:function(){_.each(this.dishers,function(a){a.on_dirty()})},json:function(){return _.map(this.cells,function(a){return a.json()})}}},Notebook.create_controller=function(a){function b(b,c,d){var e=Notebook.Cell.create_model(b,c),f=Notebook.Cell.create_controller(e);return e.controller=f,{controller:f,changes:a.append_cell(e,d)}}function c(b,c){var d=Notebook.Asset.create_model(b,c),e=Notebook.Asset.create_controller(d);return d.controller=e,{controller:e,changes:a.append_asset(d,c),model:d}}function d(b,c,d){var e=Notebook.Cell.create_model(b,c),f=Notebook.Cell.create_controller(e);return e.controller=f,{controller:f,changes:a.insert_cell(e,d)}}function e(d,e){var f=editor.get_notebook_info(e.id),g=f&&f.source||null!==d||e.user.login!==rcloud.username()||shell.is_view_mode();if(k=e,l=e.history[0].version,a.read_only(g),!_.isUndefined(e.files)){var h;e.description||(e.description="(untitled)"),this.clear();var i={},j={};_.each(e.files,function(a,b){if("r_attributes"!==b&&"r_type"!==b){var c=a.filename;if(Notebook.is_part_name(c)){var d=parseInt(c.slice(4).split(".")[0]);isNaN(d)||(i[d]=[a.content,a.language,d])}else j[c]=[a.content,a.filename]}});var m;for(h in i)b(i[h][0],i[h][1],i[h][2]);for(h in j){var n=c(j[h][0],j[h][1]).controller;m=m||n}a.user(e.user.login),a.update_files(e.files),m?m.select():RCloud.UI.scratchpad.set_model(null),a.read_only(g)}return e}function f(a,b){function c(a){return a.name=function(a){return a},a}var d=[],e=a.files,f=_.extend({},b?b.files:k.files);for(var g in e)"r_type"!==g&&"r_attributes"!==g&&(g in f?(f[g].language==e[g].language&&f[g].content==e[g].content||d.push(c({filename:g,language:f[g].language,content:f[g].content})),delete f[g]):d.push(c({filename:g,erase:!0,language:e[g].language})));for(g in f)"r_type"!==g&&"r_attributes"!==g&&d.push(c({filename:g,language:f[g].language,content:f[g].content}));return d}function g(b,c,d){function e(a){return _.isUndefined(d)?a:_.extend(_.clone(a),d)}function f(a){var b={},c={};return _.each(a,function(a){a.erase||a.rename?(c[a.filename]?delete b[a.filename]:b[a.filename]=null,a.rename&&(b[a.rename]={content:a.content})):(!a.create||a.filename in b||(c[a.filename]=!0),b[a.filename]={content:a.content})}),{files:b}}if(b=b.filter(function(a){return a.content||a.erase||a.rename}),a.read_only())return Promise.reject(new Error("attempted to update read-only notebook"));if(!b.length&&_.isUndefined(d))return Promise.cast(k);l=null,c=c||shell.gistname();var g=e(f(b));return rcloud.update_notebook(c,g).then(function(b){if("error"in b)throw b;return k=b,l=b.history[0].version,a.update_files(b.files),b})["catch"](function(a){throw/non-existent/.test(a.message)&&editor.fatal_reload(a.message),a})}function h(a,b){return(a.length?g(a,b):Promise.resolve(void 0)).then(function(){return p.load_notebook(b,null)})}function i(){
return a.reread_buffers()}function j(){if(!m){var a=RCloud.UI.navbar.control("save_notebook");a&&a.enable(),m=!0}n&&window.clearTimeout(n);var b=shell.autosave_timeout();b>0&&(n=window.setTimeout(function(){p.save(),n=null},b))}var k,l,m=!1,n=null,o=function(){var a=null;return function(){if(!a){var b=editor.load_callback({is_change:!0,selroot:!0});a=function(a){var c=RCloud.UI.navbar.control("save_notebook");return c&&c.disable(),m=!1,n&&(window.clearTimeout(n),n=null),rcloud.refresh_compute_notebook(a.id),b(a)}}return a}}();a.dishers.push({on_dirty:j});var p={current_gist:function(){return k},current_version:function(){return l},append_asset:function(a,b){var d=c(a,b);return g(i().concat(d.changes)).then(o()).then(function(a){return d.model.content(a.files[b].content),[a,d.controller]})},cell_count:function(){return a.cell_count()},selected_count:function(){return a.selected_count()},append_cell:function(a,c,d){var e=b(a,c,d);return g(i().concat(e.changes)).then(o()).then(function(a){return[a,e.controller]})},insert_cell:function(a,b,c){var e=d(a,b,c);return g(i().concat(e.changes)).then(o()).then(function(a){return[a,e.controller]})},remove_cell:function(b){var c=i().concat(a.remove_cell(b));return RCloud.UI.command_prompt.focus(),g(c).then(o())},remove_selected_cells:function(){var b=i().concat(a.remove_selected_cells());return RCloud.UI.command_prompt.focus(),g(b).then(o())},invert_selected_cells:function(){a.invert_selected_cells()},clear_all_selected_cells:function(){a.clear_all_selected_cells()},get_selected_cells:function(){return a.get_selected_cells()},crop_cells:function(){if(!this.can_crop_cells())return Promise.resolve(null);var b=i().concat(a.crop_cells());return RCloud.UI.command_prompt.focus(),g(b).then(o())},can_crop_cells:function(){return a.can_crop_cells()},select_all_cells:function(){a.select_all_cells()},remove_asset:function(b){var c=i().concat(a.remove_asset(b));return g(c).then(o())},move_cell:function(b,c){var d=i().concat(a.move_cell(b,c?c.id():-1));return g(d).then(o())},join_prior_cell:function(b){function c(a){return a.length&&"\n"!=a[a.length-1]?a+"\n":a}function d(a,b){var c=/```\n$/,d=/^```{r}/;return c.test(a)&&d.test(b)?a.replace(c,"")+b.replace(d,""):a+b}var e=a.prior_cell(b);if(!e)return Promise.resolve(void 0);var f,h=i();return e.language()==b.language()?(f=d(c(e.content()),b.content()),e.content(f),h=h.concat(a.update_cell(e))):"R"===e.language()?(f=d("```{r}\n"+c(e.content())+"```\n",b.content()),e.content(f),h=h.concat(a.change_cell_language(e,"Markdown")),h[h.length-1].content=f):(f=d(c(e.content())+"```{r}\n",c(b.content())+"```\n"),f=f.replace(/```\n```{r}\n/,""),e.content(f),h=h.concat(a.update_cell(e))),_.each(e.views,function(a){a.clear_result()}),g(h.concat(a.remove_cell(b))).then(o())},split_cell:function(b,c,e){function f(a){for(var b=0;b<a.length-1;++b)!/\n$/.test(a[b])&&/^\n/.test(a[b+1])&&(a[b]=a[b].concat("\n"),a[b+1]=a[b+1].replace(/^\n/,""))}var h=i(),j=b.content();if(c>=e&&(e=void 0),void 0!==e&&/^\s*$/.test(j.substring(e))&&(e=void 0),void 0!==c&&(/^\s*$/.test(j.substring(c))?c=void 0:/^\s*$/.test(j.substring(0,c))&&(c=e)),void 0===c)return Promise.resolve(void 0);var k=[j.substring(0,c)],l=b.id(),m=b.language();void 0===e?k.push(j.substring(c)):k.push(j.substring(c,e),j.substring(e)),f(k),b.content(k[0]),_.each(b.views,function(a){a.clear_result()}),h=h.concat(a.update_cell(b));for(var n=1;n<k.length;++n)h=h.concat(d(k[n],m,l+n).changes);return g(h).then(o())},change_cell_language:function(b,c){var d=i().concat(a.change_cell_language(b,c));return g(d).then(o())},select_cell:function(b,c){i().concat(a.select_cell(b,c))},clear:function(){a.clear(),RCloud.UI.scratchpad.clear()},load_notebook:function(a,b){return rcloud.load_notebook(a,b||null)["catch"](function(a){throw a.from_load=!0,a}).then(_.bind(e,this,b))},create_notebook:function(a){return rcloud.create_notebook(a).then(_.bind(e,this,null))},revert_notebook:function(b,c){return a.read_only(!1),rcloud.load_notebook(b,null).then(function(a){return[f(a),b]}).spread(h)},pull_and_replace_notebook:function(b){if(b.files["encrypted.notebook.content.bin.b64"])return Promise.reject(new Error("Can't pull from encrypted notebook"));a.read_only(!1);var c=f(k,b);return h(c,shell.gistname())},fork_notebook:function(b,c){return a.read_only(!1),rcloud.fork_notebook(b).then(function(a){return c?rcloud.get_notebook(a.id,null).then(function(a){return[f(a),a.id]}):[[],a.id]}).spread(h)},update_cell:function(b){return g(i().concat(a.update_cell(b))).then(o())},update_asset:function(b){return g(i().concat(a.update_asset(b))).then(function(a){return b.content(a.files[b.filename()].content),a}).then(o())},rename_notebook:function(a){return g(i(),null,{description:a}).then(o())},apply_changes:function(a){return g(a).then(o())},save:function(){return m?g(i()).then(o()):Promise.resolve(void 0)},execute_cell_version:function(b,c){function d(d){if(d&&d.r_attributes){if("parse-error"===d.r_attributes["class"])throw RCloud.end_cell_output(b,"Parse error: "+d.error),"stop";if("cell-eval-error"===d.r_attributes["class"]){var e=d.traceback||"";e.join&&(e=e.join("\n"));var f=e?"trace:\n"+e:!0;throw RCloud.end_cell_output(b,f),"stop"}RCloud.end_cell_output(b,null)}else RCloud.end_cell_output(b,null);_.each(a.execution_watchers,function(a){a.run_cell(c.json_rep)})}rcloud.record_cell_execution(c.json_rep);var e=rcloud.authenticated?rcloud.authenticated_cell_eval:rcloud.session_cell_eval;return e(b,c.partname,c.language,c.version,!1).then(d)},run_all:function(){return this.save().then(function(){_.each(a.cells,function(a){a.controller.enqueue_execution_snapshot()})})},run_from:function(b){var c=!1;return this.save().then(function(){_.each(a.cells,function(a){(c||a.id()===b)&&(c=!0,a.controller.enqueue_execution_snapshot())})})},show_cell_numbers:function(b){return _.each(a.views,function(a){a.set_show_cell_numbers(b)}),this},is_mine:function(){return rcloud.username()===a.user()},_r_source_visible:!0,hide_r_source:function(){this._r_source_visible=!1,RCloud.UI.advanced_menu.check("show_source",!1),Notebook.hide_r_source()},show_r_source:function(){this._r_source_visible=!0,RCloud.UI.advanced_menu.check("show_source",!0),Notebook.show_r_source()}};return a.controller=p,p},Notebook.hide_r_source=function(a){a=a?$(a).find(".r"):$(".r"),a.hide()},Notebook.show_r_source=function(a){a=a?$(a).find(".r"):$(".r"),a.show()},Notebook.is_binary_content=function(a){return!_.isUndefined(a.byteLength)&&!_.isUndefined(a.slice)},Notebook.read_from_file=function(a,b){var c,d=new FileReader;b=_.defaults(b,{on_load_end:$.noop,on_error:$.noop,on_notebook_parse_complete:$.noop}),d.onloadend=function(a){b.on_load_end();try{if(c=JSON.parse(d.result),!c.description)return void b.on_error("Invalid notebook format: has no description");if(!c.files||_.isEmpty(c.files))return void b.on_error("Invalid notebook format: has no files");c=Notebook.sanitize(c),b.on_notebook_parsed(c)}catch(e){b.on_error("Invalid notebook format: couldn't parse JSON")}},d.readAsText(a)},RCloud.discovery_model=function(){function a(a){return delete a.r_attributes,delete a.r_type,a}var b={};return{get_notebooks:function(c,d){var e;d=_.filter(d,function(a){return a.length&&"r"!==a[0]});var f=_.difference(d,Object.keys(b));return e=f.length?Promise.all([rcloud.get_multiple_notebook_infos(f),rcloud.stars.get_multiple_notebook_star_counts(f),c?Promise.resolve([]):rcloud.stars.get_my_starred_notebooks(),rcloud.get_multiple_fork_counts(f)]).spread(function(c,d,e,f){c=a(c),Object.keys(c).forEach(function(a){c[a].stars=d[a]||0,c[a].forks=f[a]||0}),_.extend(b,c),_.each(e,function(a){b[a]&&(b[a].is_starred_by_me=!0)})}):Promise.resolve(),e.then(function(){return _.pick(b,d)})}}}(),Notebook.part_name=function(a,b){if(_.isString(a))return a;var c=RCloud.language.extension(b);if(_.isUndefined(c))throw new Error("Unknown language "+b);return"part"+a+"."+c},Notebook.empty_for_github=function(a){return/^\s*$/.test(a)},Notebook.is_part_name=function(a){return a.match(/^part\d+\./)},Notebook.sanitize=function(a){a=_.pick(a,"description","files");var b=a.files;delete b.r_attributes,delete b.r_type;for(var c in b)b[c]=_.pick(b[c],"content");return a},Notebook.valid_gist_id=function(a){return null!==a.match(/^[a-f0-9]*$/i)&&-1!==[20,32].indexOf(a.length)},function(){function a(a,b){RCloud.UI.session_pane.append_text(b)}function b(b){var c=arguments[1],d=Array.prototype.slice.call(arguments,2),e=k[c];return console.log("forward_to_context, ctx="+c+", type="+b+", old.ctx="+e),e&&e[b]?(e[b].apply(e,d),!0):(a(c,d[0]),!1)}function c(a,c,d,e,f,g){if(console.log("handle_img ",a," device ",f," page ",g," url ",d),d){var h=RCloud.UI.image_manager.update(d,e,f,g);b("selection_out",c,h.div())}}function d(a,c){return function(){var d=b.apply(null,[a].concat(Array.prototype.slice.call(arguments,0)));!d&&c&&arguments[arguments.length-1]("context does not support input",null)}}function e(a){a=a.value.json(),console.log("OOB send arrived: ['"+a[0]+"']"+(m[a[0]]?"":" (unhandled)")),m[a[0]]&&m[a[0]].apply(null,a.slice(1))}function f(a,b){a=a.value.json(),console.log("OOB message arrived: ['"+a[0]+"']"+(n[a[0]]?"":" (unhandled)")),n[a[0]]?(a.push(b),n[a[0]].apply(null,a.slice(1))):b("unhandled",null)}function g(a){var b="Could not initialize session. The GitHub backend might be down or you might have an invalid authorization token. (You could try clearing your cookies, for example).";return a&&(b+="<br />Error: "+a.toString()),b}function h(a){var b,c;return rcloud=RCloud.create(a.rcloud),rcloud.authenticated?(b=rcloud.compute_init(rcloud.username(),rcloud.github_token()),c=rcloud.session_init(rcloud.username(),rcloud.github_token())):(b=rcloud.anonymous_compute_init(),c=rcloud.anonymous_session_init()),b["catch"](function(a){RCloud.UI.fatal_dialog(g(a),"Logout","/logout.R")}),c["catch"](function(a){RCloud.UI.fatal_dialog(g(a),"Logout","/logout.R")}),Promise.all([b,c])}function i(a){if(rcloud=RCloud.create(a.rcloud),!rcloud.authenticated)return Promise.reject(new Error("Authentication required"));var b=rcloud.compute_init(rcloud.username(),rcloud.github_token()),c=rcloud.session_init(rcloud.username(),rcloud.github_token());return Promise.all([b,c])}function j(a){return new Promise(function(b,c){rclient=RClient.create({debug:!1,mode:"IDE",host:location.href.replace(/^http/,"ws").replace(/#.*$/,""),on_connect:function(a){b(a)},on_data:e,on_oob_message:f,on_error:function(a){return c(a),!1}}),rclient.allow_anonymous_=a}).then(function(b){var c=a?h(b):i(b);return c}).then(function(a){$("#output > .response").length||rclient.post_response(a)})["catch"](function(a){if(window.rclient&&rclient.close(),"Authentication required"===a.message)RCloud.session.first_session_?window.location=ui_utils.relogin_uri():RCloud.UI.fatal_dialog("Your session has been logged out.","Reconnect",ui_utils.relogin_uri());else{var b=a.message||a.error||a;RCloud.UI.fatal_dialog(g(b),"Logout","/logout.R")}throw a}).then(function(){return Promise.all([rcloud.get_conf_value("exec.token.renewal.time").then(function(a){if(a){a=1e3*a;var b=function(){rcloud.replace_token($.cookies.get("execToken"),"rcloud.exec").then(function(c){$.cookies.set("execToken",c),setTimeout(b,a)})};setTimeout(b,a)}}),rcloud.display.set_device_pixel_ratio(),rcloud.api.set_url(window.location.href),rcloud.languages.get_list().then(function(a){RCloud.language._set_available_languages(_.omit(a,"r_type","r_attributes"))}),RCloud.UI.image_manager.load_available_formats(),rcloud.init_client_side_data()])})}var k={},l=17;RCloud.register_output_context=function(a){return k[l]=a,l++},RCloud.unregister_output_context=function(a){delete k[a]},RCloud.end_cell_output=function(a,c){b("end",a,c),RCloud.unregister_output_context(a)};var m={browsePath:function(a,b){var c=" "+window.location.protocol+"//"+window.location.host+b+" ";RCloud.UI.help_frame.display_href(c)},browseURL:function(a,b){window.open(b,"_blank")},pager:function(a,b,c,d){for(var e="<h2>"+d+"</h2>\n",f=0;f<b.length;++f)_.isArray(c)&&c[f]&&(e+="<h3>"+c[f]+"</h3>\n"),e+="<pre>"+b[f]+"</pre>";RCloud.UI.help_frame.display_content(e)},editor:function(b,c,d,e){a("editor","what: "+c+"\ncontents:"+d+"\nname: "+e+"\n")},"console.out":d("out"),"console.msg":d("msg"),"console.err":d("err"),"img.url.update":c.bind(null,"img.url.update"),"img.url.final":c.bind(null,"img.url.final"),stdout:a,stderr:a,"html.out":d("html_out"),"deferred.result":d("deferred_result"),compute_terminated:function(){RCloud.UI.fatal_dialog("Your compute session died. Reload the notebook and start a new session?","Reload",function(){editor.load_notebook(shell.gistname(),shell.version())})}},n={"console.in":d("in",!0)};RCloud.session={first_session_:!0,listeners:[],reset:function(){return this.first_session_?(this.first_session_=!1,RCloud.UI.with_progress(function(){})):(this.listeners.forEach(function(a){a.on_reset()}),RCloud.UI.with_progress(function(){var a=rclient.allow_anonymous_;return rclient.close(),j(a)}))},init:function(a){return this.first_session_=!0,j(a)},on_data:e,on_oob_message:f,invoke_context_callback:b}}(),RCloud.language=function(){var a={CSS:{ace_mode:"ace/mode/css"},JavaScript:{ace_mode:"ace/mode/javascript"},Text:{ace_mode:"ace/mode/text",extension:"txt"},HTML:{ace_mode:"ace/mode/html"}},b=[];return{is_a_markdown:function(b){return a[b]?a[b].is_a_markdown:!1},ace_mode:function(b){return a[b]&&a[b].ace_mode||a.Text.ace_mode},extension:function(b){var c=a[b]&&a[b].extension||"";return _.isArray(c)&&(c=c[0]),c},hljs_class:function(b){return a[b]&&a[b].hljs_class||null},_set_available_languages:function(c){b=[];for(var d in c)b.push(d),a[d]=a[d]||{},a[d].is_a_markdown=c[d]["is.a.markdown"],a[d].ace_mode=c[d]["ace.mode"],a[d].hljs_class=c[d]["hljs.class"],a[d].extension=c[d].extension},available_languages:function(){return b}}}(),function(){function a(a){if(_.isBoolean(a)||_.isUndefined(a))a={force:!!a};else if(!_.isObject(a))throw new Error("didn't understand options "+a);return a=$.extend({force:!1},a),a.files||(a.files=a.$file?a.$file[0].files:[]),a}function b(){return Promise.promisify(function(a,b){var c=new FileReader;c.onload=function(a){b(null,c.result)},c.onerror=function(a){b(c.error,null)},c.readAsArrayBuffer(a.slice(0,a.size))})}function c(a,b){return Promise.promisify(function(c,d,e){var f=new FileReader,g=131072,h=c.size,i=0,j=0;b.start&&b.start(c.name),f.readAsArrayBuffer(c.slice(i,i+g)),f.onload=function(k){b.progress&&b.progress(j,h);var l;if(k.target.result.byteLength>0){var m=new Uint8Array(k.target.result);l=a.writeAsync(m.buffer).then(function(){j+=k.target.result.byteLength,i+=g,f.readAsArrayBuffer(c.slice(i,i+g))})}else l=a.closeAsync().then(function(){b.done&&b.done(d,c.name),e(null,!0)});l["catch"](function(a){e(a,null)})}})}RCloud.upload_assets=function(c,d){function e(a,b){var c,e=shell.notebook.model.get_asset(a);return e?(d.replace&&d.replace(a),e.content(b),c=shell.notebook.controller.update_asset(e)["return"](e.controller)):(d.add&&d.add(a),c=shell.notebook.controller.append_asset(b,a).then(function(){return shell.notebook.model.get_asset(a).controller})),c.then(function(a){a.select()})}d=d||{},c=a(c);var f=!1,g={};if(c.filenames&&c.files.length===c.filenames.length){f=!0;for(var h=0;h<c.filenames.length;h++)g[c.files[h].name]=c.filenames[h]}return RCloud.utils.promise_sequence(c.files,function(a){return a.size>75e4?Promise.reject(new Error("File "+a.name+" rejected: maximum asset size is 750KB")):b()(a).then(function(b){if(_.isString(b)&&Notebook.empty_for_github(b))throw new Error("empty");return e(f?g[a.name]:a.name,b)})})},RCloud.upload_files=function(b,d){function e(a,c){var e=a+"/"+c.name;return f.createAsync(e,b.force)["catch"](function(a){if(d.confirm_replace&&/exists/.test(a.message))return d.confirm_replace(c.name).then(function(a){return a?f.createAsync(e,!0)["return"]("overwrite"):Promise.resolve(!1)});throw a}).then(function(a){return a?g(c,"overwrite"===a):Promise.resolve(void 0)})}var f=b.upload_ocaps||rcloud._ocaps.file_upload;d=d||{},b=a(b);var g=c(f,d);return window.File&&window.FileReader&&window.FileList&&window.Blob?_.isUndefined(b.files)||!b.files.length?Promise.reject(new Error("No files selected!")):f.upload_pathAsync().then(function(a){return RCloud.utils.promise_sequence(b.files,e.bind(null,a))}):Promise.reject(new Error("File API not supported by browser."))}}(),RCloud.UI={},RCloud.UI.advanced_menu=function(){var a,b={init:function(){a=RCloud.UI.menu.create(),a.init(),d3.rebind(b,a,"add","remove","check","uncheck","enable","create"),RCloud.UI.menus.add({advanced_menu:{sort:5e3,type:"menu",title:"Advanced",modes:["view","edit"],menu:a}}),a.add({open_in_github:{sort:1e3,text:"Open in GitHub",modes:["view","edit"],action:function(){shell.github_url().then(function(a){a?window.open(a,"_blank"):alert("Sorry, Open in GitHub is not supported for this notebook source.")})}},open_from_github:{sort:2e3,text:"Load Notebook by ID",modes:["edit"],action:function(){var a=prompt("Enter notebook ID or github URL:");null!==a&&shell.open_from_github(a)}},show_source:{sort:9e3,text:"Show Source",checkbox:!0,value:!0,modes:["view"],action:function(a){a?shell.notebook.controller.show_r_source():shell.notebook.controller.hide_r_source()}},publish_notebook:{sort:1e4,text:"Publish Notebook",checkbox:!0,modes:["edit"],disabled_reason:"You can't publish someone else's notebook",action:function(a){function b(a,b){return function(c){c||console.log("Failed to "+(b?"un":"")+"publish notebook "+a)}}a?rcloud.publish_notebook(editor.current().notebook).then(b(editor.current().notebook,!1)):rcloud.unpublish_notebook(editor.current().notebook).then(b(editor.current().notebook,!0))}}})}};return b}(),RCloud.UI.cell_commands=function(){function a(a,c,d,e){var f=b.create(a,d,e);f.array.forEach(function(a){a.control.addClass("cell-control")});var g={};return c.append.apply(c,_.pluck(f.array,"control")),{controls:f.map,set_flag:function(c,d){var e=function(a){var b;return"!"==a.substr(0,1)&&(b=!0,a=a.substr(1)),b^g[a]};g[c]=d,b.entries(a).forEach(function(a){_.every(a.enable_flags,e)?f.map[a.key].enable():f.map[a.key].disable(),_.every(a.display_flags,e)?f.map[a.key].control.show():f.map[a.key].control.hide()})}}}var b,c={create_button:function(a,b,c){var d=ui_utils.fa_button(a,b);return d.click(function(a){$(".tooltip").remove(),$(a.currentTarget).hasClass("button-disabled")||c(d,a)}),{control:d,enable:function(){ui_utils.enable_fa_button(d)},disable:function(){ui_utils.disable_fa_button(d)}}},create_select:function(a,b){var c=$("<select class='form-control cell-control-select'></select>");return c.append.apply(c,a.map(function(a){return $("<option></option>").text(a)})),c.change(function(){var a=c.val();b(a)}),{control:c,enable:function(){c.prop("disabled",!1)},disable:function(){c.prop("disabled","disabled")},set:function(b){if(a.indexOf(b)<0)throw new Error("tried to select unknown value "+b);c.val(b)}}},create_static:function(a,b,c){var d=$("<span><span/>").html(a),e=b?b(d):d;return c&&c(e),{control:e,enable:function(){},disable:function(){},set:function(a){return d.html(a),this},get:function(){return d}}},create_icon:function(a,b,c){var d=this.create_static("<i></i>");return d=_.extend(d,{icon:function(a){return d.get().find("i").attr("class",a),this},color:function(a){return d.get().find("i").css("color",a),this},title:function(a){return d.get().find("i").attr("title",a),this}}),d.get().attr("class","state-icon left-indicator"),d.icon(a).color(b),d},init:function(){b=RCloud.extension.create({defaults:{},sections:{above:{filter:RCloud.extension.filter_field("area","above")},cell:{filter:RCloud.extension.filter_field("area","cell")},prompt:{filter:RCloud.extension.filter_field("area","prompt")},left:{filter:RCloud.extension.filter_field("area","left")}}});var a=this;return this.add({insert:{area:"above",sort:1e3,enable_flags:["modify"],create:function(b){return a.create_button("icon-plus-sign","insert cell",function(){shell.insert_cell_before("",b.language(),b.id()).spread(function(a,b){b.edit_source(!0)})})}},join:{area:"above",sort:2e3,enable_flags:["modify"],display_flags:["!first"],create:function(b){return a.create_button("icon-link","join cells",function(){shell.join_prior_cell(b)})}},language_cell:{area:"cell",sort:1e3,enable_flags:["modify"],create:function(b,c){var d=RCloud.language.available_languages();return d.indexOf(b.language())<0&&d.push(b.language()),a.create_select(d,function(a){b.parent_model.controller.change_cell_language(b,a),c.clear_result(),c.edit_source(!0)})}},run:{area:"cell",sort:2e3,create:function(b,c){return a.create_button("icon-play","run",function(a,d){d.shiftKey?shell.run_notebook_from(b.id()):c.execute_cell()})}},edit:{area:"cell",sort:3e3,create:function(b,c){return a.create_button("icon-edit borderable","toggle edit mode",function(){b.parent_model.read_only()?c.toggle_source():c.toggle_edit()})}},results:{area:"cell",sort:3500,create:function(b,c){return a.create_button("icon-picture borderable","show/hide results",function(){c.toggle_results()})}},command_gap:{area:"cell",sort:3500,create:function(b){return a.create_static("&nbsp;")}},split:{area:"cell",sort:4e3,enable_flags:["modify","edit"],create:function(b,c){return a.create_button("icon-unlink","split cell",function(){var a=c.ace_widget();if(a){var d,e,f=a.getSelection().getRange();d=ui_utils.character_offset_of_pos(a,f.start),f.isEmpty()||(e=ui_utils.character_offset_of_pos(a,f.end)),shell.split_cell(b,d,e)}})}},remove:{area:"cell",sort:5e3,enable_flags:["modify"],create:function(b){return a.create_button("icon-trash","remove",function(){b.parent_model.controller.remove_cell(b)})}},selection:{area:"left",sort:1250,display_flags:["modify"],create:function(b){var c="<input type='checkbox'></input>";return a.create_static(c,function(a){return $("<span class='cell-selection'>").append(a)},function(a){a.click(function(a){b.parent_model.controller.select_cell(b,{is_toggle:!a.shiftKey,is_range:a.shiftKey})})})}},left_gap:{area:"left",sort:1500,display_flags:["!modify"],create:function(b){return a.create_static("&nbsp;")}},run_state:{area:"left",sort:2e3,create:function(b){return a.create_icon("icon-circle-blank","#777")}},cell_number:{area:"left",sort:3e3,display_flags:["cell-numbers"],create:function(b){return a.create_static(b.id(),function(a){return $("<span class='left-indicator cell-number'></span>").append("cell ",a)},function(a){})}}}),this},add:function(a){return b&&b.add(a),this},remove:function(a){return b&&b.remove(a),this},decorate:function(b,c,d,e){return a(b,c,d,e)}};return c}(),RCloud.UI.column=function(a){function b(a){return"col-md-"+a+" col-sm-"+a}var c,d={init:function(){var b=$(a);if(0!==b.length){var d=b.attr("class").split(/\s+/);d.forEach(function(a){var b=/^col-(?:md|sm)-(\d+)$/.exec(a);if(b)if(b=+b[1],void 0===c)c=b;else if(c!==b)throw new Error("mismatched col-md- or col-sm- in column classes")})}},colwidth:function(d){return _.isUndefined(d)||d==c||($(a).removeClass(b(c)).addClass(b(d)),c=d),c}};return d},RCloud.UI.collapsible_column=function(a,b,c){function d(){return $(b+" > .panel > div.panel-collapse:not(.out)")}function e(){return $(b+" > .panel > div.panel-heading")}function f(a,b,c){if(a.data("would-collapse")==b)return!1;if(a.data("would-collapse",b),c&&rcloud.config&&a.length){var d="ui/"+a[0].id;rcloud.config.set_user_option(d,b)}return!0}function g(){return $.makeArray(d()).every(function(a){return $(a).hasClass("out")||$(a).data("would-collapse")===!0})}function h(a){return a.replace("#","ui/")}function i(a){return a.replace("ui/","#")}function j(){$(b+" .panel-shadow").each(function(a){var b=$(this).parent().find(".panel-body").outerHeight();0===b&&(b="100%"),$(this).attr("height",b)})}var k=!1,l=RCloud.UI.column(a),m=l.init.bind(l),n=l.colwidth.bind(l);return $(b).data("collapsible-column",l),_.extend(l,{init:function(){var a=this;m(),d().each(function(){$(this).data("would-collapse",!$(this).hasClass("in")&&!$(this).hasClass("out"))}),e().click(function(){var b=$(this.dataset.target);return a.collapse(b,b.hasClass("in")),!1}),d().on("size-changed",function(){a.resize(!0)}),$(c).click(function(){k?a.show(!0):a.hide(!0)})},load_options:function(){var a=this,c=$.makeArray(d()).map(function(a){return"#"+a.id});c.push(b);var e=c.map(h);return rcloud.config.get_user_option(e).then(function(c){var d;for(var e in c){var g=i(e);g===b?d=c[e]:"boolean"==typeof c[e]&&f($(g),c[e],!1)}var h=!1;void 0===d&&(d=!1,h=!0),d?a.hide(h):a.show(h)})},colwidth:function(a){return a=n(a),d().trigger("panel-resize"),a},collapse:function(a,b,c){if(void 0===c&&(c=!0),k)return d().each(function(){this===a[0]?f($(this),!1,c):f($(this),!0,c)}),void this.show(!0);var e=f(a,b,c);g()?this.hide(c,!e):this.show(c,!e)},resize:function(c){if(!c){var e=this.calcwidth();this.colwidth(e)}RCloud.UI.middle_column.update();var f={},g={},h=d(),i=(h.length,null);h.each(function(){if(!$(this).hasClass("out")&&!$(this).data("would-collapse")){var a=$(this).data("panel-sizer"),b=a?a(this):RCloud.UI.collapsible_column.default_sizer(this);f[this.id]=b.height,g[this.id]=b.padding,i||"greedy"!==$(this).attr("data-widgetheight")||(i=$(this))}});var k=$(a).height(),l=d3.sum($(b+" .panel-heading").map(function(a,b){return $(b).outerHeight()}));k-=l;for(var m in g)k-=g[m];var n=k,o=!1;for(m in f)n-=f[m];if(n>=0)null!==i&&(f[i.get(0).id]+=n,o=!0);else{n=k;for(var p,q=_.keys(f),r=!1,s=n/q.length;q.length&&!r;){for(r=!0,p=0;p<q.length;++p)f[q[p]]<s&&(n-=f[q[p]],q.splice(p,1),--p,r=!1);s=n/q.length}for(p=0;p<q.length;++p)f[q[p]]=s;o=!0}for(m in f)$("#"+m).find(".panel-body").height(f[m]),$("#"+m).trigger("panel-resize");j();var t=$(a).height(),u=d3.sum(_.values(g))+d3.sum(_.values(f))+l;o&&t!=u&&console.log("Error in vertical layout algo: filling "+t+" pixels with "+u)},hide:function(a,e){d().each(function(){var a=$(this).data("heading-content-selector");a&&a.hide()}),$(b+" > .panel > div.panel-collapse:not(.collapse):not(.out)").collapse("hide"),$(c+" i").removeClass("icon-minus").addClass("icon-plus"),$(c).attr("title","Expand Pane"),k=!0,this.resize(e),a&&rcloud.config&&rcloud.config.set_user_option(h(b),!0)},show:function(a,e){d().each(function(){var a=$(this).data("heading-content-selector");a&&a.show()}),g()&&f($(d()[0]),!1,!0),d().each(function(){$(this).collapse($(this).data("would-collapse")?"hide":"show")}),$(c+" i").removeClass("icon-plus").addClass("icon-minus"),$(c).attr("title","Collapse Pane"),k=!1,this.resize(e),a&&rcloud.config&&rcloud.config.set_user_option(h(b),!1)},calcwidth:function(){if(k)return 1;var a=[];return d().each(function(){var b=$(this).data("would-collapse")?1:$(this).attr("data-colwidth");b>0&&a.push(b)}),d3.max(a)}}),l},RCloud.UI.collapsible_column.default_padder=function(a){var b=$(a),c=b.find(".panel-body"),d=b.outerHeight()-b.height()+c.outerHeight()-c.height();return d},RCloud.UI.collapsible_column.default_sizer=function(a){var b=$(a),c=b.find(".widget-vsize"),d=c.height(),e=RCloud.UI.collapsible_column.default_padder(a);return{height:d,padding:e}},RCloud.UI.column_sizer={init:function(){$(".notebook-sizer").draggable({axis:"x",opacity:.75,zindex:1e4,revert:!0,revertDuration:0,grid:[window.innerWidth/12,0],stop:function(a,b){var c,d,e=window.innerWidth/12;if($(this).hasClass("left"))c=Math.round(b.position.left/e),d=Math.max(1,Math.min(+RCloud.UI.left_panel.colwidth()+c,11-RCloud.UI.right_panel.colwidth())),1===d?RCloud.UI.left_panel.hide(!0,!0):RCloud.UI.left_panel.show(!0,!0),RCloud.UI.left_panel.colwidth(d),RCloud.UI.middle_column.update();else{if(!$(this).hasClass("right"))throw new Error("unexpected shadow drag with classes "+$(this).attr("class"));c=Math.round(b.position.left/e)-RCloud.UI.middle_column.colwidth(),d=Math.max(1,Math.min(+RCloud.UI.right_panel.colwidth()-c,11-RCloud.UI.left_panel.colwidth())),1===d?RCloud.UI.right_panel.hide(!0,!0):RCloud.UI.right_panel.show(!0,!0),RCloud.UI.right_panel.colwidth(d),RCloud.UI.middle_column.update()}$(this).css({left:"",right:"",top:""})}}),$(window).resize(function(){var a=window.innerWidth/12;$(".notebook-sizer").draggable("option","grid",[a,0])})}},RCloud.UI.command_prompt=function(){function a(){function a(){var a=6;k.css({height:ui_utils.ace_editor_height(m,5)+a+"px"}),m.resize(),shell.scroll_to_end(0)}function b(a,b,c){var d=n.getValue();d.length&&(RCloud.UI.command_prompt.history().add_entry(d),shell.new_cell(d,j).spread(function(a,b){b.enqueue_execution_snapshot(),shell.scroll_to_end()}),o(""))}function c(a){var b=a.getSession().getDocument();return b.getLength()-1}function f(a,b){var c=a.getSession().getDocument();return c.getLine(b).length}function g(){var a=h.init();o(a.cmd),l.language(a.lang);var b=c(m);ui_utils.ace_set_pos(m,b,f(m,b))}function i(a){var b=ace.require(RCloud.language.ace_mode(a)).Mode;n.setMode(new b(!1,n.doc,n))}var k=$("#command-prompt");if(!k.length)return null;k.css({"background-color":"#fff"}),k.addClass("r-language-pseudo"),ace.require("ace/ext/language_tools");var m=ace.edit(k[0]);d=m,a();var n=(ace.require("ace/mode/r").Mode,m.getSession());e=n;n.doc;m.setOptions({enableBasicAutocompletion:!0}),n.on("change",a),m.setTheme("ace/theme/chrome"),n.setUseWrapMode(!0),m.resize();var o=ui_utils.ignore_programmatic_changes(m,h.change.bind(h));ui_utils.install_common_ace_key_bindings(m,l.language.bind(l));var p=m.commands.commandKeyBinding[0].up,q=m.commands.commandKeyBinding[0].down;return m.commands.addCommands([{name:"execute",bindKey:{win:"Return",mac:"Return",sender:"editor"},exec:b},{name:"execute-2",bindKey:{win:"Alt-Return",mac:"Alt-Return",sender:"editor"},exec:b},{name:"up-with-history",bindKey:"up",exec:function(a,b,c){var d=a.getCursorPositionScreen();if(d.row>0)p.exec(a,b,c);else if(h.has_last()){o(h.last());var e=a.getSession().getScreenLength();ui_utils.ace_set_pos(a,e,d.column)}else ui_utils.ace_set_pos(a,0,0)}},{name:"down-with-history",bindKey:"down",exec:function(a,b,d){var e=a.getCursorPositionScreen(),g=a.getSession().getScreenLength();e.row<g-1?q.exec(a,b,d):h.has_next()?(o(h.next()),ui_utils.ace_set_pos(a,0,e.column)):(g=c(a),ui_utils.ace_set_pos(a,g,f(a,g)))}},{name:"blurCell",bindKey:{win:"Escape",mac:"Escape"},exec:function(){d.blur()}}]),m.commands.removeCommands(["find","replace"]),ui_utils.customize_ace_gutter(m,function(a){return 0===a?"&gt;":"+"}),{widget:m,restore:g,set_language:i}}function b(){function a(){return c[d]||(d<b.length?b[d]:"")}var b=[],c=[],d=0,e=null,f={init:function(){e="rcloud.history."+shell.gistname()+".";var f=0;b=[],c=[];for(var g=window.localStorage.last_cell_lang||"R";;){var h=window.localStorage[e+f],i=window.localStorage[e+f+".alt"];if(void 0!==i&&(c[f]=i),void 0===h)break;b.push(h),++f}return d=b.length,{cmd:a(),lang:g}},add_entry:function(a){""!==a&&(c[b.length]=null,b.push(a),c[d]=null,d=b.length,window.localStorage[e+(d-1)]=a)},has_last:function(){return d>0},last:function(){return d>0&&--d,a()},has_next:function(){return d<b.length},next:function(){return d<b.length&&++d,a()},change:function(a){window.localStorage[e+d+".alt"]=c[d]=a}};return f}function c(){var a=$("#prompt-area"),b=$("#command-prompt"),c=$("#prompt-area .cell-status .cell-control-bar");g?a.hide():(a.show(),f?(b.show(),c.removeClass("flipped")):(b.hide(),c.addClass("flipped")))}var d,e,f=!1,g=!0,h=null,i=null,j=null,k=null,l={init:function(){RCloud.UI.cell_commands.add({insert_prompt:{area:"prompt",modifying:!0,sort:1e3,create:function(){return RCloud.UI.cell_commands.create_button("icon-plus","insert new cell",function(){shell.new_cell("",j).spread(function(a,b){b.edit_source(!0)})})}},language_prompt:{area:"prompt",modifying:!0,sort:2e3,create:function(){return RCloud.UI.cell_commands.create_select(RCloud.language.available_languages(),function(a){window.localStorage.last_cell_lang=a,RCloud.UI.command_prompt.language(a,!0)})}}});var c=$(RCloud.UI.panel_loader.load_snippet("command-prompt-snippet"));$("#rcloud-cellarea").append(c);var d=$("#prompt-area .cell-control-bar");k=RCloud.UI.cell_commands.decorate("prompt",d),
h=b(),i=a()},history:function(){return h},show_prompt:function(a){return arguments.length?(f=a,c(),this):f},readonly:function(a){return arguments.length?(g=a,c(),this):g},language:function(a,b){return void 0===a?j:(j=a,b||k.controls.language_prompt.set(j),i.set_language(j),this)},focus:function(){i&&(i.widget.focus(),i.restore())},ace_widget:function(){return d},get_selection:function(){return f?e.doc.getTextRange(d.selection.getRange()):void 0}};return l}(),RCloud.UI.comments_frame=function(){function a(a){try{a=JSON.parse(a)}catch(d){return void RCloud.UI.session_pane.post_error("populate comments: "+d.message)}var e=rcloud.username(),f=function(a){return a.user.login===e&&!b};d3.select("#comment-count").text(String(a.length)),d3.select("#comments-container").selectAll("div").remove();var g=d3.select("#comments-container").selectAll("div").data(a).enter().append("div").attr("class","comment-container").on("mouseover",function(a){f(a)&&$(".comment-header-close",this).show()}).on("mouseout",function(a){$(".comment-header-close",this).hide()}).attr("comment_id",function(a){return a.id});g.append("div").attr("class","comment-header").style({"max-width":"30%"}).text(function(a){return a.user.login}),g.append("div").attr("class","comment-body").style({"max-width":"70%"}).append("div").attr("class","comment-body-wrapper").append("div").attr("class","comment-body-text").text(function(a){return a.body}).each(function(a){var b=$(this),d=function(d){var e=b.html();c.modify_comment(a.id,e)},e={change:d,allow_multiline:!0,validate:function(a){return!Notebook.empty_for_github(a)}};ui_utils.editable(b,$.extend({allow_edit:f(a),inactive_text:b.text(),active_text:b.text()},e))});var h=d3.selectAll(".comment-body-wrapper",this);h.append("i").attr("class","icon-remove comment-header-close").style({"max-width":"5%"}).on("click",function(a,b){f(a)&&c.delete_comment(a.id)}),$("#collapse-comments").trigger("size-changed"),ui_utils.on_next_tick(function(){ui_utils.scroll_to_after($("#comments-qux"))})}var b=!1,c={body:function(){return RCloud.UI.panel_loader.load_snippet("comments-snippet")},init:function(){var a=this,b=$("#comment-entry-body"),c=0,d="";$("#comment-submit").click(function(){return Notebook.empty_for_github(b.val())||(a.post_comment(_.escape(b.val())),b.height("41px")),!1}),b.keydown(function(e){return e.keyCode==$.ui.keyCode.ENTER&&(e.ctrlKey||e.metaKey)?(Notebook.empty_for_github(b.val())||(a.post_comment(_.escape(b.val())),b.height("41px"),c=0,d=""),!1):void b.bind("input",function(){return c>1&&d!=b[0].scrollHeight&&b.height(b[0].scrollHeight+"px"),c+=1,d=b[0].scrollHeight,$("#comments-qux").animate({scrollTop:$(document).height()},"slow"),!1})})},set_foreign:function(a){a?($("#comment-entry").hide(),$("#comments-not-allowed").show()):($("#comment-entry").show(),$("#comments-not-allowed").hide()),b=a},display_comments:function(){return rcloud.get_all_comments(shell.gistname()).then(function(b){a(b)})},post_comment:function(a){return a=JSON.stringify({body:a}),rcloud.post_comment(shell.gistname(),a).then(this.display_comments.bind(this)).then(function(){$("#comment-entry-body").val("")})},modify_comment:function(a,b){return b=JSON.stringify({body:b}),rcloud.modify_comment(shell.gistname(),a,b).then(this.display_comments.bind(this))},delete_comment:function(a){return rcloud.delete_comment(shell.gistname(),a).then(this.display_comments.bind(this))}};return c}(),RCloud.UI.configure_readonly=function(){var a=$("#readonly-notebook"),b=RCloud.UI.navbar.control("revert_notebook"),c=RCloud.UI.navbar.control("save_notebook");shell.notebook.controller.is_mine()?shell.notebook.model.read_only()?(b&&b.show(),c&&c.hide()):(b&&b.hide(),c&&c.show()):(b&&b.hide(),c&&c.hide()),shell.notebook.model.read_only()?(RCloud.UI.command_prompt.readonly(!0),RCloud.UI.selection_bar.hide(),a.show(),$("#output").sortable("disable"),$("#upload-to-notebook").prop("checked",!1).attr("disabled",!0),RCloud.UI.scratchpad.set_readonly(!0),RCloud.UI.find_replace.hide_replace()):(RCloud.UI.command_prompt.readonly(!1),RCloud.UI.selection_bar.show(),a.hide(),$("#output").sortable("enable"),$("#upload-to-notebook").prop("checked",!1).removeAttr("disabled"),RCloud.UI.scratchpad.set_readonly(!1))},function(){var a,b;RCloud.UI.fatal_dialog=function(c,d,e){if($("#loading-animation").hide(),_.isUndefined(a)){var f=$("<button type='submit' class='btn btn-primary' style='float:right'>"+d+"</span>"),g=$("<span class='btn' style='float:right'>Ignore</span>"),h=$("<div />").append("<h1>Aw, shucks</h1>");b=$('<p style="white-space: pre-wrap">'+c+"</p>"),h.append(b,f),e&&h.append(g),h.append('<div style="clear: both;"></div>'),f.click(function(b){b.preventDefault(),_.isString(e)?window.location=e:_.isFunction(e)?(a.modal("hide"),e()):a.modal("hide")}),g.click(function(){a.modal("hide")}),a=$('<div id="fatal-dialog" class="modal fade" />').append($('<div class="modal-dialog" />').append($('<div class="modal-content" />').append($('<div class="modal-body" />').append(h)))),$("body").append(a),a.on("shown.bs.modal",function(){f.focus()})}else b.text(c);a.modal({keyboard:!1})}}(),RCloud.UI.find_replace=function(){function a(a,c){function d(a){return a.keyCode===$.ui.keyCode.ENTER||!ui_utils.is_a_mac()&&114===a.keyCode?(a.preventDefault(),a.stopPropagation(),a.shiftKey?t():s(),!1):void 0}_.isUndefined(c)&&(c={}),W=a;var e=P&&"none"!==P.css("display");if(!P){var f=$(_.template($("#find-in-notebook-snippet").html())({}));$("#middle-column").prepend(f),P=$(f.get(0)),A=f.find("#find-form"),B=f.find("#find-details"),C=f.find("#find-input"),D=f.find("#match-status"),E=f.find("#match-index"),F=f.find("#match-total"),I=f.find("#find-next"),J=f.find("#find-last"),G=f.find("#replace-input"),K=f.find("#replace"),L=f.find("#replace-all"),H=f.find(".replace"),M=f.find("#find-close"),C.on("change",function(a){a.preventDefault(),a.stopPropagation(),b()}),B.click(function(){C.focus()}),-1===navigator.userAgent.toLowerCase().indexOf("firefox")&&(A.on("focusout",function(a){setTimeout(function(){0===$(document.activeElement).closest(A).length&&(U=!1,g())},100)}),A.on("focusin",function(a){U||(shell.save_notebook(),b(C.data("searchagain")?N:void 0)),U=!0})),I.click(function(a){return a.preventDefault(),a.stopPropagation(),s(),!1}),J.click(function(a){return a.preventDefault(),a.stopPropagation(),t(),!1}),K.click(function(a){a.preventDefault(),a.stopPropagation(),u()}),L.click(function(a){return a.preventDefault(),a.stopPropagation(),w(),!1}),S=["find-input","find-last","find-next"],T=["find-input","find-last","find-next","replace-input","replace","replace-all"],S.push("find-close"),T.push("find-close"),C.keydown(d),G.keydown(d),A.keydown(function(a){switch(a.keyCode){case $.ui.keyCode.TAB:a.preventDefault(),a.stopPropagation();var b=R?T:S,c=b.indexOf(a.target.id)+b.length;return a.shiftKey?--c:++c,c%=b.length,$("#"+b[c]).focus(),!1;case $.ui.keyCode.ESCAPE:h()}}),A.find("input").focus(function(){window.setTimeout(function(){this.select()}.bind(this),0)}),M.click(function(){h()})}if(P.show(),a?H.show():H.hide(),_.isUndefined(O)&&(O=setInterval(function(){var a=C.data("value"),c=C.val();c!==a&&(b(),C.data("value",c))},250)),b(c.search_again?N:void 0),c&&c.search_again){var i=m();if(V.length&&i){var j,k;k=_.find(V,function(a){return a.index===i.cell_index&&a.begin>=i.cursor_index||a.index>i.cell_index}),k?(j=V.findIndex(function(a){return a.begin===k.begin&&a.end===k.end&&a.index===k.index}),c.previous&&(j-=1,0>j&&(j=V.length-1))):V.length&&(j=c.next?0:V.length-1),b(j)}}if(a&&e?G.focus():C.focus(),Q){var l=n();if(c.next)s();else if(c.previous)t();else if(null!==l)C.val(l);else{ui_utils.select_allowed_elements();var o=window.getSelection().toString();o&&C.val(o)}}Q=!0,R=a}function b(a){N=void 0,j(C.val()),r(),C.val().length?(N=_.isUndefined(a)?0:a,e(),o("activate")):(N=void 0,d());var b;b=0===V.length?"0":_.isUndefined(a)?"1":(a+1).toString(),D[0===V.length?"addClass":"removeClass"]("no-matches"),f(b,V.length)}function c(){return 0!==V.length&&!isNaN(N)}function d(){D.css("visibility","hidden")}function e(){D.css("visibility","visible")}function f(a,b){E.text(a),F.text(b)}function g(){d(),N=void 0,j(null),r(),Q=!1}function h(){if(!shell.notebook.model.read_only()){var a=V[N];if(a&&shell.notebook.model.cells[a.index]){var b=shell.notebook.model.cells[a.index].views[0];b.select_highlight_range(a.begin,a.end)}}C.data("searchagain",C.val()),clearInterval(O),g(),P.hide()}function i(a){return a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function j(a){z=a&&a.length?new RegExp(i(a),"g"):null}function k(a){var b=V.filter(function(b){return b.filename===a.filename});shell.notebook.model.cells[a.index].notify_views(function(a){a.change_highlights(b)})}function l(){var a=_.find(shell.notebook.model.cells,function(a){return!_.isUndefined(a.views[0].ace_widget())&&a.views[0].ace_widget().textInput.isFocused()});if(a)for(var b=0;shell.notebook.model.cells.length;b++)if(shell.notebook.model.cells[b].filename()===a.filename()){a.index=b;break}return a}function m(){var a=l();if(a){var b=a.views[0].ace_widget();return{cell_index:a.index,cursor_index:b.session.doc.positionToIndex(b.getCursorPosition())}}}function n(){var a=l();return a?a.views[0].get_selection():RCloud.UI.command_prompt.ace_widget()&&RCloud.UI.command_prompt.ace_widget().textInput.isFocused()?RCloud.UI.command_prompt.get_selection():null}function o(a){if(c()){var b=V[N];if(b){switch(a){case"replace":b.kind="replaced";break;case"activate":b.kind="replaced"===b.kind?"activereplaced":"active";break;case"deactivate":b.kind="activereplaced"===b.kind?"replaced":"normal"}k(b)}}}function p(a){var b=[];if(z)for(var c,d=a.content();c=z.exec(d);)b.push({begin:c.index,end:c.index+c[0].length,kind:b.length===N?"active":"normal"}),c.index===z.lastIndex&&++z.lastIndex;return a.notify_views(function(a){a.change_highlights(b)}),b}function q(a,b,c){return a.map(function(a){return _.extend({index:c,filename:b.filename()},a)})}function r(){shell.is_view_mode()&&shell.notebook.controller.show_r_source(),V=[],shell.notebook.model.cells.forEach(function(a,b){var c=p(a);V.push.apply(V,q(c,a,b))})}function s(a){o(a||"deactivate"),c()?(N=(N+V.length+1)%V.length,f(N+1,V.length)):N=0,o("activate")}function t(){o("deactivate"),c()?(N=(N+V.length-1)%V.length,f(N+1,V.length)):N=0,o("activate")}function u(){if(c()){var a=v();a&&shell.notebook.controller.update_cell(a).then(function(){s("replace")})}else s();return!1}function v(){if(!c())return null;var a=V[N],b=shell.notebook.model.cells[a.index],d=b.content(),e=d.substring(0,a.begin),f=d.substring(a.end),g=G.val(),h=g.length+a.begin-a.end;a.begin=e.length,a.end=e.length+g.length;for(var i=N+1;i<V.length&&V[i].filename===a.filename;++i)V[i].begin+=h,V[i].end+=h;return b.content(e+g+f)?b:null}function w(){return c()?(o("deactivate"),y()):x(C.val(),G.val()),!1}function x(a,b){if(r(null),a&&a.length){a=i(a);var c=new RegExp(a,"g"),d=shell.notebook.model.reread_buffers();shell.notebook.model.cells.forEach(function(a){var e=a.content(),f=e.replace(c,b);a.content(f)&&d.push.apply(d,shell.notebook.model.update_cell(a))}),shell.notebook.controller.apply_changes(d)}}function y(){for(var a=shell.notebook.model.reread_buffers();N<V.length;){var b=v();o("replace"),b&&a.push.apply(a,shell.notebook.model.update_cell(b)),++N}N=void 0,shell.notebook.controller.apply_changes(a)}var z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P=null,Q=!1,R=!1,S=null,T=null,U=!1,V=[],W=!1,X={init:function(){RCloud.UI.shortcut_manager.add([{category:"Search/Replace",id:"notebook_find",description:"Find text",keys:{mac:[["command","f"]],win:[["ctrl","f"]]},action:function(){a(!1)}},{category:"Search/Replace",id:"notebook_find_next",description:"Find text (next)",keys:{mac:[["command","g"]],win:[["ctrl","g"],["f3"]]},action:function(){a(!1,{next:!0,search_again:!0})}},{category:"Search/Replace",id:"notebook_find_previous",description:"Find text (previous)",keys:{mac:[["command","shift","g"]],win:[["ctrl","shift","g"],["shift","f3"]]},action:function(){a(!1,{previous:!0,search_again:!0})}},{category:"Search/Replace",id:"notebook_replace",description:"Replace text",keys:{mac:[["command","option","f"]],win:[["ctrl","h"]]},modes:["writeable"],action:function(){a(!shell.notebook.model.read_only())}},{category:"Search/Replace",id:"notebook_replace_text_match",description:"Replace next match",keys:{win_mac:[["alt","r"]]},modes:["writeable"],element_scope:"#find-form",action:function(){W&&u()}},{category:"Search/Replace",id:"notebook_replace_text_all",description:"Replace all matches",keys:{win_mac:[["alt","a"]]},modes:["writeable"],element_scope:"#find-form",action:function(){W&&w()}},{category:"Search/Replace",id:"notebook_goto_previous_match",description:"Go to previous search match",keys:{mac:[["shift","enter"]],win:[["shift","enter"],["shift","f3"]]}},{category:"Search/Replace",id:"notebook_goto_next_match",description:"Go to next search match",keys:{mac:[["enter"]],win:[["enter"],["f3"]]}}])},hide_replace:function(){H&&H.hide()},clear_highlights:function(){g()}};return X}(),RCloud.UI.shortcut_manager=function(){function a(a){return _.find(e.sections.all.entries,function(b){return b.id===a})}function b(b,c){_.isArray(b)||(b=[b]),_.each(b,function(b){var d=a(b);d&&c(d)})}function c(a){return a.enabled&&_.contains(a.modes,shell.notebook.model.read_only()?"readonly":"writeable")&&_.contains(a.on_page,shell.is_view_mode()?"view":"edit")&&(!_.isFunction(a.is_active)||_.isFunction(a.is_active)&&a.is_active())}function d(b){var d,f={},g=e.sections.all.entries;return d=_.isArray(b)?b:[b],_.each(d,function(b){var d=!0,e=_.defaults(b,{category:"General",modes:["writeable","readonly"],on_page:["view","edit"],ignore_clash:!1,enable_in_dialogs:!1,enabled:!0}),h=ui_utils.is_a_mac();if(b.keys&&(b.keys.hasOwnProperty("win_mac")?b.bind_keys=b.keys.win_mac:b.bind_keys=b.keys[h?"mac":"win"]),b.click_keys&&(b.click_keys.hasOwnProperty("win_mac")?b.click_keys.keys=b.click_keys.win_mac:(b.click_keys.hasOwnProperty("win")||b.click_keys.hasOwnProperty("mac"))&&(b.click_keys.keys=b.click_keys[h?"mac":"win"])),b.bind_keys&&b.bind_keys.length||b.click_keys){if(e.key_desc=[],b.bind_keys)for(var i=0;i<b.bind_keys.length;i++){var j=_.chain(b.bind_keys[i]).map(function(a){return a.toLowerCase()}).sortBy(function(a){var b={command:1,ctrl:2,shift:3};return b[a]}).value();e.key_desc.push(j.join("+"))}if(!e.ignore_clash)for(var k=0;k<g.length;k++)if(!g[k].ignore_clash&&_.intersection(g[k].key_desc,e.key_desc).length>0){console.warn('Keyboard shortcut "'+e.description+'" cannot be registered because its keycode clashes with an existing shortcut id "'+g[k].id+'" in the "'+g[k].category+'" category.'),d=!1;break}d&&(_.isUndefined(b.action)?e.create=function(){}:e.create=function(){_.each(e.key_desc,function(d){var f=function(d){if(c(a(e.id))){var f=!0;if(!b.enable_in_dialogs&&$(".modal").is(":visible")&&(f=!1),b.element_scope){var g=$(b.element_scope),h=$(":focus");f=g.length&&h.length?$.contains(g.get(0),h.get(0)):!1}f&&(d.preventDefault(),b.action(d))}};e.global?window.Mousetrap.bindGlobal(d,f):window.Mousetrap().bind(d,f)})},d&&(f[b.id]=e,g.push(e)))}}),f}var e,f={init:function(){return window.Mousetrap.prototype.stopCallback=function(a,b,c){var d=["mousetrap","ace_text-input"],e=a.metaKey||a.ctrlKey||a.altKey||114===a.keyCode;return e&&d.some(function(a){return(" "+b.className+" ").indexOf(" "+a+" ")>-1})?!1:"INPUT"==b.tagName&&"checkbox"!==b.type||"SELECT"==b.tagName||"TEXTAREA"==b.tagName||b.contentEditable&&"true"==b.contentEditable},e=RCloud.extension.create({}),this.add([]),this},add:function(a){return e&&e.add(d(a)),this},load:function(){e&&e.create("all")},disable:function(a){b(a,function(a){a.enabled=!1})},disable_all:function(){this.disable(_.pluck(e.sections.all.entries,"id"))},enable:function(a){b(a,function(a){a.enabled=!0})},get_registered_shortcuts_by_category:function(a){var b=_.map(a,function(a,b){return{key:a,value:b+1}});b=_.object(_.pluck(b,"key"),_.pluck(b,"value"));var d=_.filter(_.sortBy(e.sections.all.entries,function(a){return a.category+a.description}),function(a){return c(a)});return _.sortBy(_.map(_.chain(d).groupBy("category").value(),function(a,b){return{category:b,shortcuts:a}}),function(a){return b[a.category]})}};return f}(),RCloud.UI.shortcut_dialog=function(){var a=[],b={show:function(){$("#loading-animation").hide();var b=[];a&&(a=RCloud.UI.shortcut_manager.get_registered_shortcuts_by_category(["Code Editor","Code Prompt","Cell Management","Notebook Management","Search/Replace","General"]));var c=function(a){var b=_.findWhere([{initial:"option",replace_with:"opt"},{initial:"command",replace_with:"cmd"}],{initial:a});return b?b.replace_with:a};_.each(a,function(a){var d={name:a.category,shortcuts:[]};_.each(a.shortcuts,function(a){var b={description:a.description,keys:[]};_.each(a.bind_keys,function(a){a=_.map(a,function(a){return c(a)}),b.keys.push(a.join(" "))}),a.click_keys&&b.keys.push({keys:_.map(a.click_keys.keys,function(a){return c(a)}).join(" "),target:a.click_keys.target}),d.shortcuts.push(b)}),b.push(d)});var d=_.template($("#shortcut_dialog_content_template").html()),e=d({categories:b});$("#shortcut-content").html(e),$("#shortcut-dialog").modal({keyboard:!1})}};return b}(),RCloud.UI.ace_shortcuts=function(){var a={init:function(){var a=[{category:"Code prompt",id:"code_prompt_execute",description:"Create cell and execute code",keys:{win_mac:[["enter"],["alt","enter"]]}},{category:"Code prompt",id:"code_prompt_history_back",description:"Go back in code history",keys:{win_mac:[["up"]]}},{category:"Code prompt",id:"code_prompt_history_forwards",description:"Go forwards in code history",keys:{win_mac:[["down"]]}},{category:"Code Editor",id:"code_editor_execute",description:"Execute code",keys:{win_mac:[["alt","enter"]]}},{category:"Code Editor",id:"code_editor_autocomplete",description:"Suggest autocompletion",keys:{win_mac:[["ctrl","."],["tab"]]}},{category:"Code Editor",id:"code_editor_execute_selection_or_line",description:"Execute selection or line",keys:{mac:[["command","enter"]],win:[["ctrl","enter"]]}},{category:"Code Editor",id:"code_editor_cursor_start_of_line",description:"Cursor at beginning of line",keys:{mac:[["ctrl","a"]]}},{category:"Code Editor",id:"code_editor_cursor_end_of_line",description:"Cursor at end of line",keys:{mac:[["ctrl","e"]]}},{category:"Code Editor",id:"ace_remove_line",description:"Remove line",keys:{mac:[["cmd","d"]],win:[["ctrl","d"]]}},{category:"Code Editor",id:"ace_copy_lines_down",description:"Copy lines down",keys:{mac:[["cmd","option","down"]],win:[["alt","shift","down"]]}},{category:"Code Editor",id:"ace_remove_line",description:"Copy lines up",keys:{mac:[["cmd","option","up"]],win:[["alt","shift","up"]]}},{category:"Code Editor",id:"ace_move_lines_down",description:"Move lines down",keys:{mac:[["option","down"]],win:[["alt","down"]]}},{category:"Code Editor",id:"ace_move_lines_up",description:"Move lines up",keys:{mac:[["option","up"]],win:[["alt","up"]]}},{category:"Code Editor",id:"ace_remove_to_line_end",description:"Remove to line end",keys:{mac:[["ctrl","k"]],win:[["alt","delete"]]}},{category:"Code Editor",id:"ace_remove_to_line_start",description:"Remove to line start",keys:{mac:[["cmd","backspace"]],win:[["alt","backspace"]]}},{category:"Code Editor",id:"ace_remove_word_left",description:"Remove word left",keys:{mac:[["option","backspace"],["ctrl","option","backspace"]],win:[["ctrl","backspace"]]}},{category:"Code Editor",id:"ace_remove_word_right",description:"Remove word right",keys:{mac:[["option","delete"]],win:[["ctrl","delete"]]}},{category:"Code Editor",id:"ace_split_line",description:"Split line",keys:{mac:[["ctrl","o"]]}},{category:"Code Editor",id:"ace_select_all",description:"Select all",keys:{mac:[["cmd","a"]],win:[["ctrl","a"]]}},{category:"Code Editor",id:"ace_select_left",description:"Select left",keys:{win_mac:[["shift","left"]]}},{category:"Code Editor",id:"ace_select_right",description:"Select right",keys:{win_mac:[["shift","right"]]}},{category:"Code Editor",id:"ace_select_word_left",description:"Select word left",keys:{mac:[["option","shift","left"]],win:[["ctrl","shift","left"]]}},{category:"Code Editor",id:"ace_select_word_right",description:"Select word right",keys:{mac:[["option","shift","right"]],win:[["ctrl","shift","right"]]}},{category:"Code Editor",id:"ace_select_line_start",description:"Select line start",keys:{win_mac:[["shift","home"]]}},{category:"Code Editor",id:"ace_select_line_end",description:"Select line end",keys:{win_mac:[["shift","end"]]}},{category:"Code Editor",id:"ace_select_line_end",description:"Select to line end",keys:{mac:[["option","shift","right"]],win:[["alt","shift","right"]]}},{category:"Code Editor",id:"ace_select_line_start",description:"Select to line start",keys:{mac:[["option","shift","left"]],win:[["alt","shift","left"]]}},{category:"Code Editor",id:"ace_select_up",description:"Select up",keys:{win_mac:[["shift","up"]]}},{category:"Code Editor",id:"ace_select_down",description:"Select down",keys:{win_mac:[["shift","down"]]}},{category:"Code Editor",id:"ace_select_page_up",description:"Select page up",keys:{win_mac:[["shift","pageup"]]}},{category:"Code Editor",id:"ace_select_page_down",description:"Select page down",keys:{win_mac:[["shift","pagedown"]]}},{category:"Code Editor",id:"ace_select_to_start",description:"Select to start",keys:{mac:[["command","shift","up"]],win:[["ctrl","shift","home"]]}},{category:"Code Editor",id:"ace_select_to_end",description:"Select to end",keys:{mac:[["command","shift","down"]],win:[["ctrl","shift","end"]]}},{category:"Code Editor",id:"ace_duplicate_selection",description:"Duplicate selection",keys:{mac:[["command","shift","d"]],win:[["ctrl","shift","d"]]}},{category:"Code Editor",id:"ace_select_to_matching_bracket",description:"Select to matching bracket",keys:{win:[["ctrl","shift","p"]]}},{category:"Code Editor",id:"ace_go_to_left",description:"Go to left",keys:{mac:[["left"],["ctrl","b"]],win:[["left"]]}},{category:"Code Editor",id:"ace_go_to_right",description:"Go to right",keys:{mac:[["right"],["ctrl","f"]],win:[["right"]]}},{category:"Code Editor",id:"ace_go_to_word_left",description:"Go to word left",keys:{mac:[["option","left"]],win:[["ctrl","left"]]}},{category:"Code Editor",id:"ace_go_to_word_right",description:"Go to word right",keys:{mac:[["option","right"]],win:[["ctrl","right"]]}},{category:"Code Editor",id:"ace_go_line_up",description:"Go line up",keys:{mac:[["up"],["ctrl","p"]],win:[["up"]]}},{category:"Code Editor",id:"ace_go_line_down",description:"Go line down",keys:{mac:[["down"],["ctrl","n"]],win:[["down"]]}},{category:"Code Editor",id:"ace_go_to_line_start",description:"Go to line start",keys:{mac:[["command","left"],["home"],["ctrl","a"]],win:[["alt","left"],["home"]]}},{category:"Code Editor",id:"ace_go_to_line_end",description:"Go to line end",keys:{mac:[["command","right"],["end"],["ctrl","e"]],win:[["alt","right"],["end"]]}},{category:"Code Editor",id:"ace_go_to_page_up",description:"Go to page up",keys:{mac:[["option","pageup"]],win:[["pageup"]]}},{category:"Code Editor",id:"ace_go_to_page_down",description:"Go to page down",keys:{mac:[["option","pagedown"],["ctrl","v"]],win:[["pagedown"]]}},{category:"Code Editor",id:"ace_go_to_start",description:"Go to start",keys:{mac:[["command","home"],["command","up"]],win:[["ctrl","home"]]}},{category:"Code Editor",id:"ace_go_to_end",description:"Go to end",keys:{mac:[["command","end"],["command","down"]],win:[["ctrl","end"]]}},{category:"Code Editor",id:"ace_go_to_matching_bracket",description:"Go to matching bracket",keys:{win:[["ctrl","p"]]}},{category:"Code Editor",id:"ace_scroll_page_down",description:"Scroll page down",keys:{mac:[["option","pagedown"]]}},{category:"Code Editor",id:"ace_scroll_page_up",description:"Scroll page up",keys:{mac:[["option","pageup"]]}},{category:"Code Editor",id:"ace_indent",description:"Indent",keys:{win_mac:[["tab"]]}},{category:"Code Editor",id:"ace_outdent",description:"Outdent",keys:{win_mac:[["shift","tab"]]}},{category:"Code Editor",id:"ace_undo",description:"Undo",keys:{mac:[["command","z"]],win:[["ctrl","z"]]}},{category:"Code Editor",id:"ace_redo",description:"Redo",keys:{mac:[["command","shift","z"],["command","y"]],win:[["ctrl","y"],["ctrl","shift","z"]]}},{category:"Code Editor",id:"ace_toggle_comment",description:"Toggle comment",keys:{mac:[["command","/"]],win:[["ctrl","/"]]}},{category:"Code Editor",id:"ace_change_to_lower_case",description:"Change to lower case",keys:{win_mac:[["ctrl","shift","u"]]}},{category:"Code Editor",id:"ace_change_to_upper_case",description:"Change to upper case",keys:{win_mac:[["ctrl","u"]]}},{category:"Code Editor",id:"ace_insert",description:"Overwrite",keys:{win_mac:[["insert"]]}},{category:"Code Editor",id:"ace_delete",description:"Delete",keys:{win_mac:[["delete"]]}}];_.each(a,function(a){a.ignore_clash=!0,a.modes=["writeable"]}),RCloud.UI.shortcut_manager.add(a)}};return a}(),RCloud.UI.help_frame={body:function(){return RCloud.UI.panel_loader.load_snippet("help-snippet")},init:function(){$("#help-body").append('<iframe id="help-frame" frameborder="0" />'),$("#help-form").submit(function(a){a.preventDefault(),a.stopPropagation();var b=$("#input-text-help").val();return $("#input-text-help").blur(),rcloud.help(b),!1}),$("#show-shortcuts").click(function(a){a.preventDefault(),RCloud.UI.shortcut_dialog.show()})},panel_sizer:function(a){return"none"===$("#help-body").css("display")?RCloud.UI.collapsible_column.default_sizer(a):{padding:RCloud.UI.collapsible_column.default_padder(a),height:9e3}},show:function(){$("#help-body").css("display","table-row"),$("#help-body").attr("data-widgetheight","greedy"),$("#collapse-help").trigger("size-changed");var a=$("#collapse-help"),b=a.closest(".panel-group").attr("id").includes("left")?"left":"right";RCloud.UI[b+"_panel"].collapse($("#collapse-help"),!1),ui_utils.prevent_backspace($("#help-frame").contents())},display_content:function(a){$("#help-frame").contents().find("body").html(a),this.show()},display_href:function(a){$("#help-frame").attr("src",a),this.show()}},function(){function a(a){var b,c,d,e=";base64,";if(-1==a.indexOf(e))return b=a.split(","),c=b[0].split(":")[1],d=decodeURIComponent(b[1]),new Blob([d],{type:c});b=a.split(e),c=b[0].split(":")[1],d=window.atob(b[1]);for(var f=d.length,g=new Uint8Array(f),h=0;f>h;++h)g[h]=d.charCodeAt(h);return new Blob([g],{type:c})}RCloud.UI.image_manager=function(){function b(b,c,d,f,g){function h(){var a={id:b,src:c};return $($.el.img(a))}function i(c){var d={type:c};s&&(d.dim=s),rcloud.plots.render(f,g,d).then(function(d){saveAs(a(d.url),b+"."+c)})}function j(a,b){var c=[b.size.width,b.size.height];rcloud.plots.render(f,g,{dim:c}).then(function(a){t.update(a.url,c)})["catch"](function(a){if(!/Error in replayPlot/.test(a.message))throw a})}function k(){var a=$('<span class="dropdown"></div>'),b=$('<span class="dropdown-toggle fontawesome-button" type="button" data-toggle="dropdown" aria-expanded="true"></span>');b.append($('<i class="icon-save"></i>'));var c=$('<ul role="menu" class="dropdown-menu plot-save-formats"></ul>');_.pluck(e.entries("all"),"key").forEach(function(a){var b=$('<a role="menuitem" href="#">'+a+"</a>");b.click(function(){i(a)});var d=$('<li role="presentation"></li>').append(b);c.append(d)});var d={title:"save image",delay:{show:250,hide:0}};return d.container="body",b.tooltip(d),a.append(b,c),a}function l(){var a=ui_utils.fa_button("icon-camera","set as thumb");return a.click(function(){RCloud.UI.scratchpad.update_thumb(),RCloud.UI.thumb_dialog.display_image(c)}),a}function m(a){a&&(a[0]&&q.css("width",a[0]),a[1]&&q.css("height",a[1]),s=a)}function n(a){var b=$('<div class="live-plot-container"></div>'),c=$('<div class="live-plot"></div>');r=$('<div class="live-plot-scroller"></div>'),q=$("<div></div>"),c.append(r),r.append(q,$("<br/>")),q.append(a);var e=$('<span class="live-plot-commands"></div>');return window.shell&&!shell.notebook.model.read_only()&&e.append(l()),e.append(k()),e.hide(),c.hover(function(){e.show()},function(){e.hide()}),c.append(e),a.css({width:"100%",height:"100%"}),m(d),q.resizable({autoHide:!0,stop:j}),b.append(c),b}var o,p,q,r,s;p=h(),o=n(p);var t={div:function(){return o},update:function(a,b){p.attr("src",a),m(b)},locate:function(a){o.attr("tabindex",1).css("cursor","crosshair"),o.focus().keydown(function(b){b.keyCode===$.ui.keyCode.ESCAPE&&(o.off("keydown").blur(),p.off("click"),o.attr("tabindex",null).removeAttr("style"),a(null,null))}),p.click(function(b){var c=($(this).offset(),$(this).offset().top-$(window).scrollTop()),d=$(this).offset().left-$(window).scrollLeft(),e=Math.round(b.clientX-d),f=Math.round(b.clientY-c);o.off("keydown").blur(),p.off("click"),o.attr("tabindex",null).removeAttr("style"),a(null,[e,f])})}};return t}function c(a,b){return a+"-"+b}var d={},e=RCloud.extension.create(),f={update:function(a,e,f,g){var h,i=c(f,g);return d[i]?(h=d[i],h.update(a,e)):(h=b(i,a,e,f,g),d[i]=h),h},locate:function(a,b,e){var f=c(a,b);if(d[f]){var g=d[f];g.locate(e)}else e("ERROR: cannot find image corresponding to the locator")},load_available_formats:function(){return rcloud.plots.get_formats().then(function(a){a=_.without(a,"r_attributes","r_type");var b=1e3,c={};a.forEach(function(a){c[a]={sort:b},b+=1e3}),RCloud.UI.image_manager.formats.add(c)})},formats:e};return f}()}(),RCloud.UI.import_export=function(){function a(a,b,c){var d=new Blob([b],{type:c});saveAs(d,a)}function b(){var a=[];if(d){var b=shell.get_selected_cells();return a=b.map(function(a){return a.filename()}),Promise.resolve(a)}return Promise.resolve([])}function c(a,b){return b&&b.length&&_.difference(Object.keys(a.files),b).forEach(function(b){delete a.files[b]}),a}var d;return{init:function(){return RCloud.UI.advanced_menu.add({import_notebooks:{sort:4e3,text:"Import External Notebooks",modes:["edit"],action:function(){function a(){var a=$("#import-source").val(),b=$("#import-gists").val(),d=$("#import-prefix").val();b=_.without(b.split(/[\s,;]+/),""),rcloud.port_notebooks(a,b,d).then(function(a){var b=[],c=[];for(var d in a)"r_type"!==d&&"r_attributes"!==d&&(a[d].ok?b.push(a[d].content):c.push(d));var e=[];b.forEach(function(a){e.push(editor.star_notebook(!0,{notebook:a}).then(function(){return editor.set_notebook_visibility(a.id,!0,function(){})}))}),Promise.all(e).then(function(){editor.highlight_imported_notebooks(b)}),c.length&&RCloud.UI.session_pane.post_error("Failed to import notebooks: "+c.join(", "))}),c.modal("hide")}function b(){var b=$('<div class="container"/>').append($(["<p>Import notebooks from another GitHub instance.</p><p>Currently import does not preserve history.</p>",'<p>source repo api url:&nbsp;<input type="text" class="form-control-ext" id="import-source" style="width:100%;" value="https://api.github.com"></input></td>','<p>notebooks:<br /><textarea class="form-control-ext" style="height: 20%;width: 50%;max-width: 100%" rows="10" cols="30" id="import-gists" form="port"></textarea></p>','<p>prefix (e.g. <code>folder/</code> to put notebooks in a folder):&nbsp;<input type="text" class="form-control-ext" id="import-prefix" style="width:100%;"></input>'].join(""))),c=$('<span class="btn btn-cancel">Cancel</span>').on("click",function(){$(g).modal("hide")}),d=$('<span class="btn btn-primary">Import</span>').on("click",a),e=$('<div class="modal-footer"></div>').append(c).append(d),f=$(['<div class="modal-header">','<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>',"<h3>Import Notebooks</h3>","</div>"].join("")),g=$('<div id="import-notebooks-dialog" class="modal fade"></div>').append($('<div class="modal-dialog"></div>').append($('<div class="modal-content"></div>').append(f).append(b).append(e)));return $("body").append(g),g.on("show.bs.modal",function(){$("#import-gists").val("")}).on("shown.bs.modal",function(){$("#import-source").focus().select()}),g}var c=$("#import-notebooks-dialog");c.length||(c=b()),
c.modal({keyboard:!0})}},export_notebook_gist:{sort:5e3,text:"Export Notebook to File",modes:["edit"],action:function(){rcloud.protection.get_notebook_cryptgroup(shell.gistname()).then(function(d){d?alert("Exporting protected notebooks is not supported at this time (and will always export in the clear)"):b().then(function(b){return rcloud.get_notebook(shell.gistname(),shell.version(),null,!0).then(function(d){d=Notebook.sanitize(d),d=c(d,b);var e=JSON.stringify(d);return a(d.description+".gist",e,"text/json"),d})})})}},import_notebook_gist:{sort:6e3,text:"Import Notebook from File",modes:["edit"],action:function(){function a(){function a(a){d.hide(),i.hide(),Notebook.read_from_file(a,{on_load_end:function(){d.show()},on_error:function(a){d.text(a)},on_notebook_parsed:function(a){c=a,d.text(""),e.val(c.description),i.show(),ui_utils.enable_bs_button(f)}})}function b(){var a=e.val();c&&a.length>0&&(c.description=a,rcloud.create_notebook(c,!1).then(function(a){editor.star_notebook(!0,{notebook:a}).then(function(){editor.set_notebook_visibility(a.id,!0),editor.highlight_imported_notebooks(a)})}),m.modal("hide"))}var c=null,d=null,e=null,f=null,g=$('<div class="container"/>'),h=$('<input type="file" id="notebook-file-upload" size="50"></input>');h.click(function(){ui_utils.disable_bs_button(f),[i,d].forEach(function(a){a.hide()}),h.val(null)}).change(function(){a(h[0].files[0])}),d=$("<span />"),d.append(d);var i=$("<span>Notebook description: </span>");e=$('<input type="text" class="form-control-ext" size="50" id="import-notebook-description"></input>').on("change paste keyup",function(a){var c=$(this).val().length;return c?ui_utils.enable_bs_button(f):ui_utils.disable_bs_button(f),a.which===$.ui.keyCode.ENTER&&c?(b(),!1):!0}),i.append(e),g.append($("<p/>").append(h)).append($("<p/>").append(d.hide())).append($("<p/>").append(i.hide()));var j=$('<span class="btn btn-cancel">Cancel</span>').on("click",function(){$(m).modal("hide")});f=$('<span class="btn btn-primary">Import</span>').on("click",b),ui_utils.disable_bs_button(f);var k=$('<div class="modal-footer"></div>').append(j).append(f),l=$(['<div class="modal-header">','<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>',"<h3>Import Notebook File</h3>","</div>"].join("")),m=$('<div id="import-notebook-file-dialog" class="modal fade"></div>').append($('<div class="modal-dialog"></div>').append($('<div class="modal-content"></div>').append(l).append(g).append(k)));return $("body").append(m),m.on("show.bs.modal",function(){$("#notebook-file-upload")[0].value=null,d.text(""),d.hide(),e.val(""),i.hide()}),m.data("reset",function(){c=null,ui_utils.disable_bs_button(f)}),m}var b=$("#import-notebook-file-dialog");b.length?b.data().reset():b=a(),b.modal({keyboard:!0})}},export_notebook_r:{sort:7e3,text:"Export Notebook as R Source File",modes:["edit"],action:function(){return b().then(function(b){rcloud.get_notebook(shell.gistname(),shell.version()).then(function(d){var e=[],f=[];d=c(d,b),_.each(d.files,function(a){var b=a.filename;if(/^part/.test(b)){var c=parseInt(b.slice(4).split(".")[0]);isNaN(c)||("R"===a.language?f[c]="```{r}\n"+a.content+"\n```":f[c]=a.content)}});for(var g=0;g<f.length;++g)_.isUndefined(f[g])||e.push(f[g]);e.push(""),rcloud.purl_source(e.join("\n")).then(function(b){var c=_.isString(b)?b:b.join("\n");a(d.description+".R",c,"text/plain")})})})}}}),this},export_only_selected_files:function(a){d=a}}}(),RCloud.UI.pull_and_replace=function(){var a,b=$("#pull-changes-dialog"),c=$("#pull-changes-by"),d=$("#pull-notebook-file"),e=$("#pull-notebook-url"),f=$("#pull-notebook-id"),g=b.find(".btn-cancel"),h=b.find(".close"),i="#pull-error",j=b.find(".btn-primary"),k=[d,e,f],l="You cannot pull from your current notebook; the source must be a different notebook.",m="Invalid notebook ID.",n="The notebook could not be found.",o=function(){rcloud.get_notebook_property(shell.gistname(),"pull-changes-by").then(function(a){if(a&&-1!==a.indexOf(":")){var c=a.indexOf(":"),d=a.substring(0,c),e=a.substring(c+1);q(d,e)}else q("url");b.modal({keyboard:!0})})},p=function(){y(),k.forEach(function(a){a.val("")}),a=void 0,q("url"),b.modal("hide")},q=function(a,d){v(),c.val(a),$(b).find("div[data-by]").hide(),$(b).find('div[data-by="'+a+'"]').show(),_.isUndefined(d)||u().val("file"===a?"":d)},r=function(b){Notebook.read_from_file(b,{on_load_end:function(){},on_error:function(b){a=void 0,w(b)},on_notebook_parsed:function(b){a=b}})},s=function(){function b(a){return Notebook.valid_gist_id(a)?a.toLowerCase()===shell.gistname().toLowerCase()?Promise.reject(new Error(l)):rcloud.get_notebook(a):Promise.reject(new Error(m))}var c,d=t();x(),"id"===d?c=b:"file"===d?c=function(){return a?Promise.resolve(a):Promise.reject(new Error("No file to upload"))}:"url"===d&&(c=function(a){var c=RCloud.utils.get_notebook_from_url(a);return c?b(c):Promise.reject(new Error("Invalid URL"))});var e=u().val();c(e).then(function(a){return Promise.all([rcloud.set_notebook_property(shell.gistname(),"pull-changes-by",d+":"+e),editor.pull_and_replace_notebook(a).then(function(){p()})])})["catch"](function(a){y(),w(-1!==a.message.indexOf("Not Found (404)")?n:a.message)})},t=function(){return c.val()},u=function(){return $("#pull-notebook-"+t())},v=function(){$(i).remove()},w=function(a){v(),$("<div />",{id:i.substring(1),text:a}).appendTo($(b).find('div[data-by="'+t()+'"]'))},x=function(){j.text("Pulling"),b.addClass("pulling")},y=function(){j.text("Pull"),b.removeClass("pulling")};return{init:function(){return RCloud.UI.advanced_menu.add({pull_and_replace_notebook:{sort:3e3,text:"Pull and Replace Notebook",modes:["edit"],disabled_reason:"You can't pull and replace into a read only notebook",action:function(){o()}}}),[g,h].forEach(function(a){a.click(p)}),c.change(function(){d.val(null),q($(this).val())}),d.click(function(){v(),d.val(null),a=void 0}).change(function(){r(d[0].files[0])}),[e,f,c,d].forEach(function(a){a.keydown(function(a){a.keyCode===$.ui.keyCode.ENTER&&(s(),a.preventDefault())})}),j.click(s),this}}}(),RCloud.UI.init=function(){function a(){var a=$("#output");a.sortable({items:"> .notebook-cell",start:function(a,b){$(a.toElement).addClass("grabbing"),b.placeholder.height(b.item.height())},stop:function(a,b){$(a.toElement).removeClass("grabbing")},update:function(b,c){var d=(a.sortable("toArray"),c.item.data("rcloud.model")),e=c.item.next().data("rcloud.model");shell.notebook.controller.move_cell(d,e)},handle:" .cell-status",helper:"clone",scroll:!0,scrollSensitivity:40,forcePlaceholderSize:!0})}RCloud.UI.run_button.init(),a(),RCloud.UI.column_sizer.init(),$(window).bind("unload",function(){return shell.save_notebook(),!0}),RCloud.UI.menus.init(),RCloud.UI.advanced_menu.init(),RCloud.UI.navbar.init(),RCloud.UI.selection_bar.init(),RCloud.UI.shortcut_manager.init(),RCloud.UI.ace_shortcuts.init(),RCloud.UI.find_replace.init(),RCloud.UI.share_button.init(),RCloud.UI.notebook_commands.init(),RCloud.UI.cell_commands.init(),RCloud.UI.panel_loader.init(),RCloud.UI.import_export.init(),RCloud.UI.pull_and_replace.init(),ui_utils.prevent_backspace($(document)),$(document).on("copy",function(a){!$(arguments[0].target).hasClass("ace_text-input")&&$(arguments[0].target).closest($("#output")).size()&&ui_utils.select_allowed_elements()}),shell.is_view_mode()||$(document).on("scroll",function(){$(this).scrollLeft(0),$(this).scrollTop(0)}),$("#rcloud-cellarea").on("scroll",function(){$(this).scrollLeft(0)}),$(window).resize(function(a){shell.refresh_notebook_title()}),RCloud.UI.shortcut_manager.add([{category:"Notebook Management",id:"notebook_cell",description:"Save the current notebook",keys:{mac:[["command","s"]],win:[["ctrl","s"]]},modes:["writeable"],action:function(){RCloud.UI.navbar.get("save_notebook")&&shell.save_notebook()}},{category:"Notebook Management",id:"select_all",description:"Select all",keys:{mac:[["command","a"]],win:[["ctrl","a"]]},modes:["writeable"],action:function(a){if($(a.target).parents("#find-form").length)$(a.target).select();else{var b=window.getSelection();b.removeAllRanges();var c=new Range;c.selectNode(document.getElementById("output")),c.setStartAfter($(".response")[0]),b.addRange(c)}}},{category:"Notebook Management",id:"history_undo",description:"Step back through the notebook's history",keys:{mac:[["command","z"]],win:[["ctrl","z"]]},on_page:["edit"],action:function(){editor.step_history_undo()}},{category:"Notebook Management",id:"history_redo",description:"Step forwards through the notebook's history",keys:{mac:[["command","shift","z"]],win:[["ctrl","y"]]},on_page:["edit"],action:function(){editor.step_history_redo()}},{category:"Notebook Management",id:"history_revert",description:"Revert a notebook",keys:{mac:[["command","e"]],win:[["ctrl","e"]]},on_page:["edit"],is_active:function(){return shell.notebook.controller.is_mine()&&shell.notebook.model.read_only()},action:function(){this.is_active()&&editor.revert_notebook(shell.notebook.controller.is_mine(),shell.gistname(),shell.version())}},{id:"notebook_run_all",description:"Run all",keys:{win_mac:[["ctrl","shift","enter"]]},action:function(){RCloud.UI.run_button.run()}}]),RCloud.UI.shortcut_manager.add([{category:"Cell Management",id:"remove_cells",description:"Remove selected cells",keys:{mac:[["del"],["backspace"],["command","backspace"]],win:[["del"],["backspace"]]},modes:["writeable"],action:function(){shell.notebook.controller.remove_selected_cells()}},{category:"Cell Management",id:"invert_cells",description:"Invert selected cells",keys:{mac:[["command","shift","i"]],win:[["ctrl","shift","i"]]},modes:["writeable"],action:function(){shell.notebook.controller.invert_selected_cells(),$(":focus").blur()}},{category:"Cell Management",id:"crop_cells",description:"Crop cells",keys:{mac:[["command","k"]],win:[["ctrl","k"]]},modes:["writeable"],action:function(){shell.notebook.controller.crop_cells()}},{category:"Cell Management",id:"arrow_next_cell",description:"Enter next cell (from end of current)",keys:{win_mac:[["right"]]},modes:["writeable"]},{category:"Cell Management",id:"arrow_previous_cell",description:"Enter previous cell (from start of current)",keys:{win_mac:[["left"]]},modes:["writeable"]},{category:"Cell Management",id:"arrow_next_cell_down",description:"Enter next cell (from last line of current)",keys:{win_mac:[["down"]]},modes:["writeable"]},{category:"Cell Management",id:"arrow_previous_cell_up",description:"Enter previous cell (from first line of current)",keys:{win_mac:[["up"]]},modes:["writeable"]},{category:"Cell Management",id:"goto_previous_cell",description:"Go to previous cell",keys:{win_mac:[["ctrl","shift","<"]]},modes:["writeable"]},{category:"Cell Management",id:"goto_next_cell",description:"Go to next cell",keys:{win_mac:[["ctrl","shift",">"]]},modes:["writeable"]},{category:"Cell Management",id:"insert_cell_before",description:"Insert cell before current",keys:{win:[["ctrl","["]],mac:[["command","["]]},modes:["writeable"],action:function(){}},{category:"Cell Management",id:"insert_cell_after",description:"Insert cell after current",keys:{win:[["ctrl","]"]],mac:[["command","]"]]},modes:["writeable"],action:function(){}},{category:"Cell Management",id:"cell_run_from_here",description:"Run from this cell on",keys:{win_mac:[["shift","alt","enter"]]},click_keys:{target:"Play button",win_mac:[["shift"]]},modes:["writeable"]},{category:"Cell Management",id:"blur_cell",description:"Blur Cell/Command Prompt",keys:{win_mac:[["esc"]]},modes:["writeable"]},{category:"Cell Management",id:"select_cell",description:"Select individual cell",click_keys:{target:"Cell title"}},{category:"Cell Management",id:"toggle_select_cell",description:"Toggle cell selection",click_keys:{target:"Cell title",win:["ctrl"],mac:["command"]}},{category:"Cell Management",id:"select_cell_range",description:"Select range of cells",click_keys:{target:"Cell title",win_mac:["shift"]}}]),RCloud.UI.shortcut_manager.add([{category:"General",id:"show_help",description:"Show shortcuts help",keys:{win_mac:[["?"]]},modes:["writeable","readonly"],action:function(a){RCloud.UI.shortcut_dialog.show()}},{category:"General",id:"close_modal",description:"Close dialog",keys:{win_mac:[["esc"]]},ignore_clash:!0,enable_in_dialogs:!0,global:!0,action:function(){$(".modal").modal("hide")}}])},RCloud.UI.left_panel=RCloud.UI.collapsible_column("#left-column","#accordion-left","#left-pane-collapser"),RCloud.UI.load_options=function(){return rcloud.get_conf_value("smtp.server").then(function(a){return a&&RCloud.UI.settings_frame.add({"subscribe-to-comments":RCloud.UI.settings_frame.checkbox({sort:5e3,default_value:!1,label:"Subscribe To Comments",condition:function(){}})}),Promise.all([rcloud.protection.has_notebook_protection(),RCloud.UI.panel_loader.load()]).spread(function(a,b){if(a){var c=RCloud.UI.menus.get("advanced_menu");c.menu.add({manage_groups:{sort:7e3,text:"Manage Groups",modes:["edit"],action:function(a){RCloud.UI.notebook_protection.init("group-tab-enabled")}}})}return RCloud.UI.left_panel.init(),RCloud.UI.middle_column.init(),RCloud.UI.right_panel.init(),RCloud.UI.command_prompt.init(),$(".panel-collapse").collapse({toggle:!1}),Promise.all([RCloud.UI.navbar.load(),RCloud.UI.menus.load(),RCloud.UI.shortcut_manager.load(),RCloud.UI.share_button.load(),RCloud.UI.left_panel.load_options(),RCloud.UI.right_panel.load_options()])})})},RCloud.UI.menu=function(){var a,b;return{filter_mode:function(a){return function(b){return b.modes.indexOf(a)>=0}},mode_sections:function(b){return arguments.length?(a=b,this):(a||(a={view:{filter:RCloud.UI.menu.filter_mode("view")},edit:{filter:RCloud.UI.menu.filter_mode("edit")}}),a)},ui_mode:function(a){return arguments.length?(b=a,this):b||(shell.is_view_mode()?"view":"edit")},create:function(){var a;return{init:function(){a=RCloud.extension.create({sections:RCloud.UI.menu.mode_sections()})},add:function(b){return a&&a.add(b),this},remove:function(b){return a.remove(b),this},check:function(b,c){var d=a.get(b);if(!d||!d.checkbox||!d.checkbox_widget)throw new Error("menu check fail on "+b);return d.checkbox_widget.set_state(c),this},enable:function(b,c){var d=a.get(b);if(!d||!d.$li)throw new Error("menu disable fail on "+b);return c?d.$li.find("a").removeAttr("title"):d.disabled_reason&&d.$li.find("a").attr("title",d.disabled_reason),d.disabled=!c,d.$li.toggleClass("disabled",!c),this},create_checkbox:function(a){var b=$.el.li($.el.a({href:"#",id:a.key},$.el.i({"class":"icon-check"}),"Â ",a.text));return a.checkbox_widget=ui_utils.checkbox_menu_item($(b),function(){a.disabled||a.action(!0)},function(){a.disabled||a.action(!1)}),a.value&&a.checkbox_widget.set_state(a.value),b},create_link:function(a){var b=$.el.li($.el.a({href:"#",id:a.key},a.text));return b},create:function(b){var c=this,d=$('<ul class="dropdown-menu"></ul>');b.append(d);var e=a.entries(RCloud.UI.menu.ui_mode());return d.append($(e.map(function(a){var b;return b=a.checkbox?c.create_checkbox(a):c.create_link(a),a.disabled&&c.enable(a,!1),a.$li=$(b),b}))),d.find("li a").click(function(){var b=a.get(this.id);if(!b)throw new Error("bad id in advanced menu");b.checkbox||b.disabled||b.action()}),this}}}}}(),RCloud.UI.menus=function(){var a;return{init:function(){a=RCloud.extension.create({sections:RCloud.UI.menu.mode_sections()}),this.add({discover_divider:{sort:7e3,type:"divider",modes:["edit"]},discover:{sort:8e3,type:"link",href:"/discover.html",text:"Discover",target:"_blank",modes:["edit"]},logout_divider:{sort:1e4,type:"divider",modes:["edit"]},logout:{sort:12e3,type:"link",href:"/logout.R",text:"Logout",modes:["edit"]}})},add:function(b){return a.add(b),this},remove:function(b){return a.remove(b),this},get:function(b){return a.get(b)},create_menu:function(a){var b=$.el.li({"class":"dropdown"},$.el.a({href:"#","class":"dropdown-toggle","data-toggle":"dropdown"},a.title+" ",$.el.b({"class":"caret"})));return a.menu.create($(b)),b},create_link:function(a){var b={href:a.href};a.target&&(b.target=a.target);var c=$.el.li($.el.a(b,a.text));return c},create_divider:function(a){return $.el.li({"class":"divider-vertical"})},load:function(b){var c=this,d=$("#rcloud-navbar-menu");return rcloud.get_conf_values("^rcloud\\.menu\\..*").then(function(b){b=_.omit(b,"r_type","r_attributes");var e={};for(var f in b){var g=b[f].split(/ *, */),h=f.split(".");if(3!=h.length)throw new Error("submenus not supported yet - invalid menu key "+f);var i=+g[0],j=g[1].split(/ *\| */),k=g[2],l=g[3],m=g[4],n=g[5]||"_blank";if(isNaN(i))throw new Error("bad sort value "+g[0]+" in menu key "+f);var o;switch(k){case"link":o={sort:i,modes:j,type:k,text:l,href:m,target:n};break;case"divider":o={sort:i,modes:j,type:k};break;default:throw new Error("invalid menu type "+k+" in menu key "+f)}e[h[2]]=o}c.add(e);var p=a.entries(RCloud.UI.menu.ui_mode()),q=$(p.map(function(a){switch(a.type){case"divider":return c.create_divider();case"menu":return c.create_menu(a);case"link":return c.create_link(a);default:throw new Error("unknown navbar menu entry type "+a.type)}}));d.append(q)})}}}(),function(){var a,b;RCloud.UI.message_dialog=function(c,d,e){if($("#loading-animation").hide(),_.isUndefined(a)){var f=$("<button type='submit' class='btn btn-primary' style='float:right'>OK</span>"),g=$("<div />").append($("<h1 />").append(c));b=$('<p style="white-space: pre-wrap">'+d+"</p>"),g.append(b,f),g.append('<div style="clear: both;"></div>'),f.click(function(b){b.preventDefault(),a.modal("hide")}),a=$('<div id="message-dialog" class="modal fade" />').append($('<div class="modal-dialog" />').append($('<div class="modal-content" />').append($('<div class="modal-body" />').append(g)))),$("body").append(a),a.on("shown.bs.modal",function(){f.focus()})}else b.text(d);a.off("hidden.bs.modal").on("hidden.bs.modal",function(){e()}),a.modal({keyboard:!0})}}(),RCloud.UI.middle_column=function(){var a=RCloud.UI.column("#middle-column");return _.extend(a,{update:function(){var b=12-RCloud.UI.left_panel.colwidth()-RCloud.UI.right_panel.colwidth();a.colwidth(b),shell.notebook.view.reformat()}}),a}(),RCloud.UI.navbar=function(){var a,b,c={create_button:function(a,b,c){var d=$.el.button({id:a,title:b,type:"button","class":"btn btn-link navbar-btn"},$.el.i({"class":c})),e=$(d);return{control:d,click:function(a){return $(d).click(a),this},hide:function(){return e.hide(),this},show:function(){return e.show(),this},disable:function(){return ui_utils.disable_bs_button(e),this},enable:function(){return ui_utils.enable_bs_button(e),this},display:function(a,b){return $(d).find("i").removeClass().addClass(b),$(d).attr("title",a),this}}},create_highlight_button:function(a,b,c){var d=this.create_button(a,b,c);return d.control=$.el.span($.el.span({"class":"button-highlight"}),d.control),d.highlight=function(a){return $(d.control).find(".button-highlight").animate({opacity:a?1:0},{duration:250,queue:!1}),this},d},init:function(){var b=$("#rcloud-navbar-header");b.empty().append('<a class="navbar-brand" href="/edit.html">RCloud</a>');var c=RCloud.extension.filter_field("area","commands"),d=RCloud.UI.menu.filter_mode("view"),e=RCloud.UI.menu.filter_mode("edit");a=RCloud.extension.create({sections:{header:{filter:RCloud.extension.filter_field("area","header")},view_commands:{filter:function(a){return c(a)&&d(a)}},edit_commands:{filter:function(a){return c(a)&&e(a)}}}}),this.add({shareable_link:{area:"commands",sort:1e3,modes:["edit"],create:function(){var a,b;return{control:$.el.span(a=$.el.a({href:"#",id:"share-link",title:"Shareable Link","class":"btn btn-link navbar-btn",style:"text-decoration:none; padding-right: 0px",target:"_blank"},$.el.i({"class":"icon-share"})),$.el.span({"class":"dropdown",style:"position: relative; margin-left: -2px; padding-right: 12px"},$.el.a({href:"#","class":"dropdown-toggle","data-toggle":"dropdown",id:"view-mode"},$.el.b({"class":"caret"})),b=$.el.ul({"class":"dropdown-menu view-menu",id:"view-type"}))),set_url:function(b){return a&&$(a).attr("href",b),this},set_view_types:function(a){$(b).append($(a.map(function(a){var b=$.el.a({href:"#"},a.title);return $(b).click(a.handler),$.el.li(b)})))}}}},star_notebook:{area:"commands",sort:2e3,modes:["edit"],create:function(){var a,b,c,d,e=$.el.button({id:"star-notebook",title:"Star Notebook",type:"button","class":"btn btn-link navbar-btn",style:"padding-left: 3px"},$.el.i({"class":"icon-star-empty"}),$.el.sub(d=$.el.span({id:"curr-star-count"})));return c=ui_utils.twostate_icon($(e),function(){a()},function(){b()},"icon-star","icon-star-empty"),{control:e,set_star_unstar:function(c,d){return a=c,b=d,this},set_fill:function(a){return c.set_state(a),$(this.control).attr("title",a?"Unstar Notebook":"Star Notebook"),this},set_count:function(a){return $(d).text(a),this}}}},fork_notebook:{area:"commands",sort:3e3,modes:["edit"],create:function(){var a=RCloud.UI.navbar.create_button("fork-notebook","Fork","icon-code-fork");return $(a.control).click(function(){var a=shell.notebook.controller.is_mine(),b=shell.gistname(),c=shell.version();editor.fork_notebook(a,b,c)}),a}},save_notebook:{area:"commands",sort:4e3,modes:["edit"],create:function(){var a=RCloud.UI.navbar.create_button("save-notebook","Save","icon-save");return $(a.control).click(function(){shell.save_notebook()}),a.disable(),a}},revert_notebook:{area:"commands",sort:5e3,modes:["edit"],create:function(){var a=RCloud.UI.navbar.create_button("revert-notebook","Revert","icon-undo");return $(a.control).click(function(){var a=shell.notebook.controller.is_mine(),b=shell.gistname(),c=shell.version();editor.revert_notebook(a,b,c)}),a}},edit_notebook:{area:"commands",sort:1e3,modes:["view"],create:function(){var a=RCloud.UI.navbar.create_button("edit-notebook","Edit Notebook","icon-edit");return $(a.control).click(function(){window.location="edit.html?notebook="+shell.gistname()}),a}},run_notebook:{area:"commands",sort:6e3,modes:["edit","view"],create:function(){var a=RCloud.UI.navbar.create_highlight_button("run-notebook","Run All","icon-play");return $(a.control).click(function(){RCloud.UI.run_button.run()}),a}}})},add:function(b){return a&&a.add(b),this},remove:function(b){return a&&a.remove(b),this},get:function(b){return a?a.get(b):null},control:function(a){return b?b[a]:null},load:function(){if(a){var c=a.create("header").array,d=$("#rcloud-navbar-header");c.length&&d.empty().append.apply(d,c);var e=RCloud.UI.menu.ui_mode()+"_commands",f=a.create(e),g=$("#rcloud-navbar-main");f.array.length&&g.prepend.apply(g,f.array.map(function(a){return $.el.li(a.control)})),b=f.map}return Promise.resolve(void 0)}};return c}(),RCloud.UI.notebook_commands=function(){function a(a,b,c){c.forEach(function(c){b.append(document.createTextNode(String.fromCharCode(160))),b.append(c.create(a))})}function b(a){return function(b){return _.every(["condition0","condition1","condition2"],function(c){return!b[c]||b[c](a)})}}var c,d,e={"line-height":"90%"},f=_.extend({"font-size":"80%"},e),g={"true":{"class":"icon-star",title:"unstar"},"false":{"class":"icon-star-empty",title:"star"}},h={},i={condition0:function(a){return a.gistname&&!a.version},condition1:function(a){return!0}},j={init:function(){return this.add({star_unstar:{section:"always",sort:1e3,create:function(a){var b=editor.i_starred(a.gistname),c=ui_utils.fa_button(g[b]["class"],function(a){return g[b].title},"star",f,!0);return c.click(function(c){c.preventDefault(),c.stopPropagation(),ui_utils.kill_popovers();var d=!b;editor.star_notebook(d,{gistname:a.gistname,user:a.user})}),c[0].set_state=function(a){b=!!a,$(this).find("i").attr("class",g[b]["class"])},c.append($.el.sub(String(editor.num_stars(a.gistname)))),c}},history:{section:"appear",sort:2e3,create:function(a){var b=editor.current(),c=b.notebook===a.gistname&&b.version,d=ui_utils.fa_button("icon-time","history","history",e,!0);return c&&d.addClass("button-disabled"),d.click(function(){return ui_utils.kill_popovers(),ui_utils.fake_hover(a),c||editor.show_history(a,!0),!1}),d}},visibility:{section:"appear",sort:3e3,condition1:function(a){return a.user===editor.username()},create:function(a){var b=ui_utils.fa_button("icon-eye-close","hide notebook","hidden-notebook",e,!0),c=ui_utils.fa_button("icon-eye-open","show notebook","shown-notebook",e,!0);return a.visible?c.hide():b.hide(),b.click(function(){if(ui_utils.fake_hover(a),a.user!==editor.username())throw new Error("attempt to set visibility on notebook not mine");editor.set_notebook_visibility(a.gistname,!1)}),c.click(function(){if(ui_utils.fake_hover(a),a.user!==editor.username())throw new Error("attempt to set visibility on notebook not mine");return editor.set_notebook_visibility(a.gistname,!0),!1}),b.add(c)}},remove:{section:"appear",sort:4e3,condition1:function(a){return a.user===editor.username()},create:function(a){var b=ui_utils.fa_button("icon-remove","remove","remove",e,!0);return b.click(function(b){$("div.popover").remove();var c=confirm("Do you want to remove '"+a.full_name+"'?");return c&&(b.stopPropagation(),b.preventDefault(),editor.remove_notebook(a.user,a.gistname)),!1}),b}},fork_folder:{section:"appear",sort:1e3,condition0:function(a){return a.full_name&&!a.gistname},create:function(a){var b=ui_utils.fa_button("icon-code-fork","fork","fork",e,!0);return b.click(function(b){var c=a.full_name,d=new RegExp("^"+c);editor.find_next_copy_name(c).then(function(b){editor.fork_folder(a,d,b)})}),b}},remove_folder:{section:"appear",sort:2e3,condition0:function(a){return a.full_name&&!a.gistname&&a.user===editor.username()},create:function(a){var b=ui_utils.fa_button("icon-remove","remove folder","remove",e,!0),c=[];return b.click(function(b){editor.for_each_notebook(a,null,function(a){c.push(a.full_name)});var d=confirm("Do you want to remove ALL the following notebooks?\n"+c.join("\n"));if(d){var e=[];editor.for_each_notebook(a,null,function(a){e.push(editor.remove_notebook(a.user,a.gistname))})}return!1}),b}}}),this},add:function(a){for(var b in a)h[b]=_.extend(_.extend({},i),a[b]);return c=_.filter(h,function(a){return"always"===a.section}),d=_.filter(h,function(a){return"appear"===a.section}),[c,d].forEach(function(a){a.sort(function(a,b){return a.sort-b.sort})}),this},remove:function(a){return delete h[a],this},icon_style:function(){return e},decorate:function(e,f,g){function h(a){a.on("mousedown mouseup click",function(a){a.stopPropagation()})}function i(){var b=c.filter(m);if(b.length){var d=$($.el.span({"class":"notebook-commands-right"}));h(d),a(f,d,b),l.append(d)}}function j(){var b=d.filter(m);if(b.length){var c=$($.el.span({"class":"notebook-commands appear"}));h(c),a(f,c,b),l.append(c),l.find(".notebook-date").toggleClass("disappear",!0),c.hide(),l.append($.el.span({"class":"notebook-commands appear-wrapper"},c[0]))}k=!0}var k,l=$(g),m=b(f);return i(),e.find("div.jqtree-element").hover(function(){k||j();editor.get_notebook_info(f.gistname);$(".notebook-commands.appear",this).show(),$(".notebook-date.disappear",this).css("visibility","hidden")},function(){$(".notebook-commands.appear",this).hide(),$(".notebook-date.disappear",this).css("visibility","visible")}),this}};return j}(),RCloud.UI.selection_bar=function(){var a,b,c,d,e,f,g,h,i,j=function(){b.prop("checked",!1),a.hide()},k={init:function(){var j=$(RCloud.UI.panel_loader.load_snippet("selection-bar-snippet"));a=j.find(".cell-selection span"),b=j.find('.cell-selection input[type="checkbox"]'),c=j.find(".dropdown-toggle"),d=j.find("#selection-bar-delete"),e=j.find("#selection-bar-crop"),f=j.find(".cell-selection"),g=d.find("span"),h=j.find("#selected-count"),i=j.find("#cell-count"),j.find('.btn-default input[type="checkbox"]').click(function(a){return a.stopPropagation(),shell.notebook.controller.cell_count()?void($(this).is(":checked")?shell.notebook.controller.select_all_cells():shell.notebook.controller.clear_all_selected_cells()):void a.preventDefault()}).end().find("a[data-action]").click(function(){shell.notebook.controller[$(this).attr("data-action")]()}).end().find("#selection-bar-delete").click(function(){shell.notebook.controller.remove_selected_cells()}).end().find("#selection-bar-crop").click(function(){shell.notebook.controller.crop_cells()}).end(),j.find('div[type="button"].cell-selection').click(function(a){$(this).find("input").trigger("click")}),$("#"+j.attr("id")).replaceWith(j)},update:function(j){var k=j.length,l=shell.notebook.controller.selected_count();b.prop({checked:l===k&&0!=k,disabled:0===k}),_.each([c,f],function(a){a[k?"removeClass":"addClass"]("disabled")}),a[l!==k&&0!==l?"show":"hide"](),d[l?"removeClass":"addClass"]("disabled"),e[shell.notebook.controller.can_crop_cells()?"removeClass":"addClass"]("disabled"),h.text(l),i.text(k),g[0!==l?"show":"hide"]()},hide:function(){$("#selection-bar").hide(),j()},show:function(){$("#selection-bar").show(),j()}};return k}(),RCloud.UI.notebook_title=function(){function a(a){return function(b){return editor.tag_version(a.gistname,a.version,b).then(function(){return editor.show_history(a.parent,{update:!0})})}}function b(a){return editor.rename_notebook(a).then(function(){i.set(a)})}function c(a){return function(c){editor.for_each_notebook(a,c,function(a,c){a.gistname===shell.gistname()?b(c):rcloud.update_notebook(a.gistname,{description:c},!1).then(function(a){editor.update_notebook_from_gist(a)})},function(a,b){return b+"/"+a.name})}}function d(a){return function(b){var c=new RegExp("^"+a.full_name);editor.fork_folder(a,c,b)}}function e(a){if(1!==a.childNodes.length||a.firstChild.nodeType!=a.TEXT_NODE)throw new Error("expecting simple element with child text");var b=a.firstChild.textContent,c=document.createRange();return c.setStart(a.firstChild,b.lastIndexOf("/")+1),c.setEnd(a.firstChild,b.length),c}var f=null,g=function(a,c){var d=shell.notebook.controller.is_mine(),e=shell.gistname(),f=shell.version();editor.fork_notebook(d,e,f).then(function(d){return c?b(a):void 0})},h={change:b,select:e,ctrl_cmd:g,validate:function(a){return editor.validate_name(a)}},i={set:function(a){function b(a){return d3.sum($(a).map(function(a,b){return $(b).width()}))}$("#notebook-author").text(shell.notebook.model.user()),$("#author-title-dash").show(),$("#rename-notebook").show(),$("#loading-animation").hide();var c=shell.notebook.model.read_only(),d=a,e=!1,f=!1,g=$("#notebook-title"),i=$("#rcloud-navbar-header").width()+b("#rcloud-navbar-menu li")+50;for(g.text(a);a.length>10&&window.innerWidth<i+b("#rcloud-navbar-main");){var j=a.search("/");j>=0?(e=!0,a=a.slice(j+1)):(f=!0,a=a.substr(0,a.length-5)),g.text((e?".../":"")+a+(f?"...":""))}ui_utils.editable(g,$.extend({allow_edit:!c&&!shell.is_view_mode(),inactive_text:g.text(),active_text:d},h))},update_fork_info:function(a){if(a&&a.description){var b=a.owner?a.owner:a.user,c=b.login+" / "+a.description,d=ui_utils.make_url(shell.is_view_mode()?"view.html":"edit.html",{notebook:a.id});$("#forked-from-desc").html("forked from <a href='"+d+"'>"+c+"</a>")}else $("#forked-from-desc").text("")},make_editable:function(b,e,g){function i(a,b){return $("> div > .jqtree-title",b)}if(f&&(!b||b.gistname&&f!==b)&&ui_utils.editable(i(f,f.element),"destroy"),b){var j=h;b.version?j=$.extend({},h,{change:a(b),validate:function(a){return!0}}):b.gistname||(j=$.extend({},h,{change:c(b),ctrl_cmd:d(b),validate:function(a){return editor.validate_name(a)}})),ui_utils.editable(i(b,e),$.extend({allow_edit:g,inactive_text:b.name,active_text:b.version?b.name:b.full_name},j))}b&&b.gistname&&(f=b)}};return i}(),RCloud.UI.notebooks_frame={body:function(){return RCloud.UI.panel_loader.load_snippet("notebooks-snippet")},heading_content:function(){var a=RCloud.UI.panel_loader.load_snippet("notebooks-panel-heading");return a},heading_content_selector:function(){return $("#notebooks-panel-controls")}},RCloud.UI.output_context=function(){function a(a){function b(a){function b(a){switch(a){case"code":return function(a){return $.el.pre($.el.code(a))};case"error":return function(a){return $('<code style="color: crimson"></code>').append(a)};case"html":return function(a){
return a};default:throw new Error("unknown output type "+a)}}var d=b(a);return function(a){c.append(d(a))}}var c=$(a);return{end:function(){console.log("not expecting end on custom output context")},out:b("code"),err:b("error"),msg:b("code"),html_out:b("html"),selection_out:b("html"),deferred_result:null,"in":null}}return{create:function(b){var c=a(b),d=RCloud.register_output_context(c);return d},close:function(a){RCloud.unregister_output_context(a)}}}(),RCloud.UI.panel_loader=function(){function a(a){return"collapse-"+a}function b(b){var c,d="accordion-"+b.side,e=a(b.name),f={"class":"panel-heading clearfix","data-toggle":"collapse","data-parent":"#"+d,"data-target":"#"+e},g=$.el.span({"class":"title-offset"},b.title),h=$.el.i({"class":b.icon_class}),i=$.el.a({"class":"accordion-toggle "+b.side,href:"#"+e},h,"Â ",g),j=b.panel.heading_content?b.panel.heading_content():null;if("left"===b.side)c=$.el.div(f,i,j);else{if("right"!==b.side)throw new Error("Unknown panel side "+b.side);c=$.el.div(f,j,i)}var k={id:e,"class":"panel-collapse collapse","data-colwidth":b.colwidth};b.greedy&&(k["data-widgetheight"]="greedy");var l=$.el.div(k,$.el.img({height:"100%",width:"5px",src:"left"===b.side?"/img/right_bordergray.png":"/img/left_bordergray.png","class":"panel-shadow "+b.side}),b.panel.body()),m=$.el.div({"class":"panel panel-default"},c,l);$("#"+d).append(m)}function c(a){for(var b="accordion-"+a,c=$("<div/>",{"class":"panel-body",style:"border-top-color: transparent; background-color: #777"}),d=0;60>d;++d)c.append($.el.br());var e=$.el.div({"class":"panel-collapse out"},c[0]),f=$.el.div({"class":"panel panel-default"},e);$("#"+b).append(f)}var d,e={},f={};return{init:function(){d=RCloud.extension.create({sections:{left:{filter:function(a){return"left"===a.side}},right:{filter:function(a){return"right"===a.side}}}}),e={Notebooks:{side:"left",name:"notebook-tree",title:"Notebooks",icon_class:"icon-folder-open",colwidth:3,greedy:!0,sort:1e3,panel:RCloud.UI.notebooks_frame},"File Upload":{side:"left",name:"file-upload",title:"File Upload",icon_class:"icon-upload-alt",colwidth:2,sort:2e3,panel:RCloud.UI.upload_frame},Settings:{side:"left",name:"settings",title:"Settings",icon_class:"icon-cog",colwidth:3,sort:3e3,panel:RCloud.UI.settings_frame},Comments:{side:"left",name:"comments",title:"Comments",icon_class:"icon-comments",colwidth:2,sort:4e3,panel:RCloud.UI.comments_frame},Assets:{side:"right",name:"assets",title:"Assets",icon_class:"icon-copy",colwidth:4,sort:1e3,panel:RCloud.UI.scratchpad},Search:{side:"right",name:"search",title:"Search",icon_class:"icon-search",colwidth:4,sort:2e3,panel:RCloud.UI.search},Help:{side:"right",name:"help",title:"Help",icon_class:"icon-question",colwidth:5,sort:3e3,panel:RCloud.UI.help_frame},Session:{side:"right",name:"session-info",title:"Session",icon_class:"icon-info",colwidth:3,sort:4e3,panel:RCloud.UI.session_pane}}},add:function(a){d&&d.add(a)},remove:function(a){return d.remove(a),this},load_snippet:function(a){return $($("#"+a).html())[0]},load:function(){function g(e,f){function g(c){b(c),c.panel.init&&c.panel.init(),c.panel.load&&c.panel.load(),c.panel.panel_sizer&&$("#"+a(c.name)).data("panel-sizer",c.panel.panel_sizer),c.panel.heading_content_selector&&$("#"+a(c.name)).data("heading-content-selector",c.panel.heading_content_selector())}var h=d.entries(f);h.forEach(g),c(f)}var h=this;return rcloud.config.get_user_option("panel-layout-by-size").then(function(a){if(null===a&&(a=!0),!a){var b=function(a,b,c){e[a].side=b,e[a].sort=c};_.each(["Notebooks","Search","Settings","Help"],function(a,c){b(a,"left",1e3*(c+1))}),_.each(["Assets","File Upload","Comments","Session"],function(a,c){b(a,"right",1e3*(c+1))})}return h.add(e),g(f,"left"),g(f,"right"),$("#left-column").append(h.load_snippet("left-pane-collapser-snippet")),$("#right-column").append(h.load_snippet("right-pane-collapser-snippet")),Promise.cast(void 0)})}}}(),function(){function a(){h||(h=!0,_.isUndefined(e)&&(e=$('<div id="progress-dialog" class="modal fade"><div class="modal-dialog"><div class="modal-content"><div class="modal-body">Please wait...</div></div></div>'),$("body").append(e),e.on("hide.bs.modal",function(){f=0,d()})),e.modal({keyboard:!0}))}function b(){h&&(h=!1,e.modal("hide"))}function c(){_.delay(function(){document.body.style.cursor="wait"},0)}function d(){_.delay(function(){document.body.style.cursor=""},0)}var e,f=0,g=1,h=!1;RCloud.UI.with_progress=function(e,h){function i(){f-=1,0===f&&(d(),b())}return _.isUndefined(h)&&(h=2e3),c(),_.delay(function(){f>0&&g>0&&a()},h),f+=1,Promise.resolve(i).then(e).then(function(a){return i(),a})["catch"](function(a){throw i(),a})},RCloud.UI.prevent_progress_modal=function(){1===g&&f>0&&(d(),b()),g-=1},RCloud.UI.allow_progress_modal=function(){0===g&&f>0&&(c(),a()),g+=1}}(),RCloud.UI.right_panel=RCloud.UI.collapsible_column("#right-column","#accordion-right","#right-pane-collapser"),RCloud.UI.run_button=function(){function a(a,b){RCloud.UI.navbar.control("run_notebook").display(a,b)}function b(a){RCloud.UI.navbar.control("run_notebook").highlight(a)}function c(){if(0===g.length)return e=!1,d=!1,a("Run All","icon-play"),b(!1),Promise.resolve(void 0);d=!0;var f=g.shift();return a("Stop","icon-stop"),b(!0),f().then(function(){if(e)throw e=!1,"stop";return h.shift(),c()})}var d=!1,e=!1,f=!1,g=[],h=[];return{init:function(){var a=this;RCloud.session.listeners.push({on_reset:function(){a.on_stopped()}})},run:function(){d?this.stop():(f?RCloud.session.reset().then(function(){return rcloud.load_notebook(shell.gistname(),shell.version())}):Promise.resolve(void 0)).then(function(){shell.run_notebook()})},stop:function(){rcloud.has_compute_separation?rcloud.signal_to_compute(2):e=!0},on_stopped:function(){h.forEach(function(a){a()}),g=[],h=[],d=!1,a("Run All","icon-play"),b(!1)},reset_on_run:function(a){return arguments.length?(f=a,this):f},enqueue:function(a,b){var e=this;g.push(a),h.push(b||function(){}),d||c()["catch"](function(a){if("stop"===a)h.shift(),e.on_stopped();else if(console.log(a),e.on_stopped(),!/^ERROR FROM R SERVER: 127/.test(a))throw a})}}}(),RCloud.UI.scratchpad=function(){var a;return{session:null,widget:null,exists:!1,current_model:null,change_content:null,body:function(){return RCloud.UI.panel_loader.load_snippet("assets-snippet")},init:function(){function a(a){var b=$("<div></div>"),d=$("<div style='clear:both;'></div>");a.append(b),a.append(d);var e=$('<div style="width:100%; height:100%"></div>');e.css({"background-color":"#f1f1f1"}),b.append(e),ace.require("ace/ext/language_tools");var f=ace.edit(e[0]),g=ace.require("ace/mode/r").Mode,h=f.getSession();c.session=h,c.widget=f;var i=h.doc;h.on("change",function(){f.resize()}),f.setOptions({enableBasicAutocompletion:!0}),f.commands.addCommands([{name:"blurCell",bindKey:{win:"Escape",mac:"Escape"},exec:function(){c.widget.blur()}}]),h.setMode(new g(!1,i,h)),h.setUseWrapMode(!0),f.resize(),ui_utils.on_next_tick(function(){h.getUndoManager().reset(),f.resize()}),c.change_content=ui_utils.ignore_programmatic_changes(c.widget,function(){c.current_model&&c.current_model.parent_model.on_dirty()}),ui_utils.install_common_ace_key_bindings(f,function(){return c.current_model.language()}),$("#collapse-assets").on("shown.bs.collapse panel-resize",function(){f.resize()}),RCloud.UI.thumb_dialog.init(),$("#update-thumb").click(RCloud.UI.scratchpad.update_thumb)}function b(){var a;$(document).on("dragstart dragenter dragover",function(b){if(!RCloud.UI.thumb_dialog.is_visible()){var c=b.originalEvent.dataTransfer;c&&null!==c.types&&(c.types.indexOf?-1!=c.types.indexOf("Files")&&-1==c.types.indexOf("text/html"):c.types.contains("application/x-moz-file"))&&(shell.notebook.model.read_only()?(b.stopPropagation(),b.preventDefault()):(b.stopPropagation(),b.preventDefault(),$("#asset-drop-overlay").css({display:"block"}),a=!0))}}),$(document).on("drop dragleave",function(b){b.stopPropagation(),b.preventDefault(),a=!1,setTimeout(function(){a||$("#asset-drop-overlay").css({display:"none"})},100)}),$("#scratchpad-wrapper").bind({drop:function(a){a=a.originalEvent||a;var b=a.files||a.dataTransfer.files;a.dataTransfer;shell.notebook.model.read_only()||RCloud.UI.upload_with_alerts(!0,{files:b})["catch"](function(){}),$("#asset-drop-overlay").css({display:"none"})},"dragenter dragover":function(a){var b=a.originalEvent.dataTransfer;shell.notebook.model.read_only()||(b.dropEffect="copy")}})}var c=this,d=$("#scratchpad-editor");d.length&&(this.exists=!0,a(d),b()),$("#new-asset > a").click(function(){var a=prompt("Choose a filename for your asset");if(a&&(a=a.trim())){if(Notebook.is_part_name(a))return void alert("Asset names cannot start with 'part[0-9]', sorry!");var b=shell.notebook.model.get_asset(a);if(b)b.controller.select();else{var c=function(a,b){switch(b){case"css":return"/* "+a+" */\n";case"js":return"// "+a+"\n";case"html":return"<!-- "+a+" -->\n";default:return"# "+a+"\n"}},d=-1!=a.indexOf(".")?a.match(/\.(.*)/)[1]:"";shell.notebook.controller.append_asset(c("New file "+a,d),a).spread(function(a,b){b.select(),ui_utils.ace_set_pos(RCloud.UI.scratchpad.widget,2,1)})}}})},panel_sizer:function(a){return{padding:RCloud.UI.collapsible_column.default_padder(a),height:9e3}},set_model:function(b){var c=this;if(this.exists){if(this.current_model&&!a&&(this.current_model.cursor_position(this.widget.getCursorPosition()),this.current_model.content(this.widget.getValue())&&this.current_model.parent_model.controller.update_asset(this.current_model)),this.current_model=b,!this.current_model)return $("#scratchpad-binary").hide(),$("#scratchpad-editor").show(),c.change_content(""),c.widget.resize(),c.widget.setReadOnly(!0),$("#scratchpad-editor > *").hide(),void $("#asset-link").hide();this.update_asset_url(),$("#asset-link").show();var d=this.current_model.content();if(Notebook.is_binary_content(d)){a=!0,$("#scratchpad-editor").hide();var e=$("#scratchpad-binary"),f=this.current_model.filename().substr(this.current_model.filename().lastIndexOf(".")+1);-1!==["bmp","jpg","jpeg","png","gif"].indexOf(f.toLowerCase())?(e.html('<div><img src="'+this.current_model.asset_url(!0)+'"/></div>"'),e.find("div").removeClass("embed")):"pdf"===f.toLowerCase()?(e.html('<div><object><embed type="application/pdf" src="'+this.current_model.asset_url(!0)+'" /></object></div>'),e.find("div").addClass("embed")):(e.html("<div><p>Preview not supported for this file type</p></div>"),e.find("div").removeClass("embed")),e.show()}else{a=!1,c.widget.setReadOnly(shell.notebook.model.read_only()),$("#scratchpad-binary").hide(),$("#scratchpad-editor").show(),$("#scratchpad-editor > *").show(),this.change_content(d);var g=b.cursor_position();g?ui_utils.ace_set_pos(this.widget,g):ui_utils.ace_set_pos(this.widget,0,0),ui_utils.on_next_tick(function(){c.session.getUndoManager().reset()}),c.language_updated(),c.widget.resize(),c.widget.focus()}}},update_model:function(){return this.current_model&&!a?this.current_model.content(this.widget.getSession().getValue()):null},content_updated:function(){var b=!1;if(b=this.current_model.content(),a=Notebook.is_binary_content(b),b&&!a){var c=this.widget.getSelection().getRange();this.change_content(b),this.widget.getSelection().setSelectionRange(c)}return b},language_updated:function(){if(!a){var b=this.current_model.language(),c=ace.require(RCloud.language.ace_mode(b)).Mode;this.session.setMode(new c(!1,this.session.doc,this.session))}},set_readonly:function(b){shell.is_view_mode()||(this.widget&&!a&&ui_utils.set_ace_readonly(this.widget,b),$("#new-asset, #update-thumb")[b?"hide":"show"]())},update_asset_url:function(){this.current_model&&$("#asset-link").attr("href",this.current_model.asset_url())},update_thumb:function(){var a=shell.notebook.model.get_asset("thumb.png");a&&a.controller.select(),RCloud.UI.thumb_dialog.show()},clear:function(){this.exists&&(this.change_content(""),this.session.getUndoManager().reset(),this.widget.resize())}}}(),RCloud.UI.search=function(){function a(a,b){var c=parseInt(a)*parseInt(b),d=parseInt(c)+parseInt(b),e=$("#input-text-search").val(),f=$("#sort-by option:selected").val(),g=$("#order-by option:selected").val();$("#input-text-search").blur(),""!==$("#input-text-search").val()&&RCloud.UI.search.exec(e,f,g,c,d,!0)}function b(){return $("#sort-by option:selected").val()}function c(){return $("#order-by option:selected").val()}function d(){return $("#all-sources").is(":checked")}function e(){var a;switch(b()){case"starcount":case"updated_at":a="desc";break;case"user":case"description":a="asc"}$("#order-by").val(a)}var f=10,g=['<p style="color:black;margin:0;">The search engine in RCloud uses Lucene for advanced search features.',"It appears you may have used one of the special characters in Lucene syntax incorrectly. ",'Please see this <a target="_blank" href="http://lucene.apache.org/core/4_10_0/queryparser/org/apache/lucene/queryparser/classic/package-summary.html#Terms">link</a> to learn about Lucene syntax. ','</p><p style="color:black;margin:0;">Or, if you mean to search for the character itself, escape it using a backslash, e.g. "foo\\:"</p>'];return{body:function(){return RCloud.UI.panel_loader.load_snippet("search-snippet")},init:function(){if(rcloud.search){$("#search-form").submit(function(b){return a(),!1}),rcloud.get_gist_sources().then(function(a){_.isString(a)&&(a=[a]),a.length<2?$("#all-sources").parent().hide():$("#all-sources").change(function(a){var b=d();rcloud.config.set_user_option("search-all-sources",b)})}),$("#sort-by").change(function(){rcloud.config.set_user_option("search-sort-by",b()),e(),rcloud.config.set_user_option("search-order-by",c()),a()}),$("#order-by").change(function(){rcloud.config.set_user_option("search-order-by",c()),a()});var a=function(){var a=0,d=$("#input-text-search").val();$("#input-text-search").focus(),""!==$("#input-text-search").val()?RCloud.UI.search.exec(d,b(),c(),a,f):($("#paging").html(""),$("#search-results").html(""),$("#search-summary").html(""))}}else $("#search-wrapper").text("Search engine not enabled on server")},load:function(){return rcloud.config.get_user_option(["search-all-sources","search-results-per-page","search-sort-by","search-order-by"]).then(function(a){$("#all-sources").prop("checked",a["search-all-sources"]),a["search-results-per-page"]&&(f=a["search-results-per-page"]),a["search-sort-by"]||(a["search-sort-by"]="starcount"),$("#sort-by").val(a["search-sort-by"]),a["search-order-by"]?$("#order-by").val(a["search-order-by"]):e()})},panel_sizer:function(a){var b=RCloud.UI.collapsible_column.default_padder(a),c=24+$("#search-summary").height()+$("#search-results").height()+$("#search-results-pagination").height();return c+=40,{height:c,padding:b}},toggle:function(a,b){return $("#"+b).text(function(b,c){var d="";return c.indexOf("Show me more...")>-1?(d="Show me less...",$("#"+a).css("height","auto")):(d="Show me more...",$("#"+a).css("height","150px")),d}),!1},exec:function(b,c,e,h,i,j){function k(a,b){$("#search-summary").css("color",b||"black"),$("#search-summary").show().html($("<h4/>").append(a))}function l(a,b){$("#search-summary").css("display","none"),$("#search-results").css("color",b||"black"),$("#search-results-row").show().animate({scrollTop:$(document).height()},"slow"),$("#search-results").show().html($("<h4/>").append(a))}function m(c){var d,e="";if(null===c||"null"===c||""===c)k("No Results Found");else if("error"===c[0])c[1]=c[1].replace(/\n/g,"<br/>"),""!=$("#paging").html&&$("#paging").html(""),c[1].indexOf("org.apache.solr.search.SyntaxError")>-1&&(e=g.join("")),l(e+"ERROR:\n"+c[1],"darkred");else{for("string"==typeof c&&(c=JSON.parse("["+c+"]")),d=0;d<c.length;d++)"string"==typeof c[d]&&(c[d]=JSON.parse(c[d]));c.sort(function(a,b){var c=+(a.starcount||0),d=+(b.starcount||0);return d-c});var m,n=c.length,o="",p=0,q=0,r=0,s=1,t={};if(void 0!=c[0]){r=q=parseInt(c[0].numFound),_.each(c,function(a){t[a.source]=parseInt(a.numFound)});var u=_.reduce(t,function(a,b){return a+b},0),v=_.max(t);s=Object.keys(t).length,s>1&&(q=u,r=v)}var w=Math.ceil(r/f);for(d=0;n>d;d++)try{p=c[0].QTime,m="undefined"==typeof c[d].starcount?0:c[d].starcount;var x=c[d].id,y=c[d].source,z='<i class="icon-star search-star"><sub>'+m+"</sub></i>";c[d].parts=JSON.parse(c[d].parts);for(var A="",B="",C=0,D=(c[d].parts.length,0),E=0;E<c[d].parts.length&&5>C;E++){B="";var F=Object.keys(c[d].parts[E]);if(F.length>0&&""!==c[d].parts[E].content){var G=c[d].parts[E].content;"string"==typeof G&&(G=[G]),G.length>0&&(A+="<tr><th class='search-result-part-name'>"+c[d].parts[E].filename+"</th></tr>");for(var H=0;H<G.length;H++)if("comments"===c[d].parts[E].filename){var I=G[H].split(/ *::: */);I.length<2&&(I=G[H].split(/ *: */));var J=I[1]||"";if(!J)continue;var K=I[2]||"";B+="<tr><td class='search-result-comment'><span class='search-result-comment-content'>"+K+": "+J+"</span></td></tr>"}else B+="<tr><td class='search-result-code'><code>"+G[H]+"</code></td></tr>";"comments"!=c[d].parts[E].filename&&(D+=B.match(/\|-\|/g).length),C++}""!==B&&(B=B.replace(/\|-\|,/g,"<br>").replace(/\|-\|/g,"<br>"),B=B.replace(/line_no/g,"|"),B="<table style='width: 100%'>"+B+"</table>",A+="<tr><td>"+B+"</td></tr>")}var L=d+"more",M=ui_utils.make_url("edit.html",{notebook:x,source:y});""!==A&&(A=D>10?'<div><div style="height:150px;overflow: hidden;" id=\''+d+"'><table style='width: 100%'>"+A+'</table></div><div style="position: relative;"><a href="#" id=\''+L+"' onclick=\"RCloud.UI.search.toggle("+d+",'"+L+'\');" style="color:orange">Show me more...</a></div></div>':"<div><div id='"+d+"'><table style='width: 100%'>"+A+"</table></div></div>");var N="search-result-heading"+(y?" foreign-notebook":"");o+="<table class='search-result-item' width=100%><tr><td width=10%><a id=\"open_"+d+"\" href='"+M+"'\" data-gistname='"+x+"' data-gistsource='"+y+"' class='"+N+"'>"+c[d].user+" / "+c[d].notebook+"</a>"+z+"<br/><span class='search-result-modified-date'>modified at <i>"+c[d].updated_at+"</i></span></td></tr>",""!==A&&(o+="<tr><td colspan=2 width=100% style='font-size: 12'><div>"+A+"</div></td></tr>"),o+="</table>"}catch(O){k("Error : \n"+O,"darkred")}if(!j&&($("#paging").html(""),$("#search-results-pagination").show(),parseInt(r)-parseInt(f)>0)){var P=w;if($("#current_page").val(0),0!=q){$("#paging").bootpag({total:P,page:1,maxVisible:8}).on("page",function(b,c){a(c-1,f)})}}var Q=decodeURIComponent(b);if(Q=Q.replace(/</g,"&lt;"),Q=Q.replace(/>/g,"&gt;"),0===q)k("No Results Found");else if(parseInt(r)<f)k(q+" Results Found","darkgreen");else{var R=q+" Results Found, showing ";R+=s>1?"page "+Math.round(h/f+1):q-h===1?h+1:q-i>0?h+1+" - "+i:h+1+" - "+q,k(R,"darkgreen")}$("#search-results-row").css("display","table-row"),$("#search-results-scroller").scrollTop(0),$("#search-results").html(o),$("#search-results .search-result-heading").click(function(a){a.preventDefault();var b=$(this).attr("data-gistname"),c=$(this).attr("data-gistsource");return editor.open_notebook(b,null,c,null,a.metaKey||a.ctrlKey),!1})}$("#collapse-search").trigger("size-changed")}k("Searching..."),j||($("#search-results-row").hide(),$("#search-results").html("")),b=encodeURIComponent(b),RCloud.UI.with_progress(function(){return rcloud.search(b,d(),c,e,h,f).then(function(a){m(a)})})}}}(),RCloud.UI.session_pane={error_dest_:null,clear_session_:null,allow_clear:!0,body:function(){return RCloud.UI.panel_loader.load_snippet("session-info-snippet")},init:function(){var a=this;this.error_dest_=$("#session-info"),this.error_dest_.length?this.show_error_area=function(){RCloud.UI.right_panel.collapse($("#collapse-session-info"),!1,!1)}:(this.error_dest_=$("#output"),this.show_error_area=function(){}),RCloud.session.listeners.push({on_reset:function(){a.clear()}}),this.clear_session_=$("#clear-session"),this.clear_session_.length&&this.clear_session_.click(function(b){b.preventDefault(),b.stopPropagation(),a.clear()}),Promise.onPossiblyUnhandledRejection(function(b,c){a.post_rejection(b)})},panel_sizer:function(a){var b=RCloud.UI.collapsible_column.default_sizer(a);return b.height&&(b.height+=20),b},error_dest:function(){return this.error_dest_},clear:function(){this.allow_clear&&$("#session-info").empty()},should_scroll:function(){var a=$("#session-info-panel").scrollTop()+$("#session-info-panel").height()-$("#session-info-out").height();return console.log("scroll bottom",a),a>-10},scroll_to_end:function(){ui_utils.on_next_tick(function(){ui_utils.scroll_to_after($("#session-info"))})},append_text:function(a){if(!$("#session-info").length)return void console.log("session log; ",a);document.getElementById("session-info-out")||$("#session-info").append($("<pre id='session-info-out'></pre>"));var b=this.should_scroll();$("#session-info-out").append(a),RCloud.UI.right_panel.collapse($("#collapse-session-info"),!1,!1),b&&this.scroll_to_end()},post_error:function(a,b,c){if($("#loading-animation").hide(),b=b||this.error_dest_,b&&b.length){var d="session-error";if("string"==typeof a)a=ui_utils.string_error(a),d="session-error spare";else if("object"!=typeof a)throw new Error("post_error expects a string or a jquery div");var e=this.should_scroll();a.addClass(d),b.append(a),this.show_error_area(),e&&this.scroll_to_end()}else"object"==typeof a&&(a=a.text()),RCloud.UI.fatal_dialog(a,"Login",ui_utils.relogin_uri());c||("object"==typeof a&&(a=a.text()),console.log("pre-init post_error: "+a))},post_rejection:function(a){var b="";RCloud.is_exception(a)?b=RCloud.exception_message(a):(!window.chrome&&a.message&&(b+="Error: "+a.message+"\n"),b+=a.stack),console.log(b),this.post_error(b,void 0,!0)},heading_content:function(){return RCloud.UI.panel_loader.load_snippet("session-info-panel-heading")},heading_content_selector:function(){return $("#session-panel-controls")}},RCloud.UI.settings_frame=function(){function a(a,b){try{e[a]=!0,c[a].set(b,d[a])}catch(f){throw f}finally{e[a]=!1}}var b,c={},d={},e={},f={body:function(){return b=$.el.div({id:"settings-body-wrapper","class":"panel-body"},$.el.div({id:"settings-scroller",style:"width: 100%; height: 100%; overflow-x: auto"},$.el.div({id:"settings-body","class":"widget-vsize"})),$.el.span({"class":"settings-reload-msg",style:"display: none"},"Reload to see changes"))},panel_sizer:function(a){var b=RCloud.UI.collapsible_column.default_sizer(a);return{height:b.height+5,padding:b.padding}},show_reload_msg:function(a){a?$(b).find(".settings-reload-msg").show():$(b).find(".settings-reload-msg").hide()},checkbox:function(a){return a=_.extend({sort:1e4,default_value:!1,needs_reload:!1,label:"",id:"",set:function(a){}},a),{sort:a.sort,default_value:a.default_value,create_control:function(b){var c=$.el.input({type:"checkbox"});$(c).prop("id",a.id);var d=$.el.span(a.label),e=$.el.label(c,d),g=$($.el.div({"class":"checkbox"},e));return $(c).change(function(){var c=$(this).prop("checked");b(c),a.needs_reload&&f.show_reload_msg(!0),a.set(c)}),g},set:function(b,c){b=!!b,c.find("input").prop("checked",b),a.set(b)}}},text_input:function(a){return a=_.extend({sort:1e4,default_value:"",needs_reload:!1,label:"",id:"",parse:function(a){return a},format:function(a){return a},set:function(a){}},a),{sort:a.sort,default_value:a.default_value,create_control:function(b){function c(){var c=$(e).val();c!==i.data("original-value")&&(c=a.parse(c),b(c),a.needs_reload&&f.show_reload_msg(!0),a.set(c),c=a.format(c),$(e).val(c),i.data("original-value",c))}function d(){$(e).val(i.data("original-value"))}var e=$.el.input({type:"text","class":"form-control-ext"});$(e).prop("id",a.id);var g=$.el.span(a.label),h=$.el.label(g,e),i=$($.el.div({"class":"settings-input"},h));return $(e).keydown(function(a){a.keyCode===$.ui.keyCode.ENTER?c():a.keyCode===$.ui.keyCode.ESCAPE&&d()}),$(e).blur(function(){c()}),i},set:function(b,c){a.set(b),b=a.format(b),c.find("input").val(b),c.data("original-value",b)}}},text_input_vector:function(a){return a=_.extend({parse:function(a){return a.trim().split(/[, ]+/).filter(function(a){return!!a})},format:function(a){return a.join?a.join(", "):a}},a),this.text_input(a)},init:function(){var a=this;this.add({"show-command-prompt":a.checkbox({sort:1e3,default_value:!0,label:"Show Command Prompt",set:function(a){RCloud.UI.command_prompt.show_prompt(a)}}),"show-terse-dates":a.checkbox({sort:2e3,default_value:!0,needs_reload:!0,label:"Show Terse Version Dates",set:function(a){editor.set_terse_dates(a)}}),"show-cell-numbers":a.checkbox({sort:3e3,default_value:!0,label:"Show Cell Numbers",set:function(a){shell.notebook.controller.show_cell_numbers(a)}}),"panel-layout-by-size":a.checkbox({sort:4e3,default_value:!0,needs_reload:!0,label:"Arrange panels by size"}),"clear-r-session-when-run-all":a.checkbox({sort:5e3,default_value:!0,label:"Clear R Session when entire notebook is run",set:function(a){RCloud.UI.run_button.reset_on_run(a)}}),"export-only-selected-cells":a.checkbox({sort:6e3,default_value:!0,label:"Export only selected cells",set:function(a){RCloud.UI.import_export.export_only_selected_files(a)}}),addons:a.text_input_vector({sort:1e4,needs_reload:!0,label:"Enable Extensions"}),"skip-addons":a.text_input_vector({sort:11e3,needs_reload:!0,label:"Disable Extensions"}),"new-notebook-prefix":a.text_input({sort:12e3,label:"New Notebook Prefix",default_value:editor.new_notebook_prefix(),set:function(a){editor.new_notebook_prefix(a)},parse:function(a){return a.split("/").filter(function(a,b,c){return b==c.length-1||!Notebook.empty_for_github(a)}).join("/")}})})},add:function(a){_.extend(c,a)},remove:function(a){delete c[a]},load:function(){var b=[];_.keys(c).forEach(function(a){var f=c[a];d[a]=f.create_control(function(b){e[a]||rcloud.config.set_user_option(a,b)}),b.push({sort:f.sort,control:d[a]})}),b=b.sort(function(a,b){return a.sort-b.sort});for(var f=$("#settings-body"),g=0;g<b.length;++g)f.append(b[g].control);var h=_.keys(c);return 1===h.length&&h.push("foo"),rcloud.config.get_user_option(h).then(function(b){for(var d in b)if("foo"!==d&&"r_attributes"!==d&&"r_type"!==d){var e=null!==b[d]?b[d]:c[d].default_value;a(d,e)}})}};return f}(),RCloud.UI.share_button=function(){function a(a){a=a&&b.get(a)?a:c;var d=b.get(a);if(!a)return Promise.reject(new Error("share button view types set up wrong"));var e=d.page;$("#view-type li a").css("font-weight",function(){return $(this).text()===a?"bold":"normal"});var f={notebook:shell.gistname(),do_path:d.do_path,version:shell.version()};return f.version?rcloud.get_tag_by_version(shell.gistname(),f.version).then(function(a){a&&(f.tag=a),RCloud.UI.navbar.control("shareable_link").set_url(ui_utils.make_url(e,f))}):(RCloud.UI.navbar.control("shareable_link").set_url(ui_utils.make_url(e,f)),Promise.resolve(void 0))}var b,c=null;return{init:function(){return b=RCloud.extension.create({defaults:{create:function(){var b=this;return{title:b.key,handler:function(){rcloud.set_notebook_property(shell.gistname(),"view-type",b.key),a(b.key)}}}}}),this.add({"view.html":{sort:1e3,page:"view.html"},"notebook.R":{sort:2e3,page:"notebook.R",do_path:!0},"mini.html":{sort:3e3,page:"mini.html"},"shiny.html":{sort:4e3,page:"shiny.html"}}),this},add:function(a){return b&&b.add(a),this},remove:function(a){return b&&b.remove(command_name),this},load:function(){var a=b.create("all").array;return c=a.length?a[0].title:null,RCloud.UI.navbar.control("shareable_link").set_view_types(a),this},update_link:function(){return rcloud.get_notebook_property(shell.gistname(),"view-type").then(a)}}}(),RCloud.UI.upload_with_alerts=function(){function a(a){if(_.isBoolean(a))a={force:a};else if(!_.isObject(a))throw new Error("didn't understand options "+a);return a=$.extend({$file:$("#file"),$progress:$(".progress"),$progress_bar:$("#progress-bar"),$upload_results:$("#file-upload-results").length?$("#file-upload-results"):RCloud.UI.session_pane.error_dest(),$result_panel:$("#collapse-file-upload")},a)}function b(b,c){function d(a){c.$upload_results.append(a),c.$result_panel.trigger("size-changed"),c.$upload_results.length&&ui_utils.on_next_tick(function(){ui_utils.scroll_to_after(c.$upload_results)})}function e(a){var b=$("<div></div>");b.append(a);var c=bootstrap_utils.alert({"class":"alert-danger",html:b});return d(c),c}function f(a){d(bootstrap_utils.alert({"class":"alert-info",text:a,on_close:function(){c.$progress.hide(),c.$result_panel.trigger("size-changed")}}))}function g(a){return{add:function(a){f("Asset "+a+" added.")},replace:function(a){f("Asset "+a+" replaced.")}}}function h(a){return{start:function(b){a.$progress.show(),a.$progress_bar.css("width","0%"),a.$progress_bar.attr("aria-valuenow","0")},progress:function(b,c){a.$progress_bar.attr("aria-valuenow",~~(100*(b/c))),a.$progress_bar.css("width",100*(b/c)+"%")},done:function(a,b){f("File "+b+" "+(a?"replaced.":"uploaded."))},confirm_replace:Promise.promisify(function(a,b){var c=function(){g.remove(),b(null,!0)},d=$("<p>File "+a+" exists. </p>"),f=bootstrap_utils.button({"class":"btn-danger"}).click(c).text("Overwrite");d.append(f);var g=e(d);$("button.close",g).click(function(){b(new Error("Overwrite cancelled"),null)})})}}c=a(c||{}),c.$result_panel.length&&c.show_result!==!1&&c.$result_panel.parent().parent().data("collapsible-column").collapse(c.$result_panel,!1);var i=function(a){var b,c=a.message;throw"empty"===c?b=$("<p>File is empty.</p>"):"Overwrite cancelled"===c?b=$("<p>").append(c):"badname"===c?b=$("<p>Filename not allowed.</p>"):(b=$("<p>(unexpected) "+c+"</p>"),console.log(c,a.stack)),e(b),a},j=b?RCloud.upload_assets(c,g(c)):RCloud.upload_files(c,h(c));return j["catch"](function(a){return i(a,c)}).then(function(){c.$progress.length&&window.setTimeout(function(){c.$progress.hide()},5e3)})}return b}(),RCloud.UI.upload_frame={body:function(){return RCloud.UI.panel_loader.load_snippet("file-upload-snippet")},init:function(){$("#file").change(function(){$("#progress-bar").css("width","0%")}),$("#upload-submit").click(function(){if(0!==$("#file")[0].files.length){var a=$("#upload-to-notebook").is(":checked");RCloud.UI.upload_with_alerts(a)["catch"](function(){})}}),RCloud.session.listeners.push({on_reset:function(){$(".progress").hide(),$("#file-upload-results").empty()}})},panel_sizer:function(a){var b=RCloud.UI.collapsible_column.default_padder(a),c=24+$("#file-upload-controls").height()+$("#file-upload-results").height();return{height:c,padding:b}}},RCloud.UI.thumb_dialog=function(){function a(a){for(var b=a.split(","),c=b[0].match(/:(.*?);/)[1],d=atob(b[1]),e=d.length,f=new Uint8Array(e);e--;)f[e]=d.charCodeAt(e);return new Blob([f],{type:c})}var b=$("#thumb-dialog"),c=$("#thumb-drop-overlay"),d=c.find(".inner"),e=b.find(".modal-footer"),f=e.find(".btn-primary"),g=$("#thumb-remove"),h=$("#thumb-upload"),i=$("#selected-file"),j=$("#upload-success"),k=null,l="thumb.png",m={is_visible:function(){return b.is(":visible")},set_image:function(a){var b=c;return 0===b.find("img").length&&b.append($("<img/>")),b.find("img").attr({src:a}),b},reset:function(){c.removeClass("active dropped"),c.find("img").remove(),k=null,ui_utils.disable_bs_button(f),c.css("height",c.data("height")+"px")},verify:function(a){var b=1===a.length&&"image/png"===a[0].type;return b||d.effect("shake"),b},display_image:function(a){c.addClass("dropped"),this.set_image(a),j.show(),setTimeout(function(){j.animate({"margin-top":"0px",opacity:"0"},{duration:"fast",complete:function(){j.css({opacity:"1.0","margin-top":"35px"}).hide()}})},1500)},upload:function(a){k=a,ui_utils.enable_bs_button(f);var b=this,c=new FileReader;c.onload=function(a){b.display_image(a.target.result)},c.readAsDataURL(k)},setup_paste:function(){var a=this;$(document).on("paste",function(b){if(a.is_visible()){var c=(b.clipboardData||b.originalEvent.clipboardData).items,d=_.find(c,function(a){return"file"===a.kind});d&&a.verify([d])&&a.upload(d.getAsFile())}})},setup_asset_drop:function(){var a,b=this;$(document).on("dragstart dragenter dragover",function(d){if(b.is_visible()){var e=d.originalEvent.dataTransfer;e&&null!==e.types&&(e.types.indexOf?-1!=e.types.indexOf("Files")&&-1==e.types.indexOf("text/html"):e.types.contains("application/x-moz-file"))&&(shell.notebook.model.read_only()?(d.stopPropagation(),
d.preventDefault()):(d.stopPropagation(),d.preventDefault(),c.addClass("active"),a=!0))}}),$(document).on("drop dragleave",function(d){b.is_visible()&&(d.stopPropagation(),d.preventDefault(),a=!1,setTimeout(function(){a||c.removeClass("active")},100))}),c.bind({drop:function(a){a=a.originalEvent||a;var c=a.files||a.dataTransfer.files;b.verify(c)&&b.upload(c[0])},"dragenter dragover":function(a){var b=a.originalEvent.dataTransfer;shell.notebook.model.read_only()||(b.dropEffect="copy")}})},init:function(){var a=this;b.on("hidden.bs.modal",function(){a.reset()}),e.find(".btn-cancel").on("click",function(){b.modal("hide"),a.reset()}),ui_utils.disable_bs_button(f),f.on("click",function(){b.modal("hide"),k&&RCloud.UI.upload_with_alerts(!0,{files:[k],filenames:[l],show_result:!1})["catch"](function(){}),a.reset()}),g.click(function(){a.reset()}),h.click(function(){i.click()}),i.change(function(b){a.verify(b.target.files)&&(a.upload(b.target.files[0]),i.val(""))}),this.setup_asset_drop(),this.setup_paste()},show:function(){c.removeClass("active"),b.modal({keyboard:!0})}};return{init:function(){m.init()},show:function(){m.show()},is_visible:function(){return m.is_visible()},display_image:function(b){m.display_image(b),k=a(b),ui_utils.enable_bs_button(f)}}}(),RCloud.UI.notebook_protection_logger={timeout:0,log:function(a){$(".logging-panel").removeClass("red").removeClass("white").addClass("green"),$(".logging-panel span").text(a),window.clearTimeout(this.timeout),this.timeout=setTimeout(function(){$(".logging-panel").removeClass("red").removeClass("green").addClass("white"),$(".logging-panel span").html("&nbsp;")},2e4)},warn:function(a){$(".logging-panel").removeClass("green").removeClass("white").addClass("red"),$(".logging-panel span").text(a),window.clearTimeout(this.timeout),this.timeout=setTimeout(function(){$(".logging-panel").removeClass("red").removeClass("green").addClass("white"),$(".logging-panel span").html("&nbsp;")},2e4)},clear:function(){$(".logging-panel").removeClass("red").removeClass("green").addClass("white"),$(".logging-panel span").html("&nbsp;")}},RCloud.UI.notebook_protection=function(){return this.defaultCryptogroup=null,this.defaultNotebook=null,this.userId=null,this.userLogin=null,this.appScope=null,this.appInited=!1,{init:function(a){if(this.appInited)this.launch(a),$("#notebook-protection-dialog").modal({keyboard:!1});else{this.appInited=!0,this.buildDom();var b=this;require(["angular","./../../js/ui/notebook_protection_app","angular-selectize"],function(c,d,e){"use strict";c.element(document).ready(function(){_.delay(function(){c.bootstrap($("#protection-app")[0],["NotebookProtectionApp"]),c.resumeBootstrap()},100),_.delay(function(){b.appScope=c.element(document.getElementById("protection-app")).scope(),b.launch(a),$("#notebook-protection-dialog").modal({keyboard:!1})},200)})})}},launch:function(a){"both-tabs-enabled"===a?($("#protection-app #tab2").removeClass("active"),$("#protection-app #tab1").removeClass("disabled").addClass("active"),$("#protection-app #tab1 a").attr("href","#notebook-tab").attr("data-toggle","tab"),$("#protection-app #tab2 a").tab("show"),$("#protection-app #tab1 a").tab("show"),this.appScope.initBoth()):"group-tab-enabled"===a&&($("#protection-app #tab1").removeClass("active").addClass("disabled"),$("#protection-app #tab1 a").attr("href","#").removeAttr("data-toggle"),$("#protection-app #tab2 a").tab("show"),this.appScope.initGroups())},buildDom:function(){var a=$('<div class="container"></div>');a.append(RCloud.UI.panel_loader.load_snippet("notebook-protection-modal"));var b=$(['<div class="modal-header">','<button type="button" class="close" onClick="(RCloud.UI.notebook_protection.close.bind(RCloud.UI.notebook_protection))()" aria-hidden="true">&times;</button>',"<h3>Notebook Permissions / Group Management</h3>","</div>"].join("")),c=$('<div id="notebook-protection-dialog" class="modal fade"></div>').append($('<div class="modal-dialog"></div>').append($('<div class="modal-content"></div>').append(b).append(a)));$("body").append(c)},close:function(){this.appScope.cancel()}}}(),RCloud.UI.discovery_page=function(){var a,b=function(){function a(a){d.find("li").removeClass("active"),d.find('a[data-type="'+a+'"]').parent().addClass("active")}function b(){return d.find("a")}function c(){_.each(b(),function(a){$(a).attr("href","?metric="+$(a).attr("data-type"))})}var d=$("#metric-type"),e=["recently.modified","most.popular"],f=e[0],g=function(a,b){var c=[location.protocol,"//",location.host,location.pathname].join(""),d="?"+a+"="+b;window.history.pushState({path:c+d},"",c+d)},h=function(){var a=RCloud.utils.get_url_parameter("metric");return e.indexOf(a)>-1?a:f};return{init:function(d){c(),b().click(function(b){b.preventDefault();var c=$(this).attr("data-type");a(c),g("metric",c),_.isFunction(d.change)&&d.change(c)}),window.addEventListener("popstate",function(b){if(_.isFunction(d.change)){var c=h();a(c),d.change(c)}});var e=h();a(e),_.isFunction(d.oncomplete)&&d.oncomplete(e)}}},c={load_current_metric:function(b){var c,d="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAZAAAAGQCAMAAAC3Ycb+AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAURQTFRF6PH06fH0+fv8w9fd+vz94+3xxtne5O7xwNXbx9nf9fn64u3w5/Dzwtbc5u/yxdjeydvgz9/k4ezv1eTo9vr73+vu3Ons8vf4+vz84+7x6/P13entx9rf5vDy7/X32efr9vn6wdbb3ert8vf5zd7jzN3i8/j59Pj51uTo8Pb48fb4zt/k0ODlytzh9/r7w9fc1+Xp0+LnwdXb1OPn2+js4ezw4Ozv7vT2yNrg2ebq6PHz6vL0xNjdy9zh2Obq2OXq2ufr0+Lm7fT20uLm6vL17PT25vDzyNvg+Pr73urt5/Hz8/f57vX36fL0+fz8xtnf8ff4zN7i1uXp9Pj6xNfd3Ojs3uru+Pv77PP1+Pv84Ovv1OPo0uHm0eHlzt7jy93i8Pb30ODk6/L17PP21ePo5O7yydvh5O/y0eHm4+3wv9Ta5e/yk3jLJAAACxdJREFUeNrs3f1bFNcVwPGjKLvruu4CAlKwCAFFgfAiWrWAUNpQkzZGY22jpmn63nv//9+rxii7DLszc8/MnNn5nufJ88TnYYZzzsfx7p25c1emxROGQuQ8IoY43l4fiBjyOC/iEbHk4cUjYsnjPQgidjx+AkHEjMcHEESsePwMgogRj48giNjw+ASCiAmPEyCIWPA4CYKIAY8uEESK9+gGQaRwjx4QRIr26AVBpGCPUyCIFOtxGgSRQj0iQBAp0iMKBJECPSJBECnOIxoEkcI8zgBBpCiPs0AQKcjjTBBEivE4GwSRQjz6gCBShEc/EEQK8OgLgkj+Hv1BEMndYwAIInl7DAJBJGePgSCI5OsxGASRXD1igCCSp0ccEERy9IgFgkh+HvFAEMnNIyYIInl5xAVBJCeP2CCI5OMRHwSRXDwSgCCSh0cSEERy8EgEgkj2HslAEMncIyEIIll7JAVBJOt+iUfEkkdyEESy7ZV4RCx5pAFBJMs+iUfEkkc6EESy65F4RCx5pAVBJKv+iEfEkkd6EESy6Y14RCx5hIAgkkVfxCNiySMMBBH9nohHxJJHKAgi2v0Qj4glj3AQRHR7IR4RSx4aIIho9kE8IpY8dEAQ0euBeERMdUA8IqbqF4+IqerFI2KqdvGImKpcPCKm6haPiKmqxSNiqmbxiJiqWDwipuoVj4ipasUjYqpW8YiYqlQ8IqbqFI+IqSrFI2KqRvGImKpQPCKm6hOPiKnqxCNiqjbxiJiqTDwipuoSj4ipqsQjYqom8YiYqkg8IqbqEY+IqWrEI2KqFvGImKpEPCKm6hCPiKkqxCNiqgbxiJiqQDwipvIXj4ip7MUjYip38YiYylw8IqbyFo+Iqax5v9waPy0AhAAEEAIQQAhAACEAAYQAhBhqkCdjoy5VtJcXAVGP2poLiLuAKMfFOeeGSKT0ILVAD+dmAdGMv4Z6uAeAKMa8C48/AaIWMyMKIMuAqMWWgoer1wDRGtE3+ne68S7aA0UeA6IUryMZlv95MPuq+a/uH202m5OTs1Pzb+qnjxgDROkCiRpB5u4PnNf3HrILiE48jLob8p/Bx021eg66B4hKLEeAvIpz4GbPQQ8B0YhmxHAwEu/fup6j1gDRiJWIC+Tf8Q7tGXzmANGI9QiQmOPzgtmZSIlBavWoD73/i3Pofbt3T0oMshM5yYs1p5joPep7QMLjv9HT7jifmObSfRYApG90IjQ2Go2lycHzEMN3T4oEqc0vNV44ozHSWN5vVgtkZcMZj4WtWnVAmh1Xgng6XhWQi21Xiti4XxGQjitJjM5UAmTFlSa+rwJIbaQ8INv3KgCy70oUExUAWSoTyHoFQBplAmlVAGSkTCAOkPd/L8c2n48tRI6yP0zsrxw+yA/kIiDO7b2/jzQeMV1Z+nCHabYBSH4gox9uIp1eKvr802fnPUByA/n4isDDPssRaqMD1i0uHW4uLi5Ovv1vZ2Ws8wKQ1CCfPtj0PKcdmRnwXOPn6Bydfio7/vjZCCCpQEY//ehGv/sYZ1wijYkzn2TsLG0DEgTS/aM73ecZizp4wCPDmZUXgKiB9PT68PTAsRrjfvlmGxAlkJ63mN+cGjomY/3+2t1tQFRANrvP07O4dyP+UoXxPUA0QH7oHg66P4J1mkly2KwDEg7i5k+epvsN3KOESUy2AQkHaZ24CromjfWDxFnMdAAJBnHtj5P4iZMDcyvN6/+1Z4AEgzj34/ulOVPHXTP4yXSJjAESDuLcbqPR/VJa62XaTJ4BogByajYYsF3JHiD6IPMBqdQagGiDhL0heH8BEF2QucAV0fuAqIJsB6+HXgVEEyR8HdugLYUASQLyVCGdx4DogUxp5PMAEC2QPZV8pgDRAlHawbIDiA5IRymhHUB0QA60MhoFRANkQy2ju4BogOhtq3QPEA2QJ3oprQMSDqK5Q8kEIOEgmruJjgMSDrKvmdMuIMEgqi8sLwESCrKhmtNrQEJBOqo57QASCqK7Q/g4IKEgyl9WVAckEGRTN6kNQAJBDnSTagMSCDKlm9QDQAABBJAMQXZ0k5oDJBBE+Vs/GNRDQZ7rJtUCJBDkSDWnGjP1UJAl1ZwmAQkF0f1enHlAQkG2VXM6AiT4AdVLzZzWAQkGUb3dWwckGERzR90pFjmEgywopnQIiMJCuXm9lNqAKIDofTX9IktJNUDqTa2MfgRE5XUErW8uqLUAUQHRWt37mhd2lF5p01no0P8LZgBJANJWyec5L32qvRatMYoM2DkAkCQgLYUV12tsHKC4tcaz4GyesNeJ6m5AodP1gTtmAZIMpBW4HdDAfRcBSbiB2YOgXObZUU59i7+Q9xJeLgCiDuIOU2cyHuP8gCQGST0bae46QLIASSkyHmv7d0BSgKRaNTcZ7+SApAFxq4k3J51qOUCyA3GN+8mS2Ip7YkDSgbiFJMvhm+sOkIxBnNuLPWmfWHCAZA/i6luxRpLFRN+jC0h6EOdad2cG/fbZ9WSnBOTko/K6SxqtN/1G99r+cdITAuLcx7HgiUsTxyvN6F+8s9pKfjZATtwuXHYpo702/6r70pi9u76d6lSAfLoVcuSCorG8unq4srK6unrcTn8WQN5F52Dm4sGcsxCAGAtAAAEEkBKFH36Qp2XyaFUAZKlMIMcVAHlcJpCtCoDUWuXxqI9XACT+07riY81XAaQ2VxaP3WYlQHyzJJ98FyZ9NUD8vVJcI7t5exQH4mtbC+bH87WLvjogb//Zmlg3PENsd7buFdCUIkEIQAAhAAGEAAQQAhBACEAIQAAhAAGEAAQQAhBACEAIQAAhAAGEAAQQYqhBbn9+xWRPzl04V0mQ21evGP1bWqSI4GFLRPCwJVIUyJ2rtsfWwkQED1sigoctEcHDlkgRIHdulGOOVohIASDflMSjGBHBw5ZI7iDTJfIoQkTwsCWSM8j0Je8RsQNSPo/cRXIF+ayEHnmLCB62RAQPWyKChy0RwcOWSF4gX5XaI0cRwcOWSD4gN7/1HhE7IMPgkZdIHiA3b3mPiB2QYfHIR0TwsCWSOcitIfLIQ0TwsCWSMcitm94jYgdk+DwyF8kU5Nsh9MhaRPCwJZIhyKWvvEfEDsjwemQqkhnIpc+8R8QOyHB7ZCgieNgSETxsiQgetkSyALk07T0idkCq4pGNiOBhS0Qd5EaFPLIQETxsiSiD3PjGe0TsgFTPQ11EFeTGHe8RsQNytZIeyiKChy0RwcOWiBbIlau3vUfEDEjFPRRFBA9bIiogVz6vvIeaiOBhS0Q0PP6GhpqI4GFLRMI9fomEoojgYUtE8LAlEgZy5fd4KIsIHrZEQkCu46EvInjYEkkPcp3xPAsR4fqwJZIW5Pqf8chERNJ6/IGuZyIieNgSSQVy/Ts8shIRPGyJpAC5fv5XdDszEcHDlkhikC/wyFRE8LAlkhDki+/wyFZEuD5siQgetkSSgFw+/xv6m7WI4GFLRPCwJSJ42BIRPGyJCB62RCSmx+/oaT4igoctEcHDlojgYUtE8LAlIoM9/kEncxQRPGyJyCCPv9DFXEX6g1z+Go+cRQQPWyL9QC5f+wX9y1tE8LAlcjbIl3gUISJ42BI5C+TLr/EoRES4PmyJRIM8wqMoEcHDlkgUyCPGj+JEhOvDlojgYUvkFMijC3+nUwWKCB62RHpA5MJv6VKhIoKHLZEuELmGR9EiwvVhS0TwsCUiJzx+TW+KFxE8bInIx/EcDxMiwvVhS0TwsCUiP/0BDysigoctEXn3P3+kG2ZExJ+7hochEeH6sCUieJgSmf6/AAMAF4/8wMtS1yoAAAAASUVORK5CYII=";b=b||"recently.modified",$("body").addClass("loading");var e=!rcloud.username();return rcloud.discovery.get_notebooks(b).then(function(a){return c=a,RCloud.discovery_model.get_notebooks(e,Object.keys(c.values))}).then(function(b){var f=_.chain(c.values).pairs().filter(function(a){return"r_attributes"!=a[0]&&"r_type"!=a[0]&&!_.isEmpty(b[a[0]])});"date"===c.sort?f=f.map(function(a){return[a[0],Date.parse(a[1])]}).sortBy(function(a){return-1*a[1]}):"number"===c.sort&&(f=f.sortBy(function(a){return-1*a[1]}));var g=function(a){return a&&-1!=a.lastIndexOf("/")?{path:a.substring(0,a.lastIndexOf("/")),name:a.substring(a.lastIndexOf("/")+1)}:{path:void 0,name:a}};f=f.value(),f.length>100&&(f=f.slice(0,100));var h=f.map(function(a){var c=b[a[0]],f=g(c.description);return rcloud.discovery.get_thumb(a[0]).then(function(b){return{id:a[0],time:a[1],description:f.name,folder_path:f.path,last_commit:c.last_commit,last_commit_date:new Date(c.last_commit).toDateString(),page:e?"view.html":"edit.html",username:c.username,stars:c.stars,star_icon:!_.isUndefined(c.is_starred_by_me)&&c.is_starred_by_me?"icon-star":"icon-star-empty",forks:c.forks,image_src:b||d}})});return Promise.all(h).then(function(b){var c=_.template($("#item_template").html());$(".grid").html(c({notebooks:b})).imagesLoaded(function(){new a(".grid",{itemSelector:".grid-item",transitionDuration:0}),$(".body").hasClass("loaded")||$("body").addClass("loaded"),$("body").scrollTop(0).removeClass("loading")})})})},init:function(){return new Promise(function(d,e){require(["imagesloaded.pkgd.min","masonry.pkgd.min"],function(e,f){"use strict";a=f;var g=new b;g.init({change:function(a){c.load_current_metric(a)},oncomplete:function(a){d(c.load_current_metric(a))}})},e)})}};return c}();
//# sourceMappingURL=rcloud_bundle.min.js.map